# 前置补充：域

## 1. 域的简单介绍

**1.1 内网环境**

1）工作组：默认模式，人人平等，不方便管理

2）域：人人平等，集中管理，统一管理

**1.2 域的组成**

+ 域控制器（Domain Controller）
+ 成员机

**1.3 域的部署**



# 第一章 内网安全基础知识

## 1-1 什么秘密是内网和外网

内网和外网有多种分类方法，内网可叫局域网，外网可叫广域网。也可以以私有IP和公有IP做划分

## 1-2 安全域划分

安全域划分的目的是：将拥有相同安全等级的计算机啊划分到同一网络内，拥有相同的网络边界，在边界上使用防火墙等安全设备部署网络策略（ACL）

### 安全域划分

通常防火墙会划分处5个区域

+ `untrust`不信任域：通常是外网（0）
+ `DMZ`隔离区域：通常是允许外部网络访问的服务器放在该区域（50）
+ `trust`信任区域：通常是内网（85）
+ `local`本地区域：防火墙本身（100）
+ `mmanageent`管理区域：管理防火墙的区域（100）

## 1-3 ATT&CK 框架

> 官网学习：https://attack.mitre.org/matrices/enterprise/
>
> 陈鑫杰B站：https://www.bilibili.com/video/BV1EV41117UJ/?spm_id_from=333.337.search-card.all.click&vd_source=05abd235c4d932713bb7910dfa6ba067

## 1-4  什么是工作组

优先：在同一个局域网内，所有的计算机都被列在**网上邻居**中，但随着局域网的规模扩大，就需要以分组的形式来对计算机做划分，以便用户更好的访问到目标计算机。计算机通过工作组进行分类，使我们访问的资源结构化更强。工作组情况下资源可以一定随机和灵活的分布，更方便资源共享，管理员只需要实施简单的维护。

缺点：缺乏集中管理与控制的机制，没有集中的统一帐户管理，没有对资源实施更加高效率的集中管理，没有实施工作站的有效配置和安全性严密控制。只适合小规模用户的使用。

## 1-4 域

### 域环境基础概念

+ 组织单元OU：组织单元（Organizational Unit，OU）是一个**容器**，管理员可以将有着相似属性的单位放到一个组织单元中，如：用户，计算机，工作组，打印机。并为其设置安全策略
+ 安全标识符SID：用于**标识安全主体的唯一值**，安全主体可以是：用户账户、计算机账户等。系统可以通过SID来判断主体的权限情况（s-1-5-21-D1-D2-D3-RID）
+  域是一个有安全边界的集合，同一个域中的计算机彼此之间建立信任关系，计算机之间允许互相访问。
+ 单域环境中只使用一个DNS名字空间，例如book.com。域中的所有计算机账户和用户账户都是用同一个域后缀（DNS名称后缀）。

## 1-5 活动目录 AD

获得目录存储的是网络中所有资源的快捷方式，用户通过快捷方式来定位相应的资源；在一个域中，所有目录共享一个获得目录

获得目录特点：

1. 集中管理：管理员可以集中管理网络
2. 便携的网络资源访问：活动目录允许用户一次登录网络，就可以访问所有用户有权限访问的资源。并且不需要知道资源存储的物理位置
3. 可扩展性：目录可以随组织规模的扩展而扩展

## 1-6 DC于GC

DC 域控制器：在域中拥有最高权限，可用于管理整个域中的所有计算机

GC 全局编录：包含森林中所有对象信息的特殊目录数据库。全局编录是存储林中所有 Active Directory 对象的副本的域控制器。全局编录存储林中主持域的目录中所有对象的完全副本，以及林中所有其他域中所有对象的部分副本。全局编录中包含的所有域对象的部分副本是用户搜索操作中最常使用的部分。作为其架构定义的一部分，这些属性被标记为包含到全局编录中。在全局编录中存储所有域对象的最常搜索的属性，可以为用户提供高效的搜索，而不会以不必要的域控制器参考影响网络性能。在林中的初始域控制器上，会自动创建全局编录。可以向其他域控制器添加全局编录功能，或者将全局编录的默认位置更改到另一个域控制器上。



## 1-7 域、域树、域林 、林根介绍

域、域树、域林都是活动目录 (Active Directory)的逻辑单元。

- 域：域是一种管理单元，也是一个管理边界，在同一个域内共享某些功能和参数。一个域可以有多台域控制器。
- 域树：共用一个连续的域名的windows域，比如：zpchcbd.com，a.zpchcbd.com，b.zpchcbd.com 这三个在同一个 域树 上，同时zpchcbd.com则被称为 树的根域 ，然后a.zpchcbd.com , b.zpchcbd.com 则被成为 子域 。
- 域林：域林是一个或多个不连续DNS名的域 (树)的集合。
- 林跟：在林中创建的第一个域控为林根，也可以叫做根域
- ![img](%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/%E5%9B%BE%E7%89%87140.png)

## 1-8 DNS在域中的重要性

在实际业务中，域控制器和DNS服务器都会配置在同一台计算机上，所以在实际的渗透测试中，我们可以通过寻找DNS服务器来定位域控制器

DNS 在Windows域环境中的重要性介绍

1. 名称解析：DNS用于将计算机名转换为IP地址，以便在网络上定位和访问其他计算机。在Windows域环境中，DNS是用于名称解析的主要机制，它可以帮助客户端找到域内其他计算机的IP地址，从而进行通信和数据交换。

2. 域控制器发现：在Windows域环境中，域控制器是管理域中用户、计算机和资源的核心组件。客户端需要知道域控制器的名称和IP地址才能登录到域中，DNS提供了这些信息。域控制器在安装时会将自己的DNS信息注册到DNS服务器上，客户端可以通过DNS查询找到域控制器的信息。

3. 动态更新：在Windows域环境中，DNS还支持动态DNS更新。当新计算机加入域时，它会将自己的DNS信息注册到DNS服务器上，以便其他计算机可以找到它。同样地，当计算机离开域时，它会将自己的DNS信息从DNS服务器上删除。这样可以保持DNS信息的最新状态，从而减少错误和故障。

4. Active Directory集成：在Windows域环境中，DNS与Active Directory密切集成。域控制器和其他Windows服务器使用DNS来定位Active Directory中的服务和资源。例如，在域中查找用户、组和计算机时，Active Directory使用DNS来查找它们的位置。

   

## 1-9 域功能基础概念

- 功能级别：功能级别定义了域或林中可以使用的高级功能。不同版本的Windows Server支持不同的功能级别。提高功能级别可以启用新功能，但会限制可以加入域或林的域控制器的操作系统版本。**高功能级别普遍可以低兼容低安全级别，但是低安全级别无法兼容高功能级别**

- 信任关系：信任关系是在两个域或林之间建立的，允许一个域中的用户使用另一个域中的资源。信任关系可以是单向的或双向的，并且可以是显式创建的或隐式创建的（例如父子域之间的信任关系）。

- 全局编录服务器：全局编录服务器是存储林中所有Active Directory对象副本的域控制器。它包含了林中所有对象信息的特殊目录数据库。全局编录存储林中主持域的目录中所有对象的完全副本，以及林中所有其他域中所有对象的部分副本。

- 只读域控制器：只读域控制器（RODC）是一种特殊类型的域控制器，它存储Active Directory数据库的只读副本。RODC通常用于安全性较低或物理安全性无法保证的位置，因为它不存储用户凭据，因此即使被攻击也不会泄露敏感信息。

  
  
  

## 1-10 **FSMO角色功能**

+ 架构主机：控制活动目录整个林中所有对象和属性的定义，具有架构主机角色的DC是可以更新目录架构的唯一DC。这些架构更新会从架构主机复制到目录林中的所有其它域控制器中。 架构主机是基于目录林的，整个目录林中只有一个架构主机。

+ 域命令主机：向目录林中添加新域。从目录林中删除现有的域。添加或删除描述外部目录的交叉引用对象。

+ PDC模拟器：向后兼容低级客户端和服务器，担任NT系统中PDC角色时间同步服务源，作为本域权威时间服务器，为本域中其它DC以及客户机提供时间同步服务，林中根域的PDC模拟器又为其它域PDC模拟器提供时间同步!密码最终验证服务器，当一用户在本地DC登录，而本地DC验证本地用户输入密码无效时，本地DC会查询PDC模拟器，询问密码是否正确。

+ 主机角色：RID主机：分配SID，SID由域SID+序列号组合而成，后者称为“相对ID”(Relative ID,RID),在Win2003环境中，为保证整个域中每个DC所创建的安全主体对应的SID在整个域范围唯一性，设立该主机角色，负责向其它DC分配RID池(默认一次性分配512个)，所有非RID在创建安全实体时，都从分配给的RID池中分配RID，以保证SID不会发生冲突!

+ 基础架构主机：基础结构主机的作用是负责对跨域对象引用进行更新，以确保所有域间操作对象的一致性。基础架构主机工作机制是定期会对没有保存在本机的引用对象信息，而对于GC来说，会保存当前林中所有对象信息。

  

## 1-11 操作主机故障影响

操作主机在Active Directory环境中，肩负着重要的作用，如果操作主机出现问题，将会出现以下问题：

当架构主机不可用时，不能对架构进行更改。在大多数网络环境中，对架构更改的频率很低，并且应提前进行规划，以便使架构主机的故障不至于产生任何直接的问题。

当域命名主机不可用时，不能通过运行DCPROMO向Active Directory中添加域，同时也不能从目录林中删除域，如果在域命名主机不可用时试图通过运行DCPROMO来删除域，那么就会收到一条"RPC 服务器不可用"的消息。

当RID主机不可用时，所遇到的主要问题是不能向域中添加任何新的安全对象，例如用户、组和计算机；如果试图添加，则会出现如下的错误消息："Windows 不能创建对象，因为：目录服务已经用完了相对标识号池"。

当PDC主机不可用时，在本机模式环境中用户登录失败的可能性增大。如果重新设置用户密码，例如用户忘记密码，然后管理员在一台DC（不是验证DC）上重新设置密码，那么该用户就必须等到密码复制到验证DC之后才能登录。试图编辑组策略对象时出错。

当基础架构主机不可用时，结构主机故障对环境的影响是有限的。最终用户并不能感觉到它的影响，只对管理员执行大量组操作产生影响。这些组操作通常是添加用户和/或重新命名用户。在此情况下，结构主机故障只是会延迟通过Active Directory管理单元引用这些更改的时间。



## 1-12 只读域控制服务器

只读域控制器（RODC）是Windows Server 2008 AD DS域服务之后提供的新域控制器类型，只读域控制器同样是域控制器，但是Active Directory数据具备“只读”属性，只能读取不能写入。只读域控制器主要用在企业分支机构

管理员不能直接对 RODC 进行更改，要修改数据，必须先修改域控制服务器，再将数据复制到只读域控制服务器中



### RODC 优点

1. 只读的 Active Directory 数据库

2. 单向复制：数据只能从 DC 复制到 RODC

3. 密码缓存

4. 只读DNS

5. RODC管理：RODC允许一个普通的域用户称为RODC管理员

6. GC支持：RODC可以做GC（全局编录）服务器，但是RODC不能安装操作主控角色。

   

### RODC 缺点

对可读写的域控制器有很明显的依赖性！如果域控制器出错，那么RODC基本也会跟着出错



## 1-13 活动目录数据库

Active Directory数据库是一个事务处理数据库系统，通过日志文件支持**回滚操作**，从而确保事务提交到数据库中，与Active Directory 关联的文件包括：

1. Ntfs.dit，Active Directory数据库文件：对数据进行任何更改都会首先写道当前日志文件中，然后入Active Directory 数据库文件；日志大小是固定10MB

2. Edgxxx.log，事务日志文件：对数据库进行操作后，会将操作写入Edb.log文件中，当Edb.log文件充满事务之后，被重新命名为Edbxxxxx.log。（从00001开始，并使用十六进制累加）

3. Res1.log和Res2.log，预留的日志文件，确保在此驱动器上预留最后的20MB磁盘空间，以确保日志文件有足够的空间写入

4. Edb.chk，检查点文件：Edb.chk是数据库检查点文件，检查点是标识数据库引擎需要重复播放日志的点，通常在恢复或初始化时验证数据库的一致性

5. Temp.edb，临时数据库维护文件：数据库维护时使用的临时文件，用于存储当前进程中处理的信息。

6. Edbtmp.log，日志暂存文件：当前日志文件（Edb.log）填满时的暂时日志填充文件

   附：默认状态下，活动目录数据库文件位于“C:\Windows\NTDS”目录中。

# 第二章：域环境搭建

### 编辑虚拟网络编辑器

按下面图示添加网络和更改IP地址，之后正常开机即可，如果win-2016无法上网，重启一下就好

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20230517150428199.png" alt="image-20230517150428199" style="zoom:50%;" />

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20230517150440731.png" alt="image-20230517150440731" style="zoom:50%;" />

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20230517150450361.png" alt="image-20230517150450361" style="zoom:50%;" />

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20230517150457255.png" alt="image-20230517150457255" style="zoom:50%;" />

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/image-20230517150505065.png" alt="image-20230517150505065" style="zoom:50%;" />

# 第三章：权限提示技术

<img src="%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95v2-%E5%85%A8%E6%A0%88%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6%E7%8F%AD.assets/03-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87.png" alt="03-权限提升" style="zoom:50%;" />

## Linux 内核切换于CVE-2021-3493

### ubantu内核切换 操作主机：Ubantu 2004

```bash
# 查看当前内核版本
lonelyor@ubuntusrv2004:~$ uname -r
4.4.0-21-generic

# 查看已安装内核版本
lonelyor@ubuntusrv2004:~$ dpkg --get-selections | grep linux-image
linux-image-4.15.0-91-generic                   install
linux-image-4.4.0-21-generic                    install
linux-image-5.4.0-105-generic                   install
linux-image-unsigned-4.18.0-041800-generic      install

# 查看当前可安装的内核版本
lonelyor@ubuntusrv2004:~$ apt-cache search linux | grep linux-image
linux-image-4.4.0-21-generic - Linux kernel image for version 4.4.0 on 64 bit x86 SMP
linux-image-4.4.0-21-lowlatency - Linux kernel image for version 4.4.0 on 64 bit x86 SMP
linux-image-extra-4.4.0-21-generic - Linux kernel extra modules for version 4.4.0 on 64 bit x86 SMP
.......

# 安装需要的内核版本
lonelyor@ubuntusrv2004:~$ apt-cache search linux | grep linux-image linux-image-4.4.0-21-generic

# 查看内核启动顺序
lonelyor@ubuntusrv2004:~$ cat /boot/grub/grub.cfg | grep menuentry
if [ x"${feature_menuentry_id}" = xy ]; then
  menuentry_id_option="--id"
  menuentry_id_option=""
export menuentry_id_option
menuentry 'Ubuntu' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-simple-4418d962-00a0-48ed-baf2-c968984c67b7' {
submenu 'Advanced options for Ubuntu' $menuentry_id_option 'gnulinux-advanced-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 5.4.0-105-generic' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-5.4.0-105-generic-advanced-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 5.4.0-105-generic (recovery mode)' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-5.4.0-105-generic-recovery-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 4.18.0-041800-generic' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.18.0-041800-generic-advanced-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 4.18.0-041800-generic (recovery mode)' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.18.0-041800-generic-recovery-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 4.15.0-91-generic' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.15.0-91-generic-advanced-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 4.15.0-91-generic (recovery mode)' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.15.0-91-generic-recovery-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 4.4.0-21-generic' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.4.0-21-generic-advanced-4418d962-00a0-48ed-baf2-c968984c67b7' {
        menuentry 'Ubuntu, with Linux 4.4.0-21-generic (recovery mode)' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.4.0-21-generic-recovery-4418d962-00a0-48ed-baf2-c968984c67b7' {

# 修改内核启动顺序
lonelyor@ubuntusrv2004:~$ nano /etc/default/grub
#GRUB_DEFAULT="Advanced options for Ubuntu>Ubuntu, with Linux 5.4.0-105-generic"
#GRUB_DEFAULT="Advanced options for Ubuntu>Ubuntu, with Linux 4.4.0-21-generic"
GRUB_DEFAULT="Advanced options for Ubuntu>Ubuntu, with Linux 4.15.0-91-generic"

# 更新启动项
lonelyor@ubuntusrv2004:~$ update-grub

# 重启服务器
lonelyor@ubuntusrv2004:~$ sudo reboot
```

###  CVE-2021-3493 提权

[CVE-2021-3493 是一个 Ubuntu 特定的问题，它在 Ubuntu 中没有正确验证关于用户名称空间的文件系统功能的应用程序。由于 Ubuntu 带有一个支持非特权的 overlayfs 挂载的补丁，因此本地攻击者可以使用它来进行提权操作

受影响的版本包括：

- Ubuntu 20.10
- Ubuntu 20.04 LTS
- Ubuntu 18.04 LTS
- Ubuntu 16.04 LTS
- [Ubuntu 14.04 ESM

```bash
# EXP代码已经在 ubantu2004 home 目录下
lonelyor@ubuntusrv2004:~$ ls
CVE-2016-5195  CVE-2019-14287  CVE-2021-3156  CVE-2021-3493  CVE-2021-4034  linux-image  tmp

# 进入相应的文件夹
lonelyor@ubuntusrv2004:~$ cd  CVE-2021-3493
lonelyor@ubuntusrv2004:~/CVE-2021-3493$ ls
exploit  exploit.c  ovlcap  README.md

# 对EXP代码进行预编译
lonelyor@ubuntusrv2004:~/CVE-2021-3493$ gcc exploit.c

# 运行EXP代码
lonelyor@ubuntusrv2004:~/CVE-2021-3493$ ./exploit

# 提权成功！升级为root用户
bash-5.0# id
uid=0(root) gid=0(root) groups=0(root),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lxd),1000(lonelyor)

```

