# Linux

## 开机启动项

在 Linux 系统中，`/etc/rc.d` 目录包含了用于控制系统启动和关闭过程的脚本。这些脚本通常用于启动和停止系统服务。

`/etc/rc.d` 目录下通常包含以下子目录：

- `init.d`: 存放各种服务器和程序的启动脚本。
- `rc0.d` 到 `rc6.d`: 这些目录包含了用于不同运行级别的脚本。这些脚本通常是指向 `init.d` 目录下相应脚本的符号链接。

此外，`/etc/rc.d` 目录下还包含一些重要的脚本，例如 `rc.sysinit`，它是由 init 程序执行的第一个脚本，用于在各个运行级别中执行相同的初始化工作。还有 `rc.local` 脚本，它是在其他初始化工作之后、登录之前执行的最后一个脚本，用户可以在其中添加一些自定义命令。

```bash
# /etc/rc.d 目录
[root@localhost rc.d]# ls
init.d  rc0.d  rc1.d  rc2.d  rc3.d  rc4.d  rc5.d  rc6.d  rc.local

# 存放各种服务器和程序的启动脚本
[root@localhost rc.d]# ls init.d/
functions  README
```

`/etc/rc.local`查看用户配置的自启动脚本

```bash
[root@localhost rc.d]# cat /etc/rc.local
#!/bin/bash
# THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES
#
# It is highly advisable to create own systemd services or udev rules
# to run scripts during boot instead of using this file.
#
# In contrast to previous versions due to parallel execution during boot
# this script will NOT be run after all other services.
#
# Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure
# that this script will be executed during boot.

touch /var/lock/subsys/local
```

## 服务项

` systemctl list-unit-files`查看当前所有服务运行情况

```bash
# 查看已启动服务
[root@localhost rc.d]# systemctl list-unit-files |grep enabled
cups.path                                   enabled
accounts-daemon.service                     enabled
atd.service                                 enabled
auditd.service                              enabled
autovt@.service                             enabled
avahi-daemon.service                        enabled
bluetooth.service                           enabled
```

## 环境变量

Linux 环境变量配置文件：

+ `/etc/profile`
+ `/etc/bashrc`
+ `/etc/bash.bashrc`
+ `~/.bashrc`
+ `~/.profile`
+ `/.bash_profile`

这些文件会再用户每次登录登出和切换的时候触发，从而执行里面的木马程序

一般会存储在`/etc`或者是`~`中，关键字是`profile`或者是`bashrc`

<img src="%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94.assets/image-20230615212935314.png" alt="image-20230615212935314" style="zoom: 50%;" />

## 排除各项资源异常

### `ps`查看进程

`ps -efcaux` 命令是一个组合了多个选项的 `ps` 命令。下面是对这些选项的解释：

- `-e`: 显示所有进程。
- `-f`: 显示完整格式的输出。
- `-c`: 显示进程的调度类。
- `-a`: 显示除会话领导和无终端的进程外的所有进程。
- `-u`: 显示每个进程的用户占用 CPU 时间和内存使用情况。
- `-x`: 显示无控制终端的进程。

这些选项组合在一起，可以显示系统中所有进程的详细信息，包括进程所有者、进程 ID、父进程 ID、CPU 利用率、启动时间、终端、占用 CPU 时间、命令名等。此外，还会显示每个用户占用的 CPU 时间和内存使用情况。

```bash
[root@localhost ~]# ps -efcaux |more
USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root          2  0.0  0.0      0     0 ?        S    09:17   0:00 kthreadd
root          3  0.0  0.0      0     0 ?        I<   09:17   0:00  \_ rcu_gp
root          4  0.0  0.0      0     0 ?        I<   09:17   0:00  \_ rcu_par_gp
root          6  0.0  0.0      0     0 ?        I<   09:17   0:00  \_ kworker/0:0H-xfs-log/dm-0
root          8  0.0  0.0      0     0 ?        I<   09:17   0:00  \_ mm_percpu_wq
```



### 查看进程位置

`lsof` -p 指定PID查看进程信息

```bash
[root@localhost ~]# lsof -p 7652
COMMAND  PID    USER   FD      TYPE             DEVICE SIZE/OFF     NODE NAME
geoclue 7652 geoclue  cwd       DIR              253,0      236      128 /
geoclue 7652 geoclue  rtd       DIR              253,0      236      128 /
geoclue 7652 geoclue  txt       REG              253,0   314224 17241707 /usr/libexec/geoclue	# 一般在第三条可以看到进程的绝对路径
```

也可以通过查找`/proc`目录来寻找进行的执行路径；`/proc/PID/`

```bash
[root@localhost ~]# ls -al /proc/7652/exe
lrwxrwxrwx. 1 geoclue geoclue 0 6月  15 09:06 /proc/7652/exe -> /usr/libexec/geoclue
[root@localhost 7652]# ls -al /proc/7652/cwd
lrwxrwxrwx. 1 geoclue geoclue 0 6月  15 10:00 /proc/7652/cwd -> /
[root@localhost 7652]# ls -al /proc/7652/cmdline
-r--r--r--. 1 geoclue geoclue 0 6月  15 09:06 /proc/7652/cmdline
[root@localhost 7652]# ls -al /proc/7652/environ
-r--------. 1 geoclue geoclue 0 6月  15 10:04 /proc/7652/environ
```

| 文件    | 作用                                           |
| ------- | ---------------------------------------------- |
| cwd     | 符号链接（类似快捷方式）的是进程运行目录       |
| exe     | 符号链接（类似快捷方式）的是执行程序的绝对路径 |
| cmdline | 符号链接（类似快捷方式）的是进程运行目录       |
| environ | 记录进程运行时系统的环境变量                   |

### 查看资源利用率

`top`命令查看当前计算机资源的使用情况，类似于Windows的任务管理器

```bash
[root@localhost 7652]# top
top - 10:14:53 up 57 min,  2 users,  load average: 0.00, 0.00, 0.00
Tasks: 335 total,   1 running, 334 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.5 us,  0.7 sy,  0.0 ni, 97.8 id,  0.0 wa,  0.7 hi,  0.3 si,  0.0 st
MiB Mem :   1806.1 total,     79.3 free,   1292.5 used,    434.3 buff/cache
MiB Swap:   2048.0 total,   2033.2 free,     14.8 used.    346.1 avail Mem

   PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
  7954 root      20   0  550056  37000  30480 S   0.7   2.0   0:11.40 vmtoolsd
  9184 root      20   0       0      0      0 I   0.7   0.0   0:00.17 kworker/0:2-events_power_efficient
```

假设现在怀疑`vmtoolsd`是一个恶意程序，想要寻找他的绝对路径，可以这样做：

```bash
[root@localhost 7652]# ls -al /proc/7954/exe
lrwxrwxrwx. 1 root root 0 6月  15 09:06 /proc/7954/exe -> /usr/bin/vmtoolsd
```

### 网络资源排查

`netstat`命令：

+ `-a`：显示所有
+ `-n`：数字形式显示连接端口
+ `-t`：仅查看TCP连接情况
+ `-u`：仅查看UDP连接情况
+ `-p`：查看相关程序名和PID

```bash
[root@localhost 7652]# netstat -anutp
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 192.168.122.1:53        0.0.0.0:*               LISTEN      2050/dnsmasq
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1039/sshd
tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      1034/cupsd
tcp        0      0 127.0.0.1:6010          0.0.0.0:*               LISTEN      8094/sshd: root@pts
tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      1/systemd
tcp        0      0 192.168.231.132:22      192.168.231.1:51228     ESTABLISHED 8088/sshd: root [pr
tcp        0      0 192.168.231.132:22      192.168.231.1:51231     ESTABLISHED 8092/sshd: root [pr
tcp6       0      0 :::21                   :::*                    LISTEN      8375/vsftpd
tcp6       0      0 :::22                   :::*                    LISTEN      1039/sshd
tcp6       0      0 ::1:631                 :::*                    LISTEN      1034/cupsd
tcp6       0      0 ::1:6010                :::*                    LISTEN      8094/sshd: root@pts
tcp6       0      0 :::111                  :::*                    LISTEN      1/systemd
udp        0      0 192.168.122.1:53        0.0.0.0:*                           2050/dnsmasq
udp        0      0 0.0.0.0:67              0.0.0.0:*                           2050/dnsmasq
udp        0      0 192.168.231.132:68      0.0.0.0:*                           1017/NetworkManager
udp        0      0 0.0.0.0:111             0.0.0.0:*                           1/systemd
udp        0      0 0.0.0.0:5353            0.0.0.0:*                           936/avahi-daemon: r
udp        0      0 127.0.0.1:323           0.0.0.0:*                           920/chronyd
udp        0      0 0.0.0.0:56989           0.0.0.0:*                           936/avahi-daemon: r
udp6       0      0 :::111                  :::*                                1/systemd
udp6       0      0 :::5353                 :::*                                936/avahi-daemon: r
udp6       0      0 ::1:323                 :::*                                920/chronyd
udp6       0      0 :::59049                :::*                                936/avahi-daemon: r
```

| 状态        | 作用                            |
| ----------- | ------------------------------- |
| LISTEN      | 监听TCP端口，等待远程连接       |
| TIME-WAIT   | 等待一段时间确保远程TCP中断连接 |
| ESTABLISHED | 打开着的连接                    |
| SYN_RECV    | 等待远程TCP对连接中断的确认     |
| CLOSE       | 连接完全关闭                    |

### 关闭进行

```bash
kill -9 PID
```

## 定时任务

**`crontab`**

定时任务创建后保存路径：

+ `/etc/spool/cron/`目录里的任务以用户名命名
+ `/etc/crontab`调度管理维护任务
+ `/etc/cron.d`这个目录用来存放任何要执行的crontab文件或脚本
+ 重点检查对象：
  + `/etc/cron.hourly`每小时执行一次
  + `/etc/cron.daly`每天执行一次
  + `/etc/cron.weekly`每周执行一次
  + `/etc/cron.monthly`每月执行一次

这写文件基本都放在`/etc`下，关键字是`cron`

```
[root@localhost ~]# cat /etc/cr
cron.d/          cron.deny        cron.monthly/    cron.weekly/     crypttab
cron.daily/      cron.hourly/     crontab          crypto-policies/
```

## 系统日志

日志文件是记录l系统运行信息的文件，Linux系统内记载很多不同类型的日志，例如：

- Linux内核消息
- 登入事件
- 程序错误日志
- 软件安装信息

以上日志内记录系统内一些关键的信息，通过这些日志内记录的信息，可以帮助安全人员寻找到攻击者蛛丝马迹。作者整理了以下常见日志信息：

`/var/log/dmesg` 内核的一些信息。

`/var/log/auth.log` 此文件中包含系统授权信息，以及用户登录和使用的身份验证机制。

`/var/log/boot.log` 包含系统启动时记录的信息

`/var/log/daemon.log` 正在运行的各种系统后台守护程序将信息记录到此文件中。

`/var/log/kern.log` 包含内核记录的信息。有助于解决定制内核的故障。

`/var/log/lastlog` 显示所有用户的最近登录信息。这不是`ascii`文件。管理员可以使用`lastlog`命令查看此文件的内容。

`/var/log/maillog`和`/var/log/mail.log` 记录系统上运行的邮件服务器的信息。例如，`sendmail`将有关所有已发送项目的信息记录到此文件中。

`/var/log/user.log` 包含有关所有用户级日志的信息。

`/var/log/Xorg.x.log` 将来自x服务器的消息记录到此文件。

`/var/log/btmp` 此文件包含有关失败登录尝试的信息。使用最后一个命令查看btmp文件。例如，last-f/var/log/btmp|more。

`/var/log/yum.log` 包含使用yum安装包时记录的信息。在删除具有依赖项的包时，可以引用此文件。

`/var/log/cron` 每当cron守护程序（或anacron）启动cron作业时，它都会将有关cron作业的信息记录在该文件中

`/var/log/secure` 包含与身份验证和授权权限相关的信息。例如，sshd在这里记录所有消息，包括登录失败。

`/var/log/wtmp-wtmp` 文件记录所有登录和注销。

`/var/log/utmp-utmp` 文件允许您发现有关当前使用系统的用户的信息。

`/var/log/faillog` 包含失败的用户登录尝试。使用faillog命令显示此文件的内容。

`/var/log/httpd/` 包含apacheweb服务器access_log和error_log以及相关的虚拟主机日志（如果设置为在此处记录）。

`/var/log/apache2` 包含apache web服务器access_log和error_log以及相关的虚拟主机日志（如果设置为在此处记录）。

`/var/log/conman/-conman` 客户端的日志文件。conman连接由conmand守护进程管理的远程控制台。

`/var/log/mail/` 此子目录包含来自邮件服务器的其他日志。例如，sendmail将收集的邮件统计信息存储在/var/log/mail/statistics文件中

`/var/log/audit/` 包含由Linux审核守护程序（auditd）存储的日志信息。

`/var/log/settroubleshoot/` SELinux使用settroublishootd（SE TroubleshootDaemon）来通知文件安全上下文中的问题，并将这些信息记录在此日志文件中。

`/var/log/samba/` 包含samba存储的日志信息，用于将Windows连接到Linux。

`/var/log/sa/` 包含sysstat包收集的每日sar文件。



